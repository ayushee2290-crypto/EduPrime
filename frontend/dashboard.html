<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPrime - Institute Management Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --info-color: #36b9cc;
            --sidebar-width: 250px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fc;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: linear-gradient(180deg, #4e73df 10%, #224abe 100%);
            color: white;
            z-index: 1000;
            transition: all 0.3s;
        }
        
        .sidebar-brand {
            padding: 1.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .sidebar-brand h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .sidebar-menu {
            padding: 1rem 0;
        }
        
        .menu-item {
            padding: 0.8rem 1.5rem;
            display: flex;
            align-items: center;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .menu-item:hover, .menu-item.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .menu-item i {
            margin-right: 10px;
            font-size: 1.1rem;
        }
        
        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 20px;
        }
        
        /* Top Navigation */
        .top-nav {
            background: white;
            padding: 1rem 1.5rem;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-box {
            display: flex;
            align-items: center;
            background: #f8f9fc;
            border-radius: 25px;
            padding: 0.5rem 1rem;
        }
        
        .search-box input {
            border: none;
            background: transparent;
            outline: none;
            padding: 0.5rem;
            min-width: 300px;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .notification-badge {
            position: relative;
        }
        
        .notification-badge .badge {
            position: absolute;
            top: -5px;
            right: -5px;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            border-left: 4px solid;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card.students { border-color: var(--primary-color); }
        .stat-card.revenue { border-color: var(--success-color); }
        .stat-card.attendance { border-color: var(--info-color); }
        .stat-card.pending { border-color: var(--warning-color); }
        .stat-card.inquiries { border-color: var(--danger-color); }
        .stat-card.exams { border-color: #6f42c1; }
        
        .stat-card .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .stat-card.students .stat-icon { background: rgba(78,115,223,0.1); color: var(--primary-color); }
        .stat-card.revenue .stat-icon { background: rgba(28,200,138,0.1); color: var(--success-color); }
        .stat-card.attendance .stat-icon { background: rgba(54,185,204,0.1); color: var(--info-color); }
        .stat-card.pending .stat-icon { background: rgba(246,194,62,0.1); color: var(--warning-color); }
        
        .stat-card h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3748;
        }
        
        .stat-card p {
            color: var(--secondary-color);
            margin: 0;
            font-size: 0.9rem;
        }
        
        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
        }
        
        .chart-card h4 {
            margin-bottom: 1rem;
            color: #2d3748;
            font-weight: 600;
        }
        
        /* Tables */
        .data-table {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        
        .data-table h4 {
            margin-bottom: 1rem;
            color: #2d3748;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table th {
            background: #f8f9fc;
            border-top: none;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-badge.active { background: rgba(28,200,138,0.1); color: var(--success-color); }
        .status-badge.pending { background: rgba(246,194,62,0.1); color: var(--warning-color); }
        .status-badge.overdue { background: rgba(231,74,59,0.1); color: var(--danger-color); }
        
        /* Quick Actions */
        .quick-actions {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        
        .quick-actions h4 {
            margin-bottom: 1rem;
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .action-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .action-btn.primary {
            background: var(--primary-color);
            color: white;
        }
        
        .action-btn.success {
            background: var(--success-color);
            color: white;
        }
        
        .action-btn.warning {
            background: var(--warning-color);
            color: #212529;
        }
        
        .action-btn.info {
            background: var(--info-color);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* Alerts Section */
        .alerts-section {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8f9fc;
        }
        
        .alert-item.warning {
            background: rgba(246,194,62,0.1);
            border-left: 4px solid var(--warning-color);
        }
        
        .alert-item.danger {
            background: rgba(231,74,59,0.1);
            border-left: 4px solid var(--danger-color);
        }
        
        .alert-item.success {
            background: rgba(28,200,138,0.1);
            border-left: 4px solid var(--success-color);
        }
        
        .alert-item i {
            font-size: 1.5rem;
            margin-right: 15px;
        }
        
        /* Modal Styles */
        .modal-content {
            border-radius: 15px;
        }
        
        .modal-header {
            background: var(--primary-color);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        .modal-header .btn-close {
            filter: invert(1);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-brand">
            <h2><i class="bi bi-mortarboard-fill"></i> EduPrime</h2>
            <small>Institute Management</small>
        </div>
        <div class="sidebar-menu">
            <a href="#" class="menu-item active" data-section="dashboard">
                <i class="bi bi-grid-fill"></i> Dashboard
            </a>
            <a href="#" class="menu-item" data-section="students">
                <i class="bi bi-people-fill"></i> Students
            </a>
            <a href="#" class="menu-item" data-section="faculty">
                <i class="bi bi-person-badge-fill"></i> Faculty
            </a>
            <a href="#" class="menu-item" data-section="batches">
                <i class="bi bi-collection-fill"></i> Batches
            </a>
            <a href="#" class="menu-item" data-section="fees">
                <i class="bi bi-currency-rupee"></i> Fee Management
            </a>
            <a href="#" class="menu-item" data-section="attendance">
                <i class="bi bi-calendar-check-fill"></i> Attendance
            </a>
            <a href="#" class="menu-item" data-section="exams">
                <i class="bi bi-file-earmark-text-fill"></i> Exams & Results
            </a>
            <a href="#" class="menu-item" data-section="inquiries">
                <i class="bi bi-chat-dots-fill"></i> Inquiries
            </a>
            <a href="#" class="menu-item" data-section="reports">
                <i class="bi bi-graph-up"></i> Reports
            </a>
            <a href="#" class="menu-item" data-section="settings">
                <i class="bi bi-gear-fill"></i> Settings
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Navigation -->
        <div class="top-nav">
            <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" placeholder="Search students, faculty, batches...">
            </div>
            <div class="user-profile">
                <div class="notification-badge">
                    <i class="bi bi-bell-fill" style="font-size: 1.3rem; cursor: pointer;"></i>
                    <span class="badge bg-danger">5</span>
                </div>
                <div class="dropdown">
                    <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle"></i> Admin
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#">Profile</a></li>
                        <li><a class="dropdown-item" href="#">Settings</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard-section">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card students">
                    <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
                    <h3 id="total-students">0</h3>
                    <p>Total Students</p>
                </div>
                <div class="stat-card revenue">
                    <div class="stat-icon"><i class="bi bi-currency-rupee"></i></div>
                    <h3 id="monthly-revenue">₹0</h3>
                    <p>Monthly Revenue</p>
                </div>
                <div class="stat-card attendance">
                    <div class="stat-icon"><i class="bi bi-calendar-check"></i></div>
                    <h3 id="avg-attendance">0%</h3>
                    <p>Avg Attendance</p>
                </div>
                <div class="stat-card pending">
                    <div class="stat-icon"><i class="bi bi-exclamation-circle"></i></div>
                    <h3 id="pending-fees">₹0</h3>
                    <p>Pending Fees</p>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h4><i class="bi bi-lightning-fill text-warning"></i> Quick Actions</h4>
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="openModal('addStudent')">
                        <i class="bi bi-person-plus"></i> Add Student
                    </button>
                    <button class="action-btn success" onclick="openModal('recordPayment')">
                        <i class="bi bi-cash-stack"></i> Record Payment
                    </button>
                    <button class="action-btn info" onclick="openModal('markAttendance')">
                        <i class="bi bi-calendar-check"></i> Mark Attendance
                    </button>
                    <button class="action-btn warning" onclick="openModal('sendNotification')">
                        <i class="bi bi-send"></i> Send Notification
                    </button>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h4><i class="bi bi-bar-chart-fill text-primary"></i> Revenue Trend</h4>
                    <canvas id="revenueChart"></canvas>
                </div>
                <div class="chart-card">
                    <h4><i class="bi bi-pie-chart-fill text-success"></i> Fee Status Distribution</h4>
                    <canvas id="feeStatusChart"></canvas>
                </div>
                <div class="chart-card">
                    <h4><i class="bi bi-graph-up text-info"></i> Attendance Trend</h4>
                    <canvas id="attendanceChart"></canvas>
                </div>
                <div class="chart-card">
                    <h4><i class="bi bi-award-fill text-warning"></i> Performance Distribution</h4>
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <!-- Data Tables -->
            <div class="row">
                <div class="col-lg-6">
                    <div class="data-table">
                        <h4>
                            <span><i class="bi bi-exclamation-triangle text-warning"></i> Overdue Fees</span>
                            <a href="#" class="btn btn-sm btn-outline-primary">View All</a>
                        </h4>
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Amount</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="overdue-fees-table">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="data-table">
                        <h4>
                            <span><i class="bi bi-calendar-event text-info"></i> Upcoming Exams</span>
                            <a href="#" class="btn btn-sm btn-outline-primary">View All</a>
                        </h4>
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Exam</th>
                                    <th>Batch</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="upcoming-exams-table">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recent Activity & Alerts -->
            <div class="row">
                <div class="col-lg-6">
                    <div class="data-table">
                        <h4><i class="bi bi-clock-history text-secondary"></i> Recent Inquiries</h4>
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Course</th>
                                    <th>Contact</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recent-inquiries-table">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="alerts-section">
                        <h4><i class="bi bi-bell-fill text-danger"></i> Alerts & Notifications</h4>
                        <div id="alerts-container">
                            <div class="alert-item warning">
                                <i class="bi bi-exclamation-triangle text-warning"></i>
                                <div>
                                    <strong>Fee Reminder</strong>
                                    <p class="mb-0 small">15 students have overdue fees</p>
                                </div>
                            </div>
                            <div class="alert-item danger">
                                <i class="bi bi-person-x text-danger"></i>
                                <div>
                                    <strong>Low Attendance Alert</strong>
                                    <p class="mb-0 small">8 students below 75% attendance</p>
                                </div>
                            </div>
                            <div class="alert-item success">
                                <i class="bi bi-check-circle text-success"></i>
                                <div>
                                    <strong>New Admission</strong>
                                    <p class="mb-0 small">3 new students enrolled today</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-plus"></i> Add New Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStudentForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">First Name</label>
                                <input type="text" class="form-control" name="first_name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Last Name</label>
                                <input type="text" class="form-control" name="last_name" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" name="email" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control" name="phone" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Parent Phone</label>
                                <input type="tel" class="form-control" name="parent_phone">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Class</label>
                                <select class="form-select" name="class_name" required>
                                    <option value="">Select Class</option>
                                    <option value="9">Class 9</option>
                                    <option value="10">Class 10</option>
                                    <option value="11">Class 11</option>
                                    <option value="12">Class 12</option>
                                    <option value="IIT-JEE">IIT-JEE</option>
                                    <option value="NEET">NEET</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" name="address" rows="2"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date of Birth</label>
                                <input type="date" class="form-control" name="date_of_birth">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Select Batches</label>
                                <select class="form-select" name="batch_id" multiple id="batchSelect">
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitStudentForm()">Add Student</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Record Payment Modal -->
    <div class="modal fade" id="recordPaymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-cash-stack"></i> Record Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <div class="mb-3">
                            <label class="form-label">Select Student</label>
                            <select class="form-select" name="student_id" id="paymentStudentSelect" required>
                                <!-- Populated dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fee Type</label>
                            <select class="form-select" name="fee_type" required>
                                <option value="tuition">Tuition Fee</option>
                                <option value="admission">Admission Fee</option>
                                <option value="exam">Exam Fee</option>
                                <option value="library">Library Fee</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" name="amount" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Method</label>
                            <select class="form-select" name="payment_method" required>
                                <option value="cash">Cash</option>
                                <option value="upi">UPI</option>
                                <option value="card">Card</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="cheque">Cheque</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Transaction ID (if applicable)</label>
                            <input type="text" class="form-control" name="transaction_id">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="submitPaymentForm()">Record Payment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mark Attendance Modal -->
    <div class="modal fade" id="markAttendanceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-calendar-check"></i> Mark Attendance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="attendanceForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Select Batch</label>
                                <select class="form-select" id="attendanceBatchSelect" onchange="loadBatchStudents()">
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="attendanceDate" value="">
                            </div>
                        </div>
                        <div id="attendanceStudentsList">
                            <!-- Student list with attendance options -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" onclick="submitAttendanceForm()">Save Attendance</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API Base URL
        const API_BASE = 'http://localhost:3000/api';
        
        // Dashboard State
        let dashboardData = {
            students: [],
            batches: [],
            fees: [],
            attendance: []
        };
        
        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', () => {
            initializeDashboard();
            initializeCharts();
            setDefaultDate();
        });
        
        // Set default date for attendance
        function setDefaultDate() {
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
        }
        
        // Initialize Dashboard Data
        async function initializeDashboard() {
            try {
                await Promise.all([
                    fetchDashboardStats(),
                    fetchOverdueFees(),
                    fetchUpcomingExams(),
                    fetchRecentInquiries(),
                    loadBatches(),
                    loadStudents()
                ]);
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                showToast('Failed to load dashboard data', 'error');
            }
        }
        
        // Fetch Dashboard Statistics
        async function fetchDashboardStats() {
            try {
                const response = await fetch(`${API_BASE}/dashboard/stats`);
                const data = await response.json();
                
                document.getElementById('total-students').textContent = data.totalStudents || '0';
                document.getElementById('monthly-revenue').textContent = `₹${formatNumber(data.monthlyRevenue || 0)}`;
                document.getElementById('avg-attendance').textContent = `${data.avgAttendance || 0}%`;
                document.getElementById('pending-fees').textContent = `₹${formatNumber(data.pendingFees || 0)}`;
            } catch (error) {
                console.error('Error fetching stats:', error);
                // Set demo data
                document.getElementById('total-students').textContent = '245';
                document.getElementById('monthly-revenue').textContent = '₹4,50,000';
                document.getElementById('avg-attendance').textContent = '87%';
                document.getElementById('pending-fees').textContent = '₹1,25,000';
            }
        }
        
        // Fetch Overdue Fees
        async function fetchOverdueFees() {
            try {
                const response = await fetch(`${API_BASE}/fees?status=overdue&limit=5`);
                const data = await response.json();
                
                const tbody = document.getElementById('overdue-fees-table');
                tbody.innerHTML = data.map(fee => `
                    <tr>
                        <td>${fee.student_name}</td>
                        <td>₹${formatNumber(fee.amount)}</td>
                        <td>${formatDate(fee.due_date)}</td>
                        <td><span class="status-badge overdue">Overdue</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                // Demo data
                document.getElementById('overdue-fees-table').innerHTML = `
                    <tr><td>Rahul Sharma</td><td>₹15,000</td><td>01/01/2025</td><td><span class="status-badge overdue">Overdue</span></td></tr>
                    <tr><td>Priya Patel</td><td>₹12,000</td><td>05/01/2025</td><td><span class="status-badge overdue">Overdue</span></td></tr>
                    <tr><td>Amit Kumar</td><td>₹18,000</td><td>10/01/2025</td><td><span class="status-badge overdue">Overdue</span></td></tr>
                `;
            }
        }
        
        // Fetch Upcoming Exams
        async function fetchUpcomingExams() {
            try {
                const response = await fetch(`${API_BASE}/exams/upcoming/list`);
                const data = await response.json();
                
                const tbody = document.getElementById('upcoming-exams-table');
                tbody.innerHTML = data.map(exam => `
                    <tr>
                        <td>${exam.title}</td>
                        <td>${exam.batch_name}</td>
                        <td>${formatDate(exam.exam_date)}</td>
                        <td><span class="status-badge active">Scheduled</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                // Demo data
                document.getElementById('upcoming-exams-table').innerHTML = `
                    <tr><td>Physics Unit Test</td><td>JEE-2025</td><td>20/01/2025</td><td><span class="status-badge active">Scheduled</span></td></tr>
                    <tr><td>Chemistry Quiz</td><td>NEET-2025</td><td>22/01/2025</td><td><span class="status-badge active">Scheduled</span></td></tr>
                    <tr><td>Math Mock Test</td><td>Class 12</td><td>25/01/2025</td><td><span class="status-badge active">Scheduled</span></td></tr>
                `;
            }
        }
        
        // Fetch Recent Inquiries
        async function fetchRecentInquiries() {
            try {
                const response = await fetch(`${API_BASE}/admissions/inquiries?limit=5`);
                const data = await response.json();
                
                const tbody = document.getElementById('recent-inquiries-table');
                tbody.innerHTML = data.map(inquiry => `
                    <tr>
                        <td>${inquiry.student_name}</td>
                        <td>${inquiry.course_interest}</td>
                        <td>${inquiry.phone}</td>
                        <td><span class="status-badge ${inquiry.status}">${inquiry.status}</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                // Demo data
                document.getElementById('recent-inquiries-table').innerHTML = `
                    <tr><td>Ankit Verma</td><td>IIT-JEE</td><td>9876543210</td><td><span class="status-badge pending">New</span></td></tr>
                    <tr><td>Neha Singh</td><td>NEET</td><td>9876543211</td><td><span class="status-badge active">Contacted</span></td></tr>
                    <tr><td>Rohan Gupta</td><td>Class 12</td><td>9876543212</td><td><span class="status-badge pending">Follow-up</span></td></tr>
                `;
            }
        }
        
        // Load Batches for dropdowns
        async function loadBatches() {
            try {
                const response = await fetch(`${API_BASE}/batches`);
                const payload = await response.json();
                dashboardData.batches = payload?.data || [];
                
                populateBatchDropdowns();
            } catch (error) {
                // Demo data
                dashboardData.batches = [
                    { id: 1, name: 'JEE-2025 Morning' },
                    { id: 2, name: 'NEET-2025 Evening' },
                    { id: 3, name: 'Class 12 Science' }
                ];
                populateBatchDropdowns();
            }
        }
        
        // Load Students for dropdowns
        async function loadStudents() {
            try {
                const response = await fetch(`${API_BASE}/students`);
                const payload = await response.json();
                dashboardData.students = payload?.data || [];
                
                populateStudentDropdowns();
            } catch (error) {
                // Demo data
                dashboardData.students = [
                    { id: 1, first_name: 'Rahul', last_name: 'Sharma' },
                    { id: 2, first_name: 'Priya', last_name: 'Patel' },
                    { id: 3, first_name: 'Amit', last_name: 'Kumar' }
                ];
                populateStudentDropdowns();
            }
        }
        
        // Populate Batch Dropdowns
        function populateBatchDropdowns() {
            const batchOptions = dashboardData.batches.map(b => 
                `<option value="${b.id}">${b.name}</option>`
            ).join('');
            
            document.getElementById('batchSelect').innerHTML = batchOptions;
            document.getElementById('attendanceBatchSelect').innerHTML = 
                '<option value="">Select Batch</option>' + batchOptions;
        }
        
        // Populate Student Dropdowns
        function populateStudentDropdowns() {
            const studentOptions = dashboardData.students.map(s => 
                `<option value="${s.id}">${s.first_name} ${s.last_name}</option>`
            ).join('');
            
            document.getElementById('paymentStudentSelect').innerHTML = 
                '<option value="">Select Student</option>' + studentOptions;
        }

        // Student Overview (consolidated)
        async function fetchStudentOverview(studentId, opts = {}) {
            const params = new URLSearchParams();
            if (opts.includeSyllabus) params.set('include_syllabus', 'true');
            if (opts.attendanceDays) params.set('attendance_days', String(opts.attendanceDays));
            if (opts.examLimit) params.set('exam_limit', String(opts.examLimit));

            const url = `${API_BASE}/students/${studentId}/overview${params.toString() ? `?${params.toString()}` : ''}`;
            const resp = await fetch(url);
            const payload = await resp.json();
            if (!resp.ok || payload?.success === false) {
                throw new Error(payload?.message || payload?.error || 'Failed to load student overview');
            }
            return payload.data;
        }
        
        // Initialize Charts
        function initializeCharts() {
            // Revenue Chart
            new Chart(document.getElementById('revenueChart'), {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Revenue',
                        data: [250000, 320000, 280000, 450000, 380000, 420000],
                        borderColor: '#4e73df',
                        backgroundColor: 'rgba(78, 115, 223, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => '₹' + (value/1000) + 'K'
                            }
                        }
                    }
                }
            });
            
            // Fee Status Chart
            new Chart(document.getElementById('feeStatusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Paid', 'Pending', 'Overdue'],
                    datasets: [{
                        data: [65, 25, 10],
                        backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
            
            // Attendance Chart
            new Chart(document.getElementById('attendanceChart'), {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                    datasets: [{
                        label: 'Attendance %',
                        data: [92, 88, 95, 87, 90, 85],
                        backgroundColor: '#36b9cc'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
            
            // Performance Chart
            new Chart(document.getElementById('performanceChart'), {
                type: 'pie',
                data: {
                    labels: ['Excellent (>90%)', 'Good (75-90%)', 'Average (60-75%)', 'Below Avg (<60%)'],
                    datasets: [{
                        data: [15, 35, 30, 20],
                        backgroundColor: ['#1cc88a', '#4e73df', '#f6c23e', '#e74a3b']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        // Open Modal
        function openModal(type) {
            let modalId;
            switch(type) {
                case 'addStudent': modalId = 'addStudentModal'; break;
                case 'recordPayment': modalId = 'recordPaymentModal'; break;
                case 'markAttendance': modalId = 'markAttendanceModal'; break;
                case 'sendNotification': showToast('Notification feature coming soon!', 'info'); return;
            }
            new bootstrap.Modal(document.getElementById(modalId)).show();
        }
        
        // Load Batch Students for Attendance
        async function loadBatchStudents() {
            const batchId = document.getElementById('attendanceBatchSelect').value;
            if (!batchId) return;
            
            try {
                const response = await fetch(`${API_BASE}/batches/${batchId}/students`);
                const students = await response.json();
                
                const container = document.getElementById('attendanceStudentsList');
                container.innerHTML = students.map(s => `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                        <span>${s.first_name} ${s.last_name}</span>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="att_${s.id}" id="present_${s.id}" value="present" checked>
                            <label class="btn btn-outline-success btn-sm" for="present_${s.id}">Present</label>
                            
                            <input type="radio" class="btn-check" name="att_${s.id}" id="absent_${s.id}" value="absent">
                            <label class="btn btn-outline-danger btn-sm" for="absent_${s.id}">Absent</label>
                            
                            <input type="radio" class="btn-check" name="att_${s.id}" id="late_${s.id}" value="late">
                            <label class="btn btn-outline-warning btn-sm" for="late_${s.id}">Late</label>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                // Demo data
                document.getElementById('attendanceStudentsList').innerHTML = `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                        <span>Rahul Sharma</span>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="att_1" id="present_1" value="present" checked>
                            <label class="btn btn-outline-success btn-sm" for="present_1">Present</label>
                            <input type="radio" class="btn-check" name="att_1" id="absent_1" value="absent">
                            <label class="btn btn-outline-danger btn-sm" for="absent_1">Absent</label>
                        </div>
                    </div>
                `;
            }
        }
        
        // Submit Student Form
        async function submitStudentForm() {
            const form = document.getElementById('addStudentForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Map UI fields to backend schema
            if (data.class_name !== undefined) {
                data.current_class = data.class_name;
                delete data.class_name;
            }

            // Backend expects father_phone; UI label is Parent Phone
            if (data.parent_phone !== undefined && data.parent_phone !== '') {
                data.father_phone = data.parent_phone;
            }
            delete data.parent_phone;

            // Collect multi-select batches
            const selectedBatchIds = Array
                .from(document.getElementById('batchSelect').selectedOptions)
                .map(o => o.value)
                .filter(Boolean);

            // Do not send batch_id directly; enroll via API after student create
            delete data.batch_id;
            
            try {
                const response = await fetch(`${API_BASE}/students`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const created = await response.json();

                    // Enroll into selected batches (best-effort)
                    const studentId = created?.data?.id;
                    if (studentId && selectedBatchIds.length) {
                        await Promise.all(selectedBatchIds.map(batchId =>
                            fetch(`${API_BASE}/students/${studentId}/enroll`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ batch_id: batchId })
                            })
                        ));
                    }

                    showToast('Student added successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                    form.reset();
                    fetchDashboardStats();
                } else {
                    let msg = 'Failed to add student';
                    try {
                        const err = await response.json();
                        msg = err?.message || err?.error || msg;
                    } catch (_) {}
                    throw new Error(msg);
                }
            } catch (error) {
                showToast(error.message || 'Failed to add student', 'error');
            }
        }
        
        // Submit Payment Form
        async function submitPaymentForm() {
            const form = document.getElementById('paymentForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch(`${API_BASE}/fees`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...data,
                        status: 'paid',
                        payment_date: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    showToast('Payment recorded successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('recordPaymentModal')).hide();
                    form.reset();
                    fetchDashboardStats();
                }
            } catch (error) {
                showToast('Payment recorded (demo mode)', 'success');
                bootstrap.Modal.getInstance(document.getElementById('recordPaymentModal')).hide();
            }
        }
        
        // Submit Attendance Form
        async function submitAttendanceForm() {
            const batchId = document.getElementById('attendanceBatchSelect').value;
            const date = document.getElementById('attendanceDate').value;
            
            if (!batchId || !date) {
                showToast('Please select batch and date', 'warning');
                return;
            }
            
            // Collect attendance data
            const attendanceData = [];
            document.querySelectorAll('[name^="att_"]').forEach(input => {
                if (input.checked) {
                    const studentId = input.name.replace('att_', '');
                    attendanceData.push({
                        student_id: studentId,
                        status: input.value
                    });
                }
            });
            
            try {
                const response = await fetch(`${API_BASE}/attendance/bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        batch_id: batchId,
                        date: date,
                        attendance: attendanceData
                    })
                });
                
                if (response.ok) {
                    showToast('Attendance saved successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('markAttendanceModal')).hide();
                }
            } catch (error) {
                showToast('Attendance saved (demo mode)', 'success');
                bootstrap.Modal.getInstance(document.getElementById('markAttendanceModal')).hide();
            }
        }
        
        // Utility Functions
        function formatNumber(num) {
            return new Intl.NumberFormat('en-IN').format(num);
        }
        
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-IN');
        }
        
        function showToast(message, type = 'info') {
            // Simple alert for now - can be replaced with a toast library
            const colors = {
                success: '#1cc88a',
                error: '#e74a3b',
                warning: '#f6c23e',
                info: '#36b9cc'
            };
            
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${colors[type]};
                color: white;
                border-radius: 8px;
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }
        
        // Sidebar Navigation
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                const section = this.dataset.section;
                // Handle section navigation
                if (section === 'students') {
                    showStudentManagementSection();
                } else if (section === 'batches') {
                    showBatchesSection();
                } else if (section === 'fees') {
                    showFeeManagementSection();
                } else if (section === 'faculty') {
                    showFacultyManagementSection();
                } else if (section === 'attendance') {
                    showAttendanceSection();
                } else if (section === 'exams') {
                    showExamsSection();
                } else if (section === 'inquiries') {
                    showInquiriesSection();
                } else if (section === 'reports') {
                    showReportsSection();
                } else if (section === 'settings') {
                    showSettingsSection();
                } else if (section !== 'dashboard') {
                    showToast(`${section.charAt(0).toUpperCase() + section.slice(1)} section - Coming soon!`, 'info');
                } else {
                    // Back to dashboard
                    hideAllSections();
                    document.getElementById('dashboard-section').style.display = 'block';
                }
            });
        });

        // Hide all dynamic sections
        function hideAllSections() {
            document.getElementById('dashboard-section').style.display = 'none';
            const smSec = document.getElementById('student-management-section');
            if (smSec) smSec.style.display = 'none';
            const batchSec = document.getElementById('batches-section');
            if (batchSec) batchSec.style.display = 'none';
            const feeSec = document.getElementById('fee-management-section');
            if (feeSec) feeSec.style.display = 'none';
            const facultySec = document.getElementById('faculty-management-section');
            if (facultySec) facultySec.style.display = 'none';
            const attendanceSec = document.getElementById('attendance-section');
            if (attendanceSec) attendanceSec.style.display = 'none';
            const examsSec = document.getElementById('exams-section');
            if (examsSec) examsSec.style.display = 'none';
            const inquiriesSec = document.getElementById('inquiries-section');
            if (inquiriesSec) inquiriesSec.style.display = 'none';
            const reportsSec = document.getElementById('reports-section');
            if (reportsSec) reportsSec.style.display = 'none';
            const settingsSec = document.getElementById('settings-section');
            if (settingsSec) settingsSec.style.display = 'none';
        }

        // ============================================
        // STUDENT MANAGEMENT SECTION
        // ============================================

        // Create Student Management Section DOM (once)
        function ensureStudentManagementSection() {
            if (document.getElementById('student-management-section')) return;

            const section = document.createElement('div');
            section.id = 'student-management-section';
            section.style.display = 'none';
            section.innerHTML = `
                <h3 class="mb-4"><i class="bi bi-people-fill text-primary"></i> Student Management</h3>

                <!-- Course Catalog -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-journal-bookmark"></i> Course Catalog
                    </div>
                    <div class="card-body">
                        <div id="course-catalog-loading" class="loading-spinner"><div class="spinner"></div></div>
                        <div id="course-catalog" class="row g-3" style="display:none;"></div>
                    </div>
                </div>

                <!-- Student Search & Profile -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-person-badge"></i> Student Profile & Overview</span>
                        <div class="input-group" style="max-width:350px;">
                            <select id="sm-student-select" class="form-select form-select-sm">
                                <option value="">Select Student...</option>
                            </select>
                            <button class="btn btn-light btn-sm" onclick="loadSelectedStudentOverview()">Load</button>
                        </div>
                    </div>
                    <div class="card-body" id="student-profile-container">
                        <p class="text-muted text-center">Select a student to view their profile</p>
                    </div>
                </div>

                <!-- Batch Allocation -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-collection"></i> Batch Allocation & Upgrades
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Student</label>
                                <select id="batch-alloc-student" class="form-select"></select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Add to Batch</label>
                                <select id="batch-alloc-batch" class="form-select"></select>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button class="btn btn-info w-100" onclick="addStudentToBatch()">Add</button>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn btn-outline-warning w-100" onclick="showUpgradeBatchModal()">Upgrade Batch</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attendance Calendar (for selected student) -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-calendar-check"></i> Attendance Calendar</span>
                        <div class="d-flex gap-2">
                            <select id="att-cal-student" class="form-select form-select-sm" style="max-width:200px;"></select>
                            <select id="att-cal-month" class="form-select form-select-sm" style="max-width:120px;"></select>
                            <button class="btn btn-sm btn-dark" onclick="loadAttendanceCalendar()">Load</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="attendance-calendar-container" class="text-center text-muted">Select a student and month to view</div>
                    </div>
                </div>

                <!-- Performance / Progress Report -->
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-graph-up-arrow"></i> Progress Report</span>
                        <div class="d-flex gap-2">
                            <select id="progress-student" class="form-select form-select-sm" style="max-width:220px;"></select>
                            <button class="btn btn-sm btn-light" onclick="loadProgressReport()">Generate</button>
                        </div>
                    </div>
                    <div class="card-body" id="progress-report-container">
                        <p class="text-muted text-center">Select a student to generate progress report</p>
                    </div>
                </div>
            `;
            document.querySelector('.main-content').appendChild(section);
        }

        // Show Student Management Section
        async function showStudentManagementSection() {
            ensureStudentManagementSection();
            hideAllSections();
            document.getElementById('student-management-section').style.display = 'block';

            await loadStudents(); // ensure fresh list
            populateSMDropdowns();
            loadCourseCatalog();
            populateMonthDropdown();
        }

        // Populate all dropdowns in Student Management section
        function populateSMDropdowns() {
            const studentOpts = '<option value="">Select Student...</option>' +
                dashboardData.students.map(s => `<option value="${s.id}">${s.first_name} ${s.last_name}</option>`).join('');

            const batchOpts = '<option value="">Select Batch...</option>' +
                dashboardData.batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

            document.getElementById('sm-student-select').innerHTML = studentOpts;
            document.getElementById('batch-alloc-student').innerHTML = studentOpts;
            document.getElementById('batch-alloc-batch').innerHTML = batchOpts;
            document.getElementById('att-cal-student').innerHTML = studentOpts;
            document.getElementById('progress-student').innerHTML = studentOpts;
        }

        // Populate month dropdown (last 6 months + current)
        function populateMonthDropdown() {
            const sel = document.getElementById('att-cal-month');
            const opts = [];
            const now = new Date();
            for (let i = 0; i < 7; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const val = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                const label = d.toLocaleString('default', { month: 'short', year: 'numeric' });
                opts.push(`<option value="${val}">${label}</option>`);
            }
            sel.innerHTML = opts.join('');
        }

        // Load Course Catalog from backend
        async function loadCourseCatalog() {
            const container = document.getElementById('course-catalog');
            const loading = document.getElementById('course-catalog-loading');
            loading.style.display = 'flex';
            container.style.display = 'none';

            try {
                const resp = await fetch(`${API_BASE}/students/catalog/courses`);
                const payload = await resp.json();
                const courses = payload?.data?.courses || [];

                container.innerHTML = courses.length ? courses.map(c => `
                    <div class="col-md-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">${c.name}</h5>
                                <p class="card-text small">${c.description || c.course_type || ''}</p>
                                <ul class="list-unstyled small">
                                    <li><strong>Duration:</strong> ${c.duration_months || '—'} months</li>
                                    <li><strong>Fee:</strong> ₹${formatNumber(c.total_fee || 0)}</li>
                                    <li><strong>Batches:</strong> ${c.batch_count || 0}</li>
                                    <li><strong>Enrolled:</strong> ${c.enrolled_students || 0}</li>
                                </ul>
                                <button class="btn btn-sm btn-outline-primary" onclick="showCourseDetails('${c.id}')">View Details & Fee Structure</button>
                            </div>
                        </div>
                    </div>
                `).join('') : '<p class="text-muted">No courses found</p>';
            } catch (err) {
                container.innerHTML = '<p class="text-danger">Failed to load courses</p>';
            }

            loading.style.display = 'none';
            container.style.display = 'flex';
        }

        // Show course details + fee structure modal
        async function showCourseDetails(courseId) {
            try {
                const [courseResp, feeResp] = await Promise.all([
                    fetch(`${API_BASE}/students/catalog/courses/${courseId}`),
                    fetch(`${API_BASE}/students/catalog/courses/${courseId}/fee-structure`)
                ]);
                const course = (await courseResp.json())?.data;
                const feeData = (await feeResp.json())?.data;

                const installmentsHtml = (feeData?.installment_options || []).map(opt => `
                    <tr>
                        <td>${opt.plan}</td>
                        <td>${opt.installments}</td>
                        <td>₹${formatNumber(opt.amount_per_installment)}</td>
                        <td>${opt.discount_percent}%</td>
                    </tr>
                `).join('');

                const scholarshipsHtml = (feeData?.scholarships || []).map(s => `
                    <li><strong>${s.name}</strong>: ${s.discount} (${s.criteria})</li>
                `).join('');

                const html = `
                    <div class="modal fade" id="courseDetailModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">${course?.name || 'Course'}</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>${course?.description || ''}</p>
                                    <h6>Subjects</h6>
                                    <ul>${(course?.subjects || []).map(s => `<li>${s.name || s}</li>`).join('') || '<li>N/A</li>'}</ul>
                                    <hr>
                                    <h6>Fee Structure</h6>
                                    <table class="table table-sm">
                                        <thead><tr><th>Plan</th><th>Installments</th><th>Amount/Inst</th><th>Discount</th></tr></thead>
                                        <tbody>${installmentsHtml || '<tr><td colspan="4">N/A</td></tr>'}</tbody>
                                    </table>
                                    <h6>Scholarships</h6>
                                    <ul>${scholarshipsHtml || '<li>None</li>'}</ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove old modal if exists
                document.getElementById('courseDetailModal')?.remove();
                document.body.insertAdjacentHTML('beforeend', html);
                new bootstrap.Modal(document.getElementById('courseDetailModal')).show();
            } catch (err) {
                showToast('Failed to load course details', 'error');
            }
        }

        // Load selected student overview
        async function loadSelectedStudentOverview() {
            const studentId = document.getElementById('sm-student-select').value;
            if (!studentId) { showToast('Select a student first', 'warning'); return; }

            const container = document.getElementById('student-profile-container');
            container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

            try {
                const overview = await fetchStudentOverview(studentId, { includeSyllabus: true, attendanceDays: 30, examLimit: 10 });
                const s = overview.student;
                const batches = overview.batches || [];
                const feeSummary = overview.fee_summary || {};
                const attendanceSummary = overview.attendance_summary || [];
                const results = overview.recent_results || [];

                container.innerHTML = `
                    <div class="row">
                        <div class="col-md-4 border-end">
                            <h5>${s.first_name} ${s.last_name}</h5>
                            <p class="mb-1"><i class="bi bi-telephone"></i> ${s.phone || '—'}</p>
                            <p class="mb-1"><i class="bi bi-envelope"></i> ${s.email || '—'}</p>
                            <p class="mb-1"><i class="bi bi-calendar"></i> DOB: ${s.date_of_birth ? formatDate(s.date_of_birth) : '—'}</p>
                            <p class="mb-1"><i class="bi bi-book"></i> Target: ${s.target_exam || '—'}</p>
                            <p class="mb-1"><i class="bi bi-person"></i> Father: ${s.father_name || '—'} (${s.father_phone || '—'})</p>
                        </div>
                        <div class="col-md-4 border-end">
                            <h6>Enrolled Batches</h6>
                            <ul class="list-unstyled small">${batches.map(b => `<li>${b.name} (${b.course_name || ''})</li>`).join('') || '<li>None</li>'}</ul>
                            <h6 class="mt-3">Attendance (30d)</h6>
                            ${attendanceSummary.length ? attendanceSummary.map(a => `<p class="mb-0 small">${a.batch_name || 'Overall'}: ${a.present || 0}/${a.total_classes || 0} (${a.attendance_percent || 0}%)</p>`).join('') : '<p class="mb-0 small">No data</p>'}
                        </div>
                        <div class="col-md-4">
                            <h6>Fee Summary</h6>
                            <p class="mb-1 small">Total: ₹${formatNumber(feeSummary.total_net_amount || 0)}</p>
                            <p class="mb-1 small">Paid: ₹${formatNumber(feeSummary.total_paid_amount || 0)}</p>
                            <p class="mb-1 small">Balance: ₹${formatNumber(feeSummary.total_balance_amount || 0)}</p>
                            <p class="mb-1 small text-danger">Overdue: ${feeSummary.overdue_count || 0}</p>
                            <h6 class="mt-3">Recent Results</h6>
                            <ul class="list-unstyled small">${results.slice(0,5).map(r => `<li>${r.exam_name || r.title || 'Exam'}: ${r.marks_obtained || r.percentage || '—'}%</li>`).join('') || '<li>No results</li>'}</ul>
                        </div>
                    </div>
                `;
            } catch (err) {
                container.innerHTML = `<p class="text-danger">${err.message || 'Failed to load overview'}</p>`;
            }
        }

        // Add student to batch
        async function addStudentToBatch() {
            const studentId = document.getElementById('batch-alloc-student').value;
            const batchId = document.getElementById('batch-alloc-batch').value;
            if (!studentId || !batchId) { showToast('Select student and batch', 'warning'); return; }

            try {
                const resp = await fetch(`${API_BASE}/students/${studentId}/batches`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ batch_id: batchId })
                });
                if (resp.ok) {
                    showToast('Student added to batch!', 'success');
                } else {
                    throw new Error((await resp.json())?.message || 'Failed');
                }
            } catch (err) {
                showToast(err.message || 'Failed to add student to batch', 'error');
            }
        }

        // Show upgrade batch modal (simplified)
        function showUpgradeBatchModal() {
            // Build a quick modal for from/to batch
            const modalHtml = `
                <div class="modal fade" id="upgradeBatchModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title">Upgrade Batch</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Student</label>
                                    <select id="upgrade-student" class="form-select">
                                        <option value="">Select Student</option>
                                        ${dashboardData.students.map(s => `<option value="${s.id}">${s.first_name} ${s.last_name}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">From Batch</label>
                                    <select id="upgrade-from" class="form-select">
                                        <option value="">Select</option>
                                        ${dashboardData.batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">To Batch</label>
                                    <select id="upgrade-to" class="form-select">
                                        <option value="">Select</option>
                                        ${dashboardData.batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button class="btn btn-warning" onclick="submitUpgradeBatch()">Upgrade</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('upgradeBatchModal')?.remove();
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('upgradeBatchModal')).show();
        }

        async function submitUpgradeBatch() {
            const studentId = document.getElementById('upgrade-student').value;
            const fromBatch = document.getElementById('upgrade-from').value;
            const toBatch = document.getElementById('upgrade-to').value;
            if (!studentId || !fromBatch || !toBatch) { showToast('Fill all fields', 'warning'); return; }

            try {
                const resp = await fetch(`${API_BASE}/students/${studentId}/upgrade-batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ from_batch_id: fromBatch, to_batch_id: toBatch })
                });
                if (resp.ok) {
                    showToast('Batch upgraded successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('upgradeBatchModal')).hide();
                } else {
                    throw new Error((await resp.json())?.message || 'Failed');
                }
            } catch (err) {
                showToast(err.message || 'Upgrade failed', 'error');
            }
        }

        // Load attendance calendar
        async function loadAttendanceCalendar() {
            const studentId = document.getElementById('att-cal-student').value;
            const monthVal = document.getElementById('att-cal-month').value; // YYYY-MM
            if (!studentId || !monthVal) { showToast('Select student and month', 'warning'); return; }

            const [year, month] = monthVal.split('-');
            const container = document.getElementById('attendance-calendar-container');
            container.innerHTML = '<div class="spinner-border text-primary" role="status"></div>';

            try {
                const resp = await fetch(`${API_BASE}/students/${studentId}/attendance/calendar?year=${year}&month=${month}`);
                const payload = await resp.json();
                const calendar = payload?.data?.calendar || {};

                const daysInMonth = new Date(year, month, 0).getDate();
                let html = '<div class="d-flex flex-wrap gap-1 justify-content-center">';
                for (let d = 1; d <= daysInMonth; d++) {
                    const info = calendar[d];
                    let bg = 'bg-light text-dark';
                    if (info) {
                        if (info.status === 'present') bg = 'bg-success text-white';
                        else if (info.status === 'absent') bg = 'bg-danger text-white';
                        else if (info.status === 'late') bg = 'bg-warning text-dark';
                    }
                    html += `<span class="badge ${bg}" style="width:32px;height:32px;line-height:24px;" title="${info?.remarks || ''}">${d}</span>`;
                }
                html += '</div><p class="small text-muted mt-2">Green=Present, Red=Absent, Yellow=Late, Grey=No Record</p>';
                container.innerHTML = html;
            } catch (err) {
                container.innerHTML = '<p class="text-danger">Failed to load calendar</p>';
            }
        }

        // Load progress report
        async function loadProgressReport() {
            const studentId = document.getElementById('progress-student').value;
            if (!studentId) { showToast('Select a student', 'warning'); return; }

            const container = document.getElementById('progress-report-container');
            container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

            try {
                const resp = await fetch(`${API_BASE}/students/${studentId}/progress-report`);
                const payload = await resp.json();
                const data = payload?.data;

                const s = data?.student || {};
                const att = data?.attendance_summary || {};
                const subjPerf = data?.subject_performance || [];
                const rankInfo = data?.rank_info || {};
                const feeSummary = data?.fee_summary || {};

                container.innerHTML = `
                    <div class="border rounded p-3">
                        <h5>Progress Report for ${s.first_name || ''} ${s.last_name || ''}</h5>
                        <p class="small text-muted mb-2">Generated: ${data?.generated_at ? new Date(data.generated_at).toLocaleString() : '—'}</p>
                        <hr>
                        <div class="row">
                            <div class="col-md-4">
                                <h6>Attendance (90 days)</h6>
                                <p class="mb-1 small">Total Classes: ${att.total_classes || 0}</p>
                                <p class="mb-1 small">Present: ${att.present || 0}</p>
                                <p class="mb-1 small">Absent: ${att.absent || 0}</p>
                                <p class="mb-1 small">Late: ${att.late || 0}</p>
                                <p class="mb-1 small"><strong>Attendance %:</strong> ${att.attendance_percent || 0}%</p>
                            </div>
                            <div class="col-md-4">
                                <h6>Subject Performance</h6>
                                <ul class="list-unstyled small">${subjPerf.length ? subjPerf.map(sp => `<li>${sp.subject}: Avg ${sp.avg_percentage}% (${sp.total_exams} exams)</li>`).join('') : '<li>No data</li>'}</ul>
                            </div>
                            <div class="col-md-4">
                                <h6>Rank</h6>
                                <p class="small">${rankInfo.rank ? `#${rankInfo.rank} of ${rankInfo.total_students}` : 'N/A'}</p>
                                <h6 class="mt-3">Fees</h6>
                                <p class="mb-1 small">Total: ₹${formatNumber(feeSummary.total_net || 0)}</p>
                                <p class="mb-1 small">Paid: ₹${formatNumber(feeSummary.total_paid || 0)}</p>
                                <p class="mb-1 small">Balance: ₹${formatNumber(feeSummary.total_balance || 0)}</p>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                container.innerHTML = '<p class="text-danger">Failed to generate progress report</p>';
            }
        }

        // ============================================
        // BATCHES SECTION
        // ============================================

        // Create Batches Section DOM (once)
        function ensureBatchesSection() {
            if (document.getElementById('batches-section')) return;

            const section = document.createElement('div');
            section.id = 'batches-section';
            section.style.display = 'none';
            section.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="bi bi-collection-fill text-primary"></i> Batch Management</h3>
                    <button class="btn btn-primary" onclick="showAddBatchModal()">
                        <i class="bi bi-plus-circle"></i> Add New Batch
                    </button>
                </div>

                <!-- Batch Stats -->
                <div class="stats-grid mb-4">
                    <div class="stat-card students">
                        <div class="stat-icon"><i class="bi bi-collection"></i></div>
                        <h3 id="batch-total-count">0</h3>
                        <p>Total Batches</p>
                    </div>
                    <div class="stat-card revenue">
                        <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
                        <h3 id="batch-active-count">0</h3>
                        <p>Active Batches</p>
                    </div>
                    <div class="stat-card attendance">
                        <div class="stat-icon"><i class="bi bi-people"></i></div>
                        <h3 id="batch-total-students">0</h3>
                        <p>Total Students Enrolled</p>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Course</label>
                                <select id="batch-filter-course" class="form-select" onchange="loadBatchesList()">
                                    <option value="">All Courses</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Type</label>
                                <select id="batch-filter-type" class="form-select" onchange="loadBatchesList()">
                                    <option value="">All Types</option>
                                    <option value="regular">Regular</option>
                                    <option value="weekend">Weekend</option>
                                    <option value="crash_course">Crash Course</option>
                                    <option value="online">Online</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Status</label>
                                <select id="batch-filter-active" class="form-select" onchange="loadBatchesList()">
                                    <option value="">All</option>
                                    <option value="true" selected>Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Search</label>
                                <input type="text" id="batch-filter-search" class="form-control" placeholder="Name or code..." onkeyup="debounceSearch(loadBatchesList, 300)">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button class="btn btn-outline-secondary w-100" onclick="resetBatchFilters()">Reset</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Batches List -->
                <div class="card mb-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-list-ul"></i> Batches</span>
                        <span id="batch-list-count" class="badge bg-primary">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="batches-list-loading" class="loading-spinner"><div class="spinner"></div></div>
                        <div class="table-responsive" id="batches-table-container" style="display:none;">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Batch Name</th>
                                        <th>Code</th>
                                        <th>Course</th>
                                        <th>Type</th>
                                        <th>Schedule</th>
                                        <th>Students</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="batches-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Batch Details Panel -->
                <div class="card mb-4" id="batch-details-panel" style="display:none;">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-info-circle"></i> Batch Details</span>
                        <button class="btn btn-sm btn-light" onclick="closeBatchDetails()">×</button>
                    </div>
                    <div class="card-body" id="batch-details-content"></div>
                </div>
            `;
            document.querySelector('.main-content').appendChild(section);
        }

        // Show Batches Section
        async function showBatchesSection() {
            ensureBatchesSection();
            hideAllSections();
            document.getElementById('batches-section').style.display = 'block';

            await loadBatchFilterCourses();
            await loadBatchesList();
        }

        // Load courses for filter dropdown
        async function loadBatchFilterCourses() {
            try {
                const resp = await fetch(`${API_BASE}/students/catalog/courses`);
                const payload = await resp.json();
                const courses = payload?.data?.courses || [];

                const sel = document.getElementById('batch-filter-course');
                sel.innerHTML = '<option value="">All Courses</option>' +
                    courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            } catch (err) {
                console.error('Failed to load courses for filter', err);
            }
        }

        // Load batches list
        async function loadBatchesList() {
            const loading = document.getElementById('batches-list-loading');
            const tableContainer = document.getElementById('batches-table-container');
            const tbody = document.getElementById('batches-table-body');

            loading.style.display = 'flex';
            tableContainer.style.display = 'none';

            try {
                const params = new URLSearchParams();
                const courseId = document.getElementById('batch-filter-course').value;
                const batchType = document.getElementById('batch-filter-type').value;
                const isActive = document.getElementById('batch-filter-active').value;
                const search = document.getElementById('batch-filter-search').value;

                if (courseId) params.set('course_id', courseId);
                if (batchType) params.set('batch_type', batchType);
                if (isActive) params.set('is_active', isActive);
                if (search) params.set('search', search);

                const resp = await fetch(`${API_BASE}/batches?${params.toString()}`);
                const payload = await resp.json();
                const batches = payload?.data || [];

                // Update stats
                const totalStudents = batches.reduce((acc, b) => acc + parseInt(b.enrolled_students || 0), 0);
                const activeBatches = batches.filter(b => b.is_active).length;
                document.getElementById('batch-total-count').textContent = batches.length;
                document.getElementById('batch-active-count').textContent = activeBatches;
                document.getElementById('batch-total-students').textContent = totalStudents;
                document.getElementById('batch-list-count').textContent = batches.length;

                // Render table
                tbody.innerHTML = batches.length ? batches.map(b => `
                    <tr>
                        <td><strong>${b.name}</strong></td>
                        <td><code>${b.code || '—'}</code></td>
                        <td>${b.course_name || '—'}</td>
                        <td><span class="badge bg-secondary">${b.batch_type || 'regular'}</span></td>
                        <td>
                            <small>${Array.isArray(b.class_days) ? b.class_days.join(', ') : (b.class_days || '—')}</small><br>
                            <small class="text-muted">${b.start_time || ''} - ${b.end_time || ''}</small>
                        </td>
                        <td>
                            <span class="badge bg-primary">${b.enrolled_students || 0}</span>
                            <small class="text-muted">/ ${b.max_students || '∞'}</small>
                        </td>
                        <td>
                            <span class="status-badge ${b.is_active ? 'active' : 'pending'}">${b.is_active ? 'Active' : 'Inactive'}</span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="viewBatchDetails('${b.id}')" title="View Details"><i class="bi bi-eye"></i></button>
                                <button class="btn btn-outline-primary" onclick="showEditBatchModal('${b.id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-outline-success" onclick="viewBatchStudents('${b.id}')" title="Students"><i class="bi bi-people"></i></button>
                                <button class="btn btn-outline-warning" onclick="viewBatchTimetable('${b.id}')" title="Timetable"><i class="bi bi-calendar3"></i></button>
                                ${b.is_active ? `<button class="btn btn-outline-danger" onclick="deactivateBatch('${b.id}')" title="Deactivate"><i class="bi bi-x-circle"></i></button>` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="8" class="text-center text-muted">No batches found</td></tr>';

            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Failed to load batches</td></tr>';
            }

            loading.style.display = 'none';
            tableContainer.style.display = 'block';
        }

        // Reset batch filters
        function resetBatchFilters() {
            document.getElementById('batch-filter-course').value = '';
            document.getElementById('batch-filter-type').value = '';
            document.getElementById('batch-filter-active').value = 'true';
            document.getElementById('batch-filter-search').value = '';
            loadBatchesList();
        }

        // View batch details
        async function viewBatchDetails(batchId) {
            const panel = document.getElementById('batch-details-panel');
            const content = document.getElementById('batch-details-content');
            panel.style.display = 'block';
            content.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

            try {
                const resp = await fetch(`${API_BASE}/batches/${batchId}`);
                const payload = await resp.json();
                const b = payload?.data;

                // Also fetch syllabus progress
                let syllabusHtml = '<p class="text-muted small">No syllabus data</p>';
                try {
                    const syllResp = await fetch(`${API_BASE}/batches/${batchId}/syllabus-progress`);
                    const syllPayload = await syllResp.json();
                    const syllabus = syllPayload?.data || [];
                    if (syllabus.length) {
                        const completed = syllabus.filter(s => s.status === 'completed').length;
                        const pct = Math.round((completed / syllabus.length) * 100);
                        syllabusHtml = `
                            <div class="progress mb-2" style="height:20px;">
                                <div class="progress-bar bg-success" style="width:${pct}%">${pct}% Complete</div>
                            </div>
                            <small class="text-muted">${completed}/${syllabus.length} topics completed</small>
                        `;
                    }
                } catch (_) {}

                const facultyList = (b.faculty_list || []).filter(f => f && f.faculty_name);

                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-4 border-end">
                            <h5>${b.name}</h5>
                            <p class="mb-1"><strong>Code:</strong> ${b.code || '—'}</p>
                            <p class="mb-1"><strong>Course:</strong> ${b.course_name || '—'} (${b.course_type || ''})</p>
                            <p class="mb-1"><strong>Type:</strong> ${b.batch_type || 'regular'}</p>
                            <p class="mb-1"><strong>Academic Year:</strong> ${b.academic_year || '—'}</p>
                            <p class="mb-1"><strong>Fee:</strong> ₹${formatNumber(b.batch_fee || 0)}</p>
                        </div>
                        <div class="col-md-4 border-end">
                            <h6>Schedule</h6>
                            <p class="mb-1"><strong>Days:</strong> ${Array.isArray(b.class_days) ? b.class_days.join(', ') : (b.class_days || '—')}</p>
                            <p class="mb-1"><strong>Time:</strong> ${b.start_time || '—'} - ${b.end_time || '—'}</p>
                            <p class="mb-1"><strong>Duration:</strong> ${b.start_date ? formatDate(b.start_date) : '—'} to ${b.end_date ? formatDate(b.end_date) : '—'}</p>
                            <h6 class="mt-3">Faculty</h6>
                            <ul class="list-unstyled small">${facultyList.length ? facultyList.map(f => `<li>${f.faculty_name} (${f.subject || '—'})</li>`).join('') : '<li class="text-muted">None assigned</li>'}</ul>
                        </div>
                        <div class="col-md-4">
                            <h6>Enrollment</h6>
                            <p class="mb-1"><strong>Students:</strong> ${b.enrolled_students || 0} / ${b.max_students || '∞'}</p>
                            <h6 class="mt-3">Syllabus Progress</h6>
                            ${syllabusHtml}
                        </div>
                    </div>
                    <hr>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-success" onclick="viewBatchStudents('${batchId}')"><i class="bi bi-people"></i> View Students</button>
                        <button class="btn btn-sm btn-outline-warning" onclick="viewBatchTimetable('${batchId}')"><i class="bi bi-calendar3"></i> Timetable</button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewBatchPerformance('${batchId}')"><i class="bi bi-graph-up"></i> Performance</button>
                        <button class="btn btn-sm btn-outline-primary" onclick="showAddStudentToBatchModal('${batchId}')"><i class="bi bi-person-plus"></i> Add Student</button>
                    </div>
                `;
            } catch (err) {
                content.innerHTML = '<p class="text-danger">Failed to load batch details</p>';
            }
        }

        function closeBatchDetails() {
            document.getElementById('batch-details-panel').style.display = 'none';
        }

        // View batch students modal
        async function viewBatchStudents(batchId) {
            try {
                const resp = await fetch(`${API_BASE}/batches/${batchId}/students`);
                const payload = await resp.json();
                const students = payload?.data || [];

                const modalHtml = `
                    <div class="modal fade" id="batchStudentsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title"><i class="bi bi-people"></i> Students in Batch</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr><th>Roll No</th><th>Name</th><th>Phone</th><th>Status</th><th>Actions</th></tr>
                                        </thead>
                                        <tbody>
                                            ${students.length ? students.map(s => `
                                                <tr>
                                                    <td>${s.roll_number || '—'}</td>
                                                    <td>${s.first_name} ${s.last_name}</td>
                                                    <td>${s.phone || '—'}</td>
                                                    <td><span class="status-badge ${s.status === 'enrolled' ? 'active' : 'pending'}">${s.status || '—'}</span></td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-danger" onclick="removeStudentFromBatch('${batchId}', '${s.id}')"><i class="bi bi-trash"></i></button>
                                                    </td>
                                                </tr>
                                            `).join('') : '<tr><td colspan="5" class="text-center text-muted">No students enrolled</td></tr>'}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-success" onclick="showAddStudentToBatchModal('${batchId}')"><i class="bi bi-person-plus"></i> Add Student</button>
                                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('batchStudentsModal')?.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                new bootstrap.Modal(document.getElementById('batchStudentsModal')).show();
            } catch (err) {
                showToast('Failed to load students', 'error');
            }
        }

        // View batch timetable
        async function viewBatchTimetable(batchId) {
            try {
                const resp = await fetch(`${API_BASE}/batches/${batchId}/timetable`);
                const payload = await resp.json();
                const timetable = payload?.data || [];

                const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const grouped = timetable.reduce((acc, t) => {
                    const day = t.day_of_week || 'Other';
                    if (!acc[day]) acc[day] = [];
                    acc[day].push(t);
                    return acc;
                }, {});

                let tbodyHtml = '';
                dayOrder.forEach(day => {
                    if (grouped[day]) {
                        grouped[day].sort((a, b) => (a.start_time || '').localeCompare(b.start_time || ''));
                        grouped[day].forEach((t, idx) => {
                            tbodyHtml += `
                                <tr>
                                    ${idx === 0 ? `<td rowspan="${grouped[day].length}"><strong>${day}</strong></td>` : ''}
                                    <td>${t.start_time || '—'} - ${t.end_time || '—'}</td>
                                    <td>${t.subject_name || '—'}</td>
                                    <td>${t.faculty_name || '—'}</td>
                                </tr>
                            `;
                        });
                    }
                });

                if (!tbodyHtml) {
                    tbodyHtml = '<tr><td colspan="4" class="text-center text-muted">No timetable configured</td></tr>';
                }

                const modalHtml = `
                    <div class="modal fade" id="batchTimetableModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-warning text-dark">
                                    <h5 class="modal-title"><i class="bi bi-calendar3"></i> Batch Timetable</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <table class="table table-bordered">
                                        <thead class="table-light">
                                            <tr><th>Day</th><th>Time</th><th>Subject</th><th>Faculty</th></tr>
                                        </thead>
                                        <tbody>${tbodyHtml}</tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('batchTimetableModal')?.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                new bootstrap.Modal(document.getElementById('batchTimetableModal')).show();
            } catch (err) {
                showToast('Failed to load timetable', 'error');
            }
        }

        // View batch performance
        async function viewBatchPerformance(batchId) {
            try {
                const resp = await fetch(`${API_BASE}/batches/${batchId}/performance`);
                const payload = await resp.json();
                const performance = payload?.data || [];

                const rowsHtml = performance.length ? performance.map(p => `
                    <tr>
                        <td>${p.exam_name || p.title || '—'}</td>
                        <td>${p.exam_date ? formatDate(p.exam_date) : '—'}</td>
                        <td>${p.avg_percentage || p.average || '—'}%</td>
                        <td>${p.highest || '—'}%</td>
                        <td>${p.lowest || '—'}%</td>
                    </tr>
                `).join('') : '<tr><td colspan="5" class="text-center text-muted">No performance data</td></tr>';

                const modalHtml = `
                    <div class="modal fade" id="batchPerformanceModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-info text-white">
                                    <h5 class="modal-title"><i class="bi bi-graph-up"></i> Batch Performance</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <table class="table table-sm">
                                        <thead class="table-light">
                                            <tr><th>Exam</th><th>Date</th><th>Avg %</th><th>Highest</th><th>Lowest</th></tr>
                                        </thead>
                                        <tbody>${rowsHtml}</tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('batchPerformanceModal')?.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                new bootstrap.Modal(document.getElementById('batchPerformanceModal')).show();
            } catch (err) {
                showToast('Failed to load performance data', 'error');
            }
        }

        // Show Add Batch Modal
        async function showAddBatchModal() {
            // Load courses for dropdown
            let courseOptions = '<option value="">Select Course</option>';
            try {
                const resp = await fetch(`${API_BASE}/students/catalog/courses`);
                const payload = await resp.json();
                const courses = payload?.data?.courses || [];
                courseOptions += courses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            } catch (_) {}

            const modalHtml = `
                <div class="modal fade" id="addBatchModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add New Batch</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addBatchForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Batch Name *</label>
                                            <input type="text" class="form-control" name="name" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Code *</label>
                                            <input type="text" class="form-control" name="code" required placeholder="e.g. JEE2026-M">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Course</label>
                                            <select class="form-select" name="course_id">${courseOptions}</select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Batch Type</label>
                                            <select class="form-select" name="batch_type">
                                                <option value="regular">Regular</option>
                                                <option value="weekend">Weekend</option>
                                                <option value="crash_course">Crash Course</option>
                                                <option value="online">Online</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Start Date *</label>
                                            <input type="date" class="form-control" name="start_date" required>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">End Date</label>
                                            <input type="date" class="form-control" name="end_date">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Academic Year</label>
                                            <input type="text" class="form-control" name="academic_year" placeholder="2025-26">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Class Days</label>
                                            <input type="text" class="form-control" name="class_days" placeholder="Mon, Wed, Fri">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Start Time</label>
                                            <input type="time" class="form-control" name="start_time">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">End Time</label>
                                            <input type="time" class="form-control" name="end_time">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Max Students</label>
                                            <input type="number" class="form-control" name="max_students" value="50">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Batch Fee (₹)</label>
                                            <input type="number" class="form-control" name="batch_fee" placeholder="0">
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button class="btn btn-primary" onclick="submitAddBatch()">Create Batch</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('addBatchModal')?.remove();
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('addBatchModal')).show();
        }

        // Submit add batch
        async function submitAddBatch() {
            const form = document.getElementById('addBatchForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Convert numeric fields
            if (data.max_students) data.max_students = parseInt(data.max_students);
            if (data.batch_fee) data.batch_fee = parseFloat(data.batch_fee);

            // Convert class_days string to array
            if (data.class_days && typeof data.class_days === 'string') {
                data.class_days = data.class_days.split(',').map(d => d.trim()).filter(Boolean);
            }

            try {
                const resp = await fetch(`${API_BASE}/batches`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (resp.ok) {
                    showToast('Batch created successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addBatchModal')).hide();
                    loadBatchesList();
                } else {
                    const err = await resp.json();
                    throw new Error(err.message || 'Failed to create batch');
                }
            } catch (err) {
                showToast(err.message || 'Failed to create batch', 'error');
            }
        }

        // Show Edit Batch Modal
        async function showEditBatchModal(batchId) {
            try {
                const resp = await fetch(`${API_BASE}/batches/${batchId}`);
                const payload = await resp.json();
                const b = payload?.data;

                // Load courses for dropdown
                let courseOptions = '<option value="">Select Course</option>';
                try {
                    const cResp = await fetch(`${API_BASE}/students/catalog/courses`);
                    const cPayload = await cResp.json();
                    const courses = cPayload?.data?.courses || [];
                    courseOptions += courses.map(c => `<option value="${c.id}" ${c.id === b.course_id ? 'selected' : ''}>${c.name}</option>`).join('');
                } catch (_) {}

                const modalHtml = `
                    <div class="modal fade" id="editBatchModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Batch</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editBatchForm">
                                        <input type="hidden" name="id" value="${b.id}">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Batch Name</label>
                                                <input type="text" class="form-control" name="name" value="${b.name || ''}">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Code</label>
                                                <input type="text" class="form-control" name="code" value="${b.code || ''}">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Course</label>
                                                <select class="form-select" name="course_id">${courseOptions}</select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Batch Type</label>
                                                <select class="form-select" name="batch_type">
                                                    <option value="regular" ${b.batch_type === 'regular' ? 'selected' : ''}>Regular</option>
                                                    <option value="weekend" ${b.batch_type === 'weekend' ? 'selected' : ''}>Weekend</option>
                                                    <option value="crash_course" ${b.batch_type === 'crash_course' ? 'selected' : ''}>Crash Course</option>
                                                    <option value="online" ${b.batch_type === 'online' ? 'selected' : ''}>Online</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Start Date</label>
                                                <input type="date" class="form-control" name="start_date" value="${b.start_date ? b.start_date.split('T')[0] : ''}">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">End Date</label>
                                                <input type="date" class="form-control" name="end_date" value="${b.end_date ? b.end_date.split('T')[0] : ''}">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Academic Year</label>
                                                <input type="text" class="form-control" name="academic_year" value="${b.academic_year || ''}">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Class Days</label>
                                                <input type="text" class="form-control" name="class_days" value="${b.class_days || ''}">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Start Time</label>
                                                <input type="time" class="form-control" name="start_time" value="${b.start_time || ''}">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">End Time</label>
                                                <input type="time" class="form-control" name="end_time" value="${b.end_time || ''}">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Max Students</label>
                                                <input type="number" class="form-control" name="max_students" value="${b.max_students || 50}">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Batch Fee (₹)</label>
                                                <input type="number" class="form-control" name="batch_fee" value="${b.batch_fee || 0}">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Status</label>
                                                <select class="form-select" name="is_active">
                                                    <option value="true" ${b.is_active ? 'selected' : ''}>Active</option>
                                                    <option value="false" ${!b.is_active ? 'selected' : ''}>Inactive</option>
                                                </select>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button class="btn btn-primary" onclick="submitEditBatch()">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('editBatchModal')?.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                new bootstrap.Modal(document.getElementById('editBatchModal')).show();
            } catch (err) {
                showToast('Failed to load batch details', 'error');
            }
        }

        // Submit edit batch
        async function submitEditBatch() {
            const form = document.getElementById('editBatchForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const batchId = data.id;
            delete data.id;

            // Convert types
            if (data.max_students) data.max_students = parseInt(data.max_students);
            if (data.batch_fee) data.batch_fee = parseFloat(data.batch_fee);
            if (data.is_active) data.is_active = data.is_active === 'true';

            // Convert class_days string to array
            if (data.class_days && typeof data.class_days === 'string') {
                data.class_days = data.class_days.split(',').map(d => d.trim()).filter(Boolean);
            }

            try {
                const resp = await fetch(`${API_BASE}/batches/${batchId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (resp.ok) {
                    showToast('Batch updated successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editBatchModal')).hide();
                    loadBatchesList();
                    closeBatchDetails();
                } else {
                    const err = await resp.json();
                    throw new Error(err.message || 'Failed to update batch');
                }
            } catch (err) {
                showToast(err.message || 'Failed to update batch', 'error');
            }
        }

        // Deactivate batch
        async function deactivateBatch(batchId) {
            if (!confirm('Are you sure you want to deactivate this batch?')) return;

            try {
                const resp = await fetch(`${API_BASE}/batches/${batchId}`, {
                    method: 'DELETE'
                });

                if (resp.ok) {
                    showToast('Batch deactivated', 'success');
                    loadBatchesList();
                    closeBatchDetails();
                } else {
                    throw new Error('Failed to deactivate');
                }
            } catch (err) {
                showToast(err.message || 'Failed to deactivate batch', 'error');
            }
        }

        // Add student to batch modal
        async function showAddStudentToBatchModal(batchId) {
            await loadStudents(); // ensure fresh list
            const studentOptions = dashboardData.students.map(s => `<option value="${s.id}">${s.first_name} ${s.last_name}</option>`).join('');

            const modalHtml = `
                <div class="modal fade" id="addStudentToBatchModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title"><i class="bi bi-person-plus"></i> Add Student to Batch</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Select Student</label>
                                    <select id="add-student-to-batch-student" class="form-select">
                                        <option value="">Select Student...</option>
                                        ${studentOptions}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Roll Number (optional)</label>
                                    <input type="text" id="add-student-to-batch-roll" class="form-control" placeholder="e.g. 001">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button class="btn btn-success" onclick="submitAddStudentToBatch('${batchId}')">Add Student</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('addStudentToBatchModal')?.remove();
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('addStudentToBatchModal')).show();
        }

        async function submitAddStudentToBatch(batchId) {
            const studentId = document.getElementById('add-student-to-batch-student').value;
            const rollNumber = document.getElementById('add-student-to-batch-roll').value;

            if (!studentId) {
                showToast('Please select a student', 'warning');
                return;
            }

            try {
                const resp = await fetch(`${API_BASE}/batches/${batchId}/students`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_id: studentId, roll_number: rollNumber || null })
                });

                if (resp.ok) {
                    showToast('Student added to batch!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addStudentToBatchModal')).hide();
                    viewBatchStudents(batchId); // refresh students list
                } else {
                    const err = await resp.json();
                    throw new Error(err.message || 'Failed');
                }
            } catch (err) {
                showToast(err.message || 'Failed to add student', 'error');
            }
        }

        // Remove student from batch
        async function removeStudentFromBatch(batchId, studentId) {
            if (!confirm('Remove this student from the batch?')) return;

            try {
                const resp = await fetch(`${API_BASE}/batches/${batchId}/students/${studentId}`, {
                    method: 'DELETE'
                });

                if (resp.ok) {
                    showToast('Student removed from batch', 'success');
                    viewBatchStudents(batchId); // refresh
                } else {
                    throw new Error('Failed');
                }
            } catch (err) {
                showToast('Failed to remove student', 'error');
            }
        }

        // Debounce helper for search
        let debounceTimer;
        function debounceSearch(fn, delay) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(fn, delay);
        }

        // ============================================
        // FEE MANAGEMENT SECTION
        // ============================================

        // Create Fee Management Section DOM (once)
        function ensureFeeManagementSection() {
            if (document.getElementById('fee-management-section')) return;

            const section = document.createElement('div');
            section.id = 'fee-management-section';
            section.style.display = 'none';
            section.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="bi bi-currency-rupee text-success"></i> Fee Management</h3>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" onclick="showRecordPaymentModal()">
                            <i class="bi bi-cash-stack"></i> Record Payment
                        </button>
                        <button class="btn btn-primary" onclick="showCreateFeeModal()">
                            <i class="bi bi-plus-circle"></i> Create Fee Record
                        </button>
                    </div>
                </div>

                <!-- Fee Stats -->
                <div class="stats-grid mb-4">
                    <div class="stat-card revenue">
                        <div class="stat-icon"><i class="bi bi-cash-coin"></i></div>
                        <h3 id="fee-total-collected">₹0</h3>
                        <p>Total Collected (This Month)</p>
                    </div>
                    <div class="stat-card pending">
                        <div class="stat-icon"><i class="bi bi-hourglass-split"></i></div>
                        <h3 id="fee-total-pending">₹0</h3>
                        <p>Pending Amount</p>
                    </div>
                    <div class="stat-card students">
                        <div class="stat-icon"><i class="bi bi-exclamation-triangle"></i></div>
                        <h3 id="fee-overdue-count">0</h3>
                        <p>Overdue Records</p>
                    </div>
                    <div class="stat-card attendance">
                        <div class="stat-icon"><i class="bi bi-calendar-event"></i></div>
                        <h3 id="fee-due-soon">0</h3>
                        <p>Due in 7 Days</p>
                    </div>
                </div>

                <!-- Tabs for different fee views -->
                <ul class="nav nav-tabs mb-3" id="feeTabs">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="loadFeeTab('pending')">Pending Fees</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadFeeTab('overdue')">Overdue Fees</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadFeeTab('payments')">Recent Payments</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadFeeTab('reports')">Reports</a>
                    </li>
                </ul>

                <!-- Fee Content Area -->
                <div class="card">
                    <div class="card-body p-0">
                        <div id="fee-content-loading" class="loading-spinner"><div class="spinner"></div></div>
                        <div id="fee-content-area"></div>
                    </div>
                </div>
            `;
            document.querySelector('.main-content').appendChild(section);
        }

        // Show Fee Management Section
        async function showFeeManagementSection() {
            ensureFeeManagementSection();
            hideAllSections();
            document.getElementById('fee-management-section').style.display = 'block';

            await loadFeeStats();
            await loadFeeTab('pending');
        }

        // Load fee statistics
        async function loadFeeStats() {
            try {
                // Get revenue summary
                const revenueResp = await fetch(`${API_BASE}/fees/reports/revenue`);
                const revenueData = (await revenueResp.json())?.data;
                
                // Get pending fees
                const pendingResp = await fetch(`${API_BASE}/fees/pending`);
                const pendingData = await pendingResp.json();
                const pendingFees = pendingData?.data || [];
                
                // Get overdue fees
                const overdueResp = await fetch(`${API_BASE}/fees/overdue`);
                const overdueData = await overdueResp.json();
                const overdueFees = overdueData?.data || [];
                
                // Get fees due in 7 days
                const dueSoonResp = await fetch(`${API_BASE}/fees/reminder/7`);
                const dueSoonData = await dueSoonResp.json();
                const dueSoonFees = dueSoonData?.data || [];

                // Calculate totals
                const totalPending = pendingFees.reduce((sum, f) => sum + parseFloat(f.balance_amount || 0), 0);
                const totalCollected = revenueData?.total_collected || revenueData?.total || 0;

                document.getElementById('fee-total-collected').textContent = `₹${formatNumber(totalCollected)}`;
                document.getElementById('fee-total-pending').textContent = `₹${formatNumber(totalPending)}`;
                document.getElementById('fee-overdue-count').textContent = overdueFees.length;
                document.getElementById('fee-due-soon').textContent = dueSoonFees.length;
            } catch (err) {
                console.error('Failed to load fee stats:', err);
            }
        }

        // Load fee tab content
        async function loadFeeTab(tab) {
            // Update tab active state
            document.querySelectorAll('#feeTabs .nav-link').forEach(t => t.classList.remove('active'));
            event?.target?.classList.add('active');

            const loading = document.getElementById('fee-content-loading');
            const contentArea = document.getElementById('fee-content-area');
            loading.style.display = 'flex';
            contentArea.innerHTML = '';

            try {
                let html = '';
                
                if (tab === 'pending') {
                    const resp = await fetch(`${API_BASE}/fees/pending`);
                    const data = await resp.json();
                    const fees = data?.data || [];
                    html = renderFeeTable(fees, 'pending');
                } else if (tab === 'overdue') {
                    const resp = await fetch(`${API_BASE}/fees/overdue`);
                    const data = await resp.json();
                    const fees = data?.data || [];
                    html = renderFeeTable(fees, 'overdue');
                } else if (tab === 'payments') {
                    html = await renderRecentPayments();
                } else if (tab === 'reports') {
                    html = await renderFeeReports();
                }

                contentArea.innerHTML = html;
            } catch (err) {
                contentArea.innerHTML = '<p class="text-danger p-3">Failed to load data</p>';
            }

            loading.style.display = 'none';
        }

        // Render fee table
        function renderFeeTable(fees, type) {
            if (!fees.length) {
                return `<p class="text-muted text-center p-4">No ${type} fees found</p>`;
            }

            const rows = fees.map(f => `
                <tr>
                    <td>
                        <strong>${f.student_name || '—'}</strong><br>
                        <small class="text-muted">${f.student_phone || ''}</small>
                    </td>
                    <td>${f.batch_name || '—'}</td>
                    <td>₹${formatNumber(f.net_amount || f.total_amount || 0)}</td>
                    <td>₹${formatNumber(f.paid_amount || 0)}</td>
                    <td><strong class="text-danger">₹${formatNumber(f.balance_amount || 0)}</strong></td>
                    <td>${f.due_date ? formatDate(f.due_date) : '—'}</td>
                    <td>
                        ${type === 'overdue' ? `<span class="badge bg-danger">${f.days_overdue || 0} days</span>` : 
                          `<span class="status-badge ${f.status === 'paid' ? 'active' : 'pending'}">${f.status || 'pending'}</span>`}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-success" onclick="showPaymentModalForFee('${f.id}', '${f.student_id}', ${f.balance_amount || 0})" title="Record Payment">
                                <i class="bi bi-cash"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="viewFeeDetails('${f.id}')" title="View Details">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-warning" onclick="sendFeeReminder('${f.id}')" title="Send Reminder">
                                <i class="bi bi-bell"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Student</th>
                                <th>Batch</th>
                                <th>Total</th>
                                <th>Paid</th>
                                <th>Balance</th>
                                <th>Due Date</th>
                                <th>${type === 'overdue' ? 'Overdue' : 'Status'}</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        // Render recent payments
        async function renderRecentPayments() {
            // For now, show a summary - backend doesn't have a direct recent payments list
            // We'll fetch from fee records that have payments
            try {
                const resp = await fetch(`${API_BASE}/fees/pending`);
                const data = await resp.json();
                const fees = (data?.data || []).filter(f => parseFloat(f.paid_amount || 0) > 0);

                if (!fees.length) {
                    return '<p class="text-muted text-center p-4">No recent payments recorded</p>';
                }

                const rows = fees.slice(0, 20).map(f => `
                    <tr>
                        <td>${f.student_name || '—'}</td>
                        <td>${f.batch_name || '—'}</td>
                        <td class="text-success"><strong>₹${formatNumber(f.paid_amount || 0)}</strong></td>
                        <td>${f.status || '—'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info" onclick="viewFeeDetails('${f.id}')">
                                <i class="bi bi-receipt"></i> View
                            </button>
                        </td>
                    </tr>
                `).join('');

                return `
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Student</th>
                                    <th>Batch</th>
                                    <th>Amount Paid</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                `;
            } catch (err) {
                return '<p class="text-danger p-3">Failed to load payments</p>';
            }
        }

        // Render fee reports
        async function renderFeeReports() {
            try {
                // Get collection by batch
                const collectionResp = await fetch(`${API_BASE}/fees/reports/collection-by-batch`);
                const collectionData = (await collectionResp.json())?.data || [];

                const batchRows = collectionData.length ? collectionData.map(c => `
                    <tr>
                        <td>${c.batch_name || '—'}</td>
                        <td>₹${formatNumber(c.total_fee || 0)}</td>
                        <td class="text-success">₹${formatNumber(c.collected || 0)}</td>
                        <td class="text-danger">₹${formatNumber(c.pending || 0)}</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" style="width: ${c.collection_percent || 0}%">
                                    ${Math.round(c.collection_percent || 0)}%
                                </div>
                            </div>
                        </td>
                    </tr>
                `).join('') : '<tr><td colspan="5" class="text-center text-muted">No data available</td></tr>';

                return `
                    <div class="p-3">
                        <h5 class="mb-3"><i class="bi bi-bar-chart"></i> Collection by Batch</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Batch</th>
                                        <th>Total Fee</th>
                                        <th>Collected</th>
                                        <th>Pending</th>
                                        <th>Progress</th>
                                    </tr>
                                </thead>
                                <tbody>${batchRows}</tbody>
                            </table>
                        </div>
                        
                        <hr class="my-4">
                        
                        <h5 class="mb-3"><i class="bi bi-download"></i> Export Reports</h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="showToast('Export feature coming soon!', 'info')">
                                <i class="bi bi-file-earmark-excel"></i> Export Pending Fees
                            </button>
                            <button class="btn btn-outline-success" onclick="showToast('Export feature coming soon!', 'info')">
                                <i class="bi bi-file-earmark-pdf"></i> Monthly Collection Report
                            </button>
                            <button class="btn btn-outline-danger" onclick="showToast('Export feature coming soon!', 'info')">
                                <i class="bi bi-file-earmark-text"></i> Overdue Report
                            </button>
                        </div>
                    </div>
                `;
            } catch (err) {
                return '<p class="text-danger p-3">Failed to load reports</p>';
            }
        }

        // Show Record Payment Modal
        async function showRecordPaymentModal() {
            await loadStudents();
            const studentOptions = dashboardData.students.map(s => 
                `<option value="${s.id}">${s.first_name} ${s.last_name}</option>`
            ).join('');

            const modalHtml = `
                <div class="modal fade" id="feeRecordPaymentModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title"><i class="bi bi-cash-stack"></i> Record Payment</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="feePaymentForm">
                                    <div class="mb-3">
                                        <label class="form-label">Student *</label>
                                        <select class="form-select" id="payment-student-select" name="student_id" required onchange="loadStudentFees()">
                                            <option value="">Select Student...</option>
                                            ${studentOptions}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Fee Record *</label>
                                        <select class="form-select" id="payment-fee-select" name="student_fee_id" required>
                                            <option value="">Select student first...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Amount (₹) *</label>
                                        <input type="number" class="form-control" name="amount" id="payment-amount" required min="1">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Payment Mode *</label>
                                        <select class="form-select" name="payment_mode" required>
                                            <option value="cash">Cash</option>
                                            <option value="upi">UPI</option>
                                            <option value="card">Card</option>
                                            <option value="bank_transfer">Bank Transfer</option>
                                            <option value="cheque">Cheque</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Transaction ID</label>
                                        <input type="text" class="form-control" name="transaction_id" placeholder="Optional">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Notes</label>
                                        <textarea class="form-control" name="notes" rows="2" placeholder="Optional notes"></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button class="btn btn-success" onclick="submitFeePayment()">
                                    <i class="bi bi-check-circle"></i> Record Payment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('feeRecordPaymentModal')?.remove();
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('feeRecordPaymentModal')).show();
        }

        // Load student fees for payment dropdown
        async function loadStudentFees() {
            const studentId = document.getElementById('payment-student-select').value;
            const feeSelect = document.getElementById('payment-fee-select');
            
            if (!studentId) {
                feeSelect.innerHTML = '<option value="">Select student first...</option>';
                return;
            }

            try {
                const resp = await fetch(`${API_BASE}/students/${studentId}/fees`);
                const data = await resp.json();
                const fees = data?.data || [];

                const pendingFees = fees.filter(f => parseFloat(f.balance_amount || 0) > 0);

                if (!pendingFees.length) {
                    feeSelect.innerHTML = '<option value="">No pending fees</option>';
                    return;
                }

                feeSelect.innerHTML = pendingFees.map(f => 
                    `<option value="${f.id}" data-balance="${f.balance_amount}">
                        ${f.batch_name || 'Fee'} - Balance: ₹${formatNumber(f.balance_amount)}
                    </option>`
                ).join('');

                // Set default amount to balance
                const firstBalance = pendingFees[0]?.balance_amount || 0;
                document.getElementById('payment-amount').value = firstBalance;
            } catch (err) {
                feeSelect.innerHTML = '<option value="">Failed to load fees</option>';
            }
        }

        // Show payment modal for specific fee
        function showPaymentModalForFee(feeId, studentId, balance) {
            const modalHtml = `
                <div class="modal fade" id="quickPaymentModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title"><i class="bi bi-cash"></i> Record Payment</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="quickPaymentForm">
                                    <input type="hidden" name="student_fee_id" value="${feeId}">
                                    <input type="hidden" name="student_id" value="${studentId}">
                                    <div class="alert alert-info">
                                        <strong>Balance Due:</strong> ₹${formatNumber(balance)}
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Amount (₹) *</label>
                                        <input type="number" class="form-control" name="amount" value="${balance}" required min="1" max="${balance}">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Payment Mode *</label>
                                        <select class="form-select" name="payment_mode" required>
                                            <option value="cash">Cash</option>
                                            <option value="upi">UPI</option>
                                            <option value="card">Card</option>
                                            <option value="bank_transfer">Bank Transfer</option>
                                            <option value="cheque">Cheque</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Transaction ID</label>
                                        <input type="text" class="form-control" name="transaction_id">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button class="btn btn-success" onclick="submitQuickPayment()">Record Payment</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('quickPaymentModal')?.remove();
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('quickPaymentModal')).show();
        }

        // Submit fee payment
        async function submitFeePayment() {
            const form = document.getElementById('feePaymentForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            if (!data.student_id || !data.student_fee_id || !data.amount || !data.payment_mode) {
                showToast('Please fill all required fields', 'warning');
                return;
            }

            data.amount = parseFloat(data.amount);

            try {
                const resp = await fetch(`${API_BASE}/fees/payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (resp.ok) {
                    showToast('Payment recorded successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('feeRecordPaymentModal')).hide();
                    loadFeeStats();
                    loadFeeTab('pending');
                } else {
                    const err = await resp.json();
                    throw new Error(err.message || 'Failed to record payment');
                }
            } catch (err) {
                showToast(err.message || 'Failed to record payment', 'error');
            }
        }

        // Submit quick payment
        async function submitQuickPayment() {
            const form = document.getElementById('quickPaymentForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.amount = parseFloat(data.amount);

            try {
                const resp = await fetch(`${API_BASE}/fees/payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (resp.ok) {
                    showToast('Payment recorded successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('quickPaymentModal')).hide();
                    loadFeeStats();
                    loadFeeTab('pending');
                } else {
                    const err = await resp.json();
                    throw new Error(err.message || 'Failed');
                }
            } catch (err) {
                showToast(err.message || 'Failed to record payment', 'error');
            }
        }

        // Show Create Fee Modal
        async function showCreateFeeModal() {
            await loadStudents();
            await loadBatches();

            const studentOptions = dashboardData.students.map(s => 
                `<option value="${s.id}">${s.first_name} ${s.last_name}</option>`
            ).join('');

            const batchOptions = dashboardData.batches.map(b => 
                `<option value="${b.id}" data-fee="${b.batch_fee || 0}">${b.name}</option>`
            ).join('');

            const modalHtml = `
                <div class="modal fade" id="createFeeModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Create Fee Record</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="createFeeForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Student *</label>
                                            <select class="form-select" name="student_id" required>
                                                <option value="">Select Student...</option>
                                                ${studentOptions}
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Batch</label>
                                            <select class="form-select" name="batch_id" onchange="updateFeeAmount(this)">
                                                <option value="">Select Batch...</option>
                                                ${batchOptions}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Total Amount (₹) *</label>
                                            <input type="number" class="form-control" name="total_amount" id="fee-total-amount" required min="0">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Discount (₹)</label>
                                            <input type="number" class="form-control" name="discount_amount" value="0" min="0" onchange="calculateNetAmount()">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Scholarship (₹)</label>
                                            <input type="number" class="form-control" name="scholarship_amount" value="0" min="0" onchange="calculateNetAmount()">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Discount Reason</label>
                                            <input type="text" class="form-control" name="discount_reason" placeholder="e.g., Early bird, Sibling">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Scholarship Name</label>
                                            <input type="text" class="form-control" name="scholarship_name" placeholder="e.g., Merit scholarship">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Due Date *</label>
                                            <input type="date" class="form-control" name="due_date" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Academic Year</label>
                                            <input type="text" class="form-control" name="academic_year" placeholder="e.g., 2025-26">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Notes</label>
                                        <textarea class="form-control" name="notes" rows="2"></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button class="btn btn-primary" onclick="submitCreateFee()">Create Fee Record</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('createFeeModal')?.remove();
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Set default due date to 15 days from now
            const defaultDue = new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            document.querySelector('#createFeeModal [name="due_date"]').value = defaultDue;
            
            new bootstrap.Modal(document.getElementById('createFeeModal')).show();
        }

        // Update fee amount from batch selection
        function updateFeeAmount(select) {
            const selectedOption = select.options[select.selectedIndex];
            const batchFee = selectedOption?.dataset?.fee || 0;
            document.getElementById('fee-total-amount').value = batchFee;
        }

        // Submit create fee
        async function submitCreateFee() {
            const form = document.getElementById('createFeeForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            if (!data.student_id || !data.total_amount || !data.due_date) {
                showToast('Please fill all required fields', 'warning');
                return;
            }

            // Convert numeric fields
            data.total_amount = parseFloat(data.total_amount);
            data.discount_amount = parseFloat(data.discount_amount || 0);
            data.scholarship_amount = parseFloat(data.scholarship_amount || 0);

            try {
                const resp = await fetch(`${API_BASE}/fees`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (resp.ok) {
                    showToast('Fee record created successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createFeeModal')).hide();
                    loadFeeStats();
                    loadFeeTab('pending');
                } else {
                    const err = await resp.json();
                    throw new Error(err.message || 'Failed to create fee record');
                }
            } catch (err) {
                showToast(err.message || 'Failed to create fee record', 'error');
            }
        }

        // View fee details
        async function viewFeeDetails(feeId) {
            try {
                const resp = await fetch(`${API_BASE}/fees/${feeId}`);
                const data = await resp.json();
                const f = data?.data;

                if (!f) {
                    showToast('Fee record not found', 'error');
                    return;
                }

                // Get payment history
                let paymentsHtml = '<p class="text-muted">No payments recorded</p>';
                try {
                    const payResp = await fetch(`${API_BASE}/fees/${feeId}/payments`);
                    const payData = await payResp.json();
                    const payments = payData?.data || [];
                    
                    if (payments.length) {
                        paymentsHtml = `
                            <table class="table table-sm">
                                <thead><tr><th>Date</th><th>Amount</th><th>Mode</th><th>Txn ID</th></tr></thead>
                                <tbody>
                                    ${payments.map(p => `
                                        <tr>
                                            <td>${p.payment_date ? formatDate(p.payment_date) : '—'}</td>
                                            <td class="text-success">₹${formatNumber(p.amount)}</td>
                                            <td>${p.payment_mode || '—'}</td>
                                            <td><small>${p.transaction_id || '—'}</small></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    }
                } catch (_) {}

                const modalHtml = `
                    <div class="modal fade" id="feeDetailsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-info text-white">
                                    <h5 class="modal-title"><i class="bi bi-receipt"></i> Fee Details</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <h6>Student Information</h6>
                                            <p class="mb-1"><strong>Name:</strong> ${f.student_name || '—'}</p>
                                            <p class="mb-1"><strong>Phone:</strong> ${f.student_phone || '—'}</p>
                                            <p class="mb-1"><strong>Father:</strong> ${f.father_name || '—'} (${f.father_phone || '—'})</p>
                                            <p class="mb-1"><strong>Batch:</strong> ${f.batch_name || '—'}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Fee Summary</h6>
                                            <p class="mb-1"><strong>Total Amount:</strong> ₹${formatNumber(f.total_amount || 0)}</p>
                                            <p class="mb-1"><strong>Discount:</strong> ₹${formatNumber(f.discount_amount || 0)} ${f.discount_reason ? `(${f.discount_reason})` : ''}</p>
                                            <p class="mb-1"><strong>Scholarship:</strong> ₹${formatNumber(f.scholarship_amount || 0)} ${f.scholarship_name ? `(${f.scholarship_name})` : ''}</p>
                                            <p class="mb-1"><strong>Net Amount:</strong> ₹${formatNumber(f.net_amount || 0)}</p>
                                            <p class="mb-1"><strong>Paid:</strong> <span class="text-success">₹${formatNumber(f.paid_amount || 0)}</span></p>
                                            <p class="mb-1"><strong>Balance:</strong> <span class="text-danger">₹${formatNumber(f.balance_amount || 0)}</span></p>
                                            <p class="mb-1"><strong>Due Date:</strong> ${f.due_date ? formatDate(f.due_date) : '—'}</p>
                                            <p class="mb-1"><strong>Status:</strong> <span class="badge bg-${f.status === 'paid' ? 'success' : f.status === 'overdue' ? 'danger' : 'warning'}">${f.status || 'pending'}</span></p>
                                        </div>
                                    </div>
                                    <hr>
                                    <h6>Payment History</h6>
                                    ${paymentsHtml}
                                </div>
                                <div class="modal-footer">
                                    ${parseFloat(f.balance_amount || 0) > 0 ? `
                                        <button class="btn btn-success" onclick="bootstrap.Modal.getInstance(document.getElementById('feeDetailsModal')).hide(); showPaymentModalForFee('${f.id}', '${f.student_id}', ${f.balance_amount})">
                                            <i class="bi bi-cash"></i> Record Payment
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('feeDetailsModal')?.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                new bootstrap.Modal(document.getElementById('feeDetailsModal')).show();
            } catch (err) {
                showToast('Failed to load fee details', 'error');
            }
        }

        // Send fee reminder
        function sendFeeReminder(feeId) {
            showToast('Fee reminder sent! (Demo mode)', 'success');
        }

        // ============================================
        // FACULTY MANAGEMENT SECTION
        // ============================================

        // Create Faculty Management Section DOM (once)
        function ensureFacultyManagementSection() {
            if (document.getElementById('faculty-management-section')) return;

            const section = document.createElement('div');
            section.id = 'faculty-management-section';
            section.style.display = 'none';
            section.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="bi bi-person-badge text-primary"></i> Faculty Management</h3>
                    <button class="btn btn-primary" onclick="showAddFacultyModal()">
                        <i class="bi bi-plus-circle"></i> Add Faculty
                    </button>
                </div>

                <!-- Faculty Stats -->
                <div class="stats-grid mb-4">
                    <div class="stat-card students">
                        <div class="stat-icon"><i class="bi bi-people"></i></div>
                        <h3 id="faculty-total-count">0</h3>
                        <p>Total Faculty</p>
                    </div>
                    <div class="stat-card attendance">
                        <div class="stat-icon"><i class="bi bi-person-check"></i></div>
                        <h3 id="faculty-active-count">0</h3>
                        <p>Active Faculty</p>
                    </div>
                    <div class="stat-card pending">
                        <div class="stat-icon"><i class="bi bi-briefcase"></i></div>
                        <h3 id="faculty-fulltime-count">0</h3>
                        <p>Full-Time</p>
                    </div>
                    <div class="stat-card revenue">
                        <div class="stat-icon"><i class="bi bi-clock"></i></div>
                        <h3 id="faculty-parttime-count">0</h3>
                        <p>Part-Time</p>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="faculty-search" placeholder="Search by name, email...">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="faculty-status-filter">
                                    <option value="">All Status</option>
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="faculty-department-filter">
                                    <option value="">All Departments</option>
                                    <option value="Science">Science</option>
                                    <option value="Mathematics">Mathematics</option>
                                    <option value="Physics">Physics</option>
                                    <option value="Chemistry">Chemistry</option>
                                    <option value="Biology">Biology</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="faculty-type-filter">
                                    <option value="">All Types</option>
                                    <option value="full_time">Full-Time</option>
                                    <option value="part_time">Part-Time</option>
                                    <option value="visiting">Visiting</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-primary" onclick="loadFacultyList()">
                                    <i class="bi bi-search"></i> Search
                                </button>
                                <button class="btn btn-outline-secondary" onclick="resetFacultyFilters()">
                                    <i class="bi bi-x-circle"></i> Reset
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Faculty List -->
                <div class="card">
                    <div class="card-body p-0">
                        <div id="faculty-loading" class="loading-spinner"><div class="spinner"></div></div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Faculty</th>
                                        <th>Contact</th>
                                        <th>Department</th>
                                        <th>Specialization</th>
                                        <th>Type</th>
                                        <th>Batches</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="faculty-list-body">
                                    <tr><td colspan="8" class="text-center py-4">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            document.querySelector('.main-content').appendChild(section);
        }

        // Show Faculty Management Section
        async function showFacultyManagementSection() {
            ensureFacultyManagementSection();
            hideAllSections();
            document.getElementById('faculty-management-section').style.display = 'block';

            // Add search listener
            document.getElementById('faculty-search').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') loadFacultyList();
            });

            await loadFacultyStats();
            await loadFacultyList();
        }

        // Load faculty statistics
        async function loadFacultyStats() {
            try {
                const resp = await fetch(`${API_BASE}/faculty`);
                const data = await resp.json();
                const faculty = data?.data || [];

                const active = faculty.filter(f => f.is_active);
                const fullTime = faculty.filter(f => f.employment_type === 'full_time');
                const partTime = faculty.filter(f => f.employment_type === 'part_time' || f.employment_type === 'visiting');

                document.getElementById('faculty-total-count').textContent = faculty.length;
                document.getElementById('faculty-active-count').textContent = active.length;
                document.getElementById('faculty-fulltime-count').textContent = fullTime.length;
                document.getElementById('faculty-parttime-count').textContent = partTime.length;
            } catch (err) {
                console.error('Failed to load faculty stats:', err);
            }
        }

        // Load faculty list
        async function loadFacultyList() {
            const loading = document.getElementById('faculty-loading');
            const tbody = document.getElementById('faculty-list-body');
            loading.style.display = 'flex';

            try {
                const search = document.getElementById('faculty-search').value;
                const status = document.getElementById('faculty-status-filter').value;
                const department = document.getElementById('faculty-department-filter').value;
                const type = document.getElementById('faculty-type-filter').value;

                let url = `${API_BASE}/faculty?`;
                if (search) url += `search=${encodeURIComponent(search)}&`;
                if (status) url += `is_active=${status}&`;
                if (department) url += `department=${encodeURIComponent(department)}&`;

                const resp = await fetch(url);
                const data = await resp.json();
                let faculty = data?.data || [];

                // Client-side filter by type if needed
                if (type) {
                    faculty = faculty.filter(f => f.employment_type === type);
                }

                if (faculty.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No faculty found</td></tr>';
                } else {
                    tbody.innerHTML = faculty.map(f => `
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-sm me-2" style="width:40px;height:40px;border-radius:50%;background:#667eea;color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;">
                                        ${(f.first_name || '?')[0]}${(f.last_name || '?')[0]}
                                    </div>
                                    <div>
                                        <strong>${f.first_name || ''} ${f.last_name || ''}</strong>
                                        ${f.employee_id ? `<br><small class="text-muted">ID: ${f.employee_id}</small>` : ''}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <small>${f.email || '—'}</small><br>
                                <small>${f.phone || '—'}</small>
                            </td>
                            <td>${f.department || '—'}</td>
                            <td>${f.specialization || '—'}</td>
                            <td>
                                <span class="badge bg-${f.employment_type === 'full_time' ? 'primary' : f.employment_type === 'part_time' ? 'info' : 'secondary'}">
                                    ${f.employment_type === 'full_time' ? 'Full-Time' : f.employment_type === 'part_time' ? 'Part-Time' : f.employment_type || 'N/A'}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">${f.batch_count || 0} batches</span>
                            </td>
                            <td>
                                <span class="badge bg-${f.is_active ? 'success' : 'secondary'}">${f.is_active ? 'Active' : 'Inactive'}</span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="viewFacultyDetails('${f.id}')" title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="showEditFacultyModal('${f.id}')" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="showAssignBatchModal('${f.id}')" title="Assign Batch">
                                        <i class="bi bi-collection"></i>
                                    </button>
                                    ${f.is_active ? `
                                        <button class="btn btn-outline-danger" onclick="deactivateFaculty('${f.id}')" title="Deactivate">
                                            <i class="bi bi-person-x"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger py-4">Failed to load faculty</td></tr>';
            }

            loading.style.display = 'none';
        }

        // Reset faculty filters
        function resetFacultyFilters() {
            document.getElementById('faculty-search').value = '';
            document.getElementById('faculty-status-filter').value = '';
            document.getElementById('faculty-department-filter').value = '';
            document.getElementById('faculty-type-filter').value = '';
            loadFacultyList();
        }

        // Show Add Faculty Modal
        function showAddFacultyModal() {
            const modalHtml = `
                <div class="modal fade" id="addFacultyModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title"><i class="bi bi-person-plus"></i> Add New Faculty</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addFacultyForm">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">First Name *</label>
                                            <input type="text" class="form-control" name="first_name" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Last Name *</label>
                                            <input type="text" class="form-control" name="last_name" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Email *</label>
                                            <input type="email" class="form-control" name="email" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Phone *</label>
                                            <input type="tel" class="form-control" name="phone" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Employee ID</label>
                                            <input type="text" class="form-control" name="employee_id">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Designation</label>
                                            <input type="text" class="form-control" name="designation" placeholder="e.g., Senior Lecturer">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Department</label>
                                            <select class="form-select" name="department">
                                                <option value="">Select Department</option>
                                                <option value="Science">Science</option>
                                                <option value="Mathematics">Mathematics</option>
                                                <option value="Physics">Physics</option>
                                                <option value="Chemistry">Chemistry</option>
                                                <option value="Biology">Biology</option>
                                                <option value="English">English</option>
                                                <option value="Computer Science">Computer Science</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Specialization</label>
                                            <input type="text" class="form-control" name="specialization" placeholder="e.g., Organic Chemistry">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Qualification</label>
                                            <input type="text" class="form-control" name="qualification" placeholder="e.g., M.Sc., Ph.D.">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Experience (Years)</label>
                                            <input type="number" class="form-control" name="experience_years" min="0">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Employment Type</label>
                                            <select class="form-select" name="employment_type">
                                                <option value="full_time">Full-Time</option>
                                                <option value="part_time">Part-Time</option>
                                                <option value="visiting">Visiting</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Joining Date</label>
                                            <input type="date" class="form-control" name="joining_date">
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Address</label>
                                            <textarea class="form-control" name="address" rows="2"></textarea>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="submitAddFaculty()">
                                    <i class="bi bi-check-circle"></i> Add Faculty
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('addFacultyModal')?.remove();
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('addFacultyModal')).show();
        }

        // Submit Add Faculty
        async function submitAddFaculty() {
            const form = document.getElementById('addFacultyForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            if (!data.first_name || !data.last_name || !data.email || !data.phone) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            try {
                const resp = await fetch(`${API_BASE}/faculty`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await resp.json();
                if (resp.ok && result.success) {
                    showToast('Faculty added successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addFacultyModal')).hide();
                    await loadFacultyStats();
                    await loadFacultyList();
                } else {
                    throw new Error(result.message || 'Failed to add faculty');
                }
            } catch (err) {
                showToast(err.message || 'Failed to add faculty', 'error');
            }
        }

        // View Faculty Details
        async function viewFacultyDetails(facultyId) {
            try {
                const resp = await fetch(`${API_BASE}/faculty/${facultyId}`);
                const data = await resp.json();
                const f = data?.data;

                if (!f) {
                    showToast('Faculty not found', 'error');
                    return;
                }

                // Get workload if available
                let workloadHtml = '<p class="text-muted">No workload data</p>';
                try {
                    const workloadResp = await fetch(`${API_BASE}/faculty/${facultyId}/workload`);
                    const workloadData = await workloadResp.json();
                    if (workloadData?.data) {
                        const w = workloadData.data;
                        workloadHtml = `
                            <p class="mb-1"><strong>Total Hours/Week:</strong> ${w.total_hours || 0}</p>
                            <p class="mb-1"><strong>Classes/Week:</strong> ${w.classes_per_week || 0}</p>
                            <p class="mb-1"><strong>Students:</strong> ${w.total_students || 0}</p>
                        `;
                    }
                } catch (_) {}

                // Get assigned batches
                let batchesHtml = '<p class="text-muted">No batches assigned</p>';
                if (f.assigned_batches && f.assigned_batches.length > 0 && f.assigned_batches[0]) {
                    batchesHtml = `
                        <ul class="list-unstyled mb-0">
                            ${f.assigned_batches.map(b => `
                                <li class="mb-1">
                                    <i class="bi bi-collection text-primary"></i> 
                                    ${b.batch_name || 'Unknown Batch'} 
                                    ${b.subject ? `<small class="text-muted">(${b.subject})</small>` : ''}
                                </li>
                            `).join('')}
                        </ul>
                    `;
                }

                const modalHtml = `
                    <div class="modal fade" id="facultyDetailsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title"><i class="bi bi-person-badge"></i> Faculty Details</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="border-bottom pb-2 mb-3">Personal Information</h6>
                                            <p class="mb-1"><strong>Name:</strong> ${f.first_name || ''} ${f.last_name || ''}</p>
                                            <p class="mb-1"><strong>Employee ID:</strong> ${f.employee_id || '—'}</p>
                                            <p class="mb-1"><strong>Email:</strong> ${f.email || '—'}</p>
                                            <p class="mb-1"><strong>Phone:</strong> ${f.phone || '—'}</p>
                                            <p class="mb-1"><strong>Address:</strong> ${f.address || '—'}</p>
                                            <p class="mb-1"><strong>Status:</strong> 
                                                <span class="badge bg-${f.is_active ? 'success' : 'secondary'}">${f.is_active ? 'Active' : 'Inactive'}</span>
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="border-bottom pb-2 mb-3">Professional Information</h6>
                                            <p class="mb-1"><strong>Designation:</strong> ${f.designation || '—'}</p>
                                            <p class="mb-1"><strong>Department:</strong> ${f.department || '—'}</p>
                                            <p class="mb-1"><strong>Specialization:</strong> ${f.specialization || '—'}</p>
                                            <p class="mb-1"><strong>Qualification:</strong> ${f.qualification || '—'}</p>
                                            <p class="mb-1"><strong>Experience:</strong> ${f.experience_years ? f.experience_years + ' years' : '—'}</p>
                                            <p class="mb-1"><strong>Employment Type:</strong> 
                                                <span class="badge bg-info">${f.employment_type === 'full_time' ? 'Full-Time' : f.employment_type === 'part_time' ? 'Part-Time' : f.employment_type || 'N/A'}</span>
                                            </p>
                                            <p class="mb-1"><strong>Joining Date:</strong> ${f.joining_date ? formatDate(f.joining_date) : '—'}</p>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="border-bottom pb-2 mb-3">Assigned Batches</h6>
                                            ${batchesHtml}
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="border-bottom pb-2 mb-3">Workload Summary</h6>
                                            ${workloadHtml}
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-warning" onclick="bootstrap.Modal.getInstance(document.getElementById('facultyDetailsModal')).hide(); showEditFacultyModal('${f.id}')">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                    <button class="btn btn-info" onclick="bootstrap.Modal.getInstance(document.getElementById('facultyDetailsModal')).hide(); showAssignBatchModal('${f.id}')">
                                        <i class="bi bi-collection"></i> Assign Batch
                                    </button>
                                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('facultyDetailsModal')?.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                new bootstrap.Modal(document.getElementById('facultyDetailsModal')).show();
            } catch (err) {
                showToast('Failed to load faculty details', 'error');
            }
        }

        // Show Edit Faculty Modal
        async function showEditFacultyModal(facultyId) {
            try {
                const resp = await fetch(`${API_BASE}/faculty/${facultyId}`);
                const data = await resp.json();
                const f = data?.data;

                if (!f) {
                    showToast('Faculty not found', 'error');
                    return;
                }

                const modalHtml = `
                    <div class="modal fade" id="editFacultyModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-warning">
                                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Faculty</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editFacultyForm">
                                        <input type="hidden" name="id" value="${f.id}">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">First Name *</label>
                                                <input type="text" class="form-control" name="first_name" value="${f.first_name || ''}" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Last Name *</label>
                                                <input type="text" class="form-control" name="last_name" value="${f.last_name || ''}" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Email *</label>
                                                <input type="email" class="form-control" name="email" value="${f.email || ''}" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Phone *</label>
                                                <input type="tel" class="form-control" name="phone" value="${f.phone || ''}" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Employee ID</label>
                                                <input type="text" class="form-control" name="employee_id" value="${f.employee_id || ''}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Designation</label>
                                                <input type="text" class="form-control" name="designation" value="${f.designation || ''}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Department</label>
                                                <select class="form-select" name="department">
                                                    <option value="">Select Department</option>
                                                    <option value="Science" ${f.department === 'Science' ? 'selected' : ''}>Science</option>
                                                    <option value="Mathematics" ${f.department === 'Mathematics' ? 'selected' : ''}>Mathematics</option>
                                                    <option value="Physics" ${f.department === 'Physics' ? 'selected' : ''}>Physics</option>
                                                    <option value="Chemistry" ${f.department === 'Chemistry' ? 'selected' : ''}>Chemistry</option>
                                                    <option value="Biology" ${f.department === 'Biology' ? 'selected' : ''}>Biology</option>
                                                    <option value="English" ${f.department === 'English' ? 'selected' : ''}>English</option>
                                                    <option value="Computer Science" ${f.department === 'Computer Science' ? 'selected' : ''}>Computer Science</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Specialization</label>
                                                <input type="text" class="form-control" name="specialization" value="${f.specialization || ''}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Qualification</label>
                                                <input type="text" class="form-control" name="qualification" value="${f.qualification || ''}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Experience (Years)</label>
                                                <input type="number" class="form-control" name="experience_years" value="${f.experience_years || ''}" min="0">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Employment Type</label>
                                                <select class="form-select" name="employment_type">
                                                    <option value="full_time" ${f.employment_type === 'full_time' ? 'selected' : ''}>Full-Time</option>
                                                    <option value="part_time" ${f.employment_type === 'part_time' ? 'selected' : ''}>Part-Time</option>
                                                    <option value="visiting" ${f.employment_type === 'visiting' ? 'selected' : ''}>Visiting</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Joining Date</label>
                                                <input type="date" class="form-control" name="joining_date" value="${f.joining_date ? f.joining_date.split('T')[0] : ''}">
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label">Address</label>
                                                <textarea class="form-control" name="address" rows="2">${f.address || ''}</textarea>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-warning" onclick="submitEditFaculty()">
                                        <i class="bi bi-check-circle"></i> Update Faculty
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('editFacultyModal')?.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                new bootstrap.Modal(document.getElementById('editFacultyModal')).show();
            } catch (err) {
                showToast('Failed to load faculty data', 'error');
            }
        }

        // Submit Edit Faculty
        async function submitEditFaculty() {
            const form = document.getElementById('editFacultyForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            const facultyId = data.id;
            delete data.id;

            try {
                const resp = await fetch(`${API_BASE}/faculty/${facultyId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await resp.json();
                if (resp.ok && result.success) {
                    showToast('Faculty updated successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editFacultyModal')).hide();
                    await loadFacultyList();
                } else {
                    throw new Error(result.message || 'Failed to update faculty');
                }
            } catch (err) {
                showToast(err.message || 'Failed to update faculty', 'error');
            }
        }

        // Show Assign Batch Modal
        async function showAssignBatchModal(facultyId) {
            try {
                // Get batches
                const batchResp = await fetch(`${API_BASE}/batches`);
                const batchData = await batchResp.json();
                const batches = batchData?.data || [];

                const batchOptions = batches.map(b => `<option value="${b.id}">${b.name} (${b.course_name || 'No Course'})</option>`).join('');

                const modalHtml = `
                    <div class="modal fade" id="assignBatchModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-info text-white">
                                    <h5 class="modal-title"><i class="bi bi-collection"></i> Assign to Batch</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="assignBatchForm">
                                        <input type="hidden" name="faculty_id" value="${facultyId}">
                                        <div class="mb-3">
                                            <label class="form-label">Select Batch *</label>
                                            <select class="form-select" name="batch_id" required>
                                                <option value="">Select Batch</option>
                                                ${batchOptions}
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Subject *</label>
                                            <input type="text" class="form-control" name="subject_id" placeholder="Enter subject (e.g., Physics, Chemistry)" required>
                                            <small class="text-muted">Enter the subject this faculty will teach in this batch</small>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" name="is_primary" id="isPrimaryFaculty" checked>
                                            <label class="form-check-label" for="isPrimaryFaculty">Primary Faculty for this subject</label>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-info" onclick="submitAssignBatch()">
                                        <i class="bi bi-check-circle"></i> Assign
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('assignBatchModal')?.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                new bootstrap.Modal(document.getElementById('assignBatchModal')).show();
            } catch (err) {
                showToast('Failed to load batches', 'error');
            }
        }

        // Submit Assign Batch
        async function submitAssignBatch() {
            const form = document.getElementById('assignBatchForm');
            const formData = new FormData(form);
            const facultyId = formData.get('faculty_id');
            
            const data = {
                batch_id: formData.get('batch_id'),
                subject_id: formData.get('subject_id'),
                is_primary: formData.get('is_primary') === 'on'
            };

            if (!data.batch_id || !data.subject_id) {
                showToast('Please select batch and enter subject', 'error');
                return;
            }

            try {
                const resp = await fetch(`${API_BASE}/faculty/${facultyId}/assign-batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await resp.json();
                if (resp.ok && result.success) {
                    showToast('Faculty assigned to batch successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('assignBatchModal')).hide();
                    await loadFacultyList();
                } else {
                    throw new Error(result.message || 'Failed to assign batch');
                }
            } catch (err) {
                showToast(err.message || 'Failed to assign batch', 'error');
            }
        }

        // Deactivate Faculty
        async function deactivateFaculty(facultyId) {
            if (!confirm('Are you sure you want to deactivate this faculty member?')) return;

            try {
                const resp = await fetch(`${API_BASE}/faculty/${facultyId}`, {
                    method: 'DELETE'
                });

                const result = await resp.json();
                if (resp.ok && result.success) {
                    showToast('Faculty deactivated successfully', 'success');
                    await loadFacultyStats();
                    await loadFacultyList();
                } else {
                    throw new Error(result.message || 'Failed to deactivate faculty');
                }
            } catch (err) {
                showToast(err.message || 'Failed to deactivate faculty', 'error');
            }
        }

        // ============================================
        // ATTENDANCE MANAGEMENT SECTION
        // ============================================

        // Create Attendance Section DOM (once)
        function ensureAttendanceSection() {
            if (document.getElementById('attendance-section')) return;

            const section = document.createElement('div');
            section.id = 'attendance-section';
            section.style.display = 'none';
            section.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="bi bi-calendar-check text-success"></i> Attendance Management</h3>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" onclick="showMarkAttendanceModal()">
                            <i class="bi bi-check2-square"></i> Mark Attendance
                        </button>
                        <button class="btn btn-outline-primary" onclick="showAttendanceReport()">
                            <i class="bi bi-file-earmark-bar-graph"></i> Reports
                        </button>
                    </div>
                </div>

                <!-- Attendance Stats -->
                <div class="stats-grid mb-4">
                    <div class="stat-card attendance">
                        <div class="stat-icon"><i class="bi bi-person-check"></i></div>
                        <h3 id="attendance-present-today">0</h3>
                        <p>Present Today</p>
                    </div>
                    <div class="stat-card pending">
                        <div class="stat-icon"><i class="bi bi-person-x"></i></div>
                        <h3 id="attendance-absent-today">0</h3>
                        <p>Absent Today</p>
                    </div>
                    <div class="stat-card students">
                        <div class="stat-icon"><i class="bi bi-exclamation-triangle"></i></div>
                        <h3 id="attendance-low-count">0</h3>
                        <p>Low Attendance (&lt;75%)</p>
                    </div>
                    <div class="stat-card revenue">
                        <div class="stat-icon"><i class="bi bi-graph-up"></i></div>
                        <h3 id="attendance-avg-percent">0%</h3>
                        <p>Overall Average</p>
                    </div>
                </div>

                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3" id="attendanceTabs">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="loadAttendanceTab('today')">Today's Attendance</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadAttendanceTab('batch')">By Batch</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadAttendanceTab('alerts')">Alerts</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadAttendanceTab('history')">History</a>
                    </li>
                </ul>

                <!-- Content Area -->
                <div class="card">
                    <div class="card-body p-0">
                        <div id="attendance-loading" class="loading-spinner"><div class="spinner"></div></div>
                        <div id="attendance-content-area" class="p-3"></div>
                    </div>
                </div>
            `;
            document.querySelector('.main-content').appendChild(section);
        }

        // Show Attendance Section
        async function showAttendanceSection() {
            ensureAttendanceSection();
            hideAllSections();
            document.getElementById('attendance-section').style.display = 'block';

            await loadAttendanceStats();
            await loadAttendanceTab('today');
        }

        // Load attendance statistics
        async function loadAttendanceStats() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // Get today's attendance
                const todayResp = await fetch(`${API_BASE}/attendance?date=${today}`);
                const todayData = await todayResp.json();
                const todayRecords = todayData?.data || [];
                
                const presentToday = todayRecords.filter(a => a.status === 'present').length;
                const absentToday = todayRecords.filter(a => a.status === 'absent').length;

                // Get low attendance students
                const lowResp = await fetch(`${API_BASE}/attendance/alerts/low-attendance?threshold=75`);
                const lowData = await lowResp.json();
                const lowCount = lowData?.count || 0;

                // Calculate average (simplified)
                const total = presentToday + absentToday;
                const avgPercent = total > 0 ? Math.round((presentToday / total) * 100) : 0;

                document.getElementById('attendance-present-today').textContent = presentToday;
                document.getElementById('attendance-absent-today').textContent = absentToday;
                document.getElementById('attendance-low-count').textContent = lowCount;
                document.getElementById('attendance-avg-percent').textContent = avgPercent + '%';
            } catch (err) {
                console.error('Failed to load attendance stats:', err);
            }
        }

        // Load attendance tab content
        async function loadAttendanceTab(tab) {
            // Update active tab
            document.querySelectorAll('#attendanceTabs .nav-link').forEach(t => t.classList.remove('active'));
            event?.target?.classList.add('active');

            const loading = document.getElementById('attendance-loading');
            const contentArea = document.getElementById('attendance-content-area');
            loading.style.display = 'flex';
            contentArea.innerHTML = '';

            try {
                let html = '';
                
                if (tab === 'today') {
                    html = await renderTodayAttendance();
                } else if (tab === 'batch') {
                    html = await renderBatchAttendance();
                } else if (tab === 'alerts') {
                    html = await renderAttendanceAlerts();
                } else if (tab === 'history') {
                    html = await renderAttendanceHistory();
                }

                contentArea.innerHTML = html;
            } catch (err) {
                contentArea.innerHTML = '<p class="text-danger">Failed to load attendance data</p>';
            }

            loading.style.display = 'none';
        }

        // Render Today's Attendance
        async function renderTodayAttendance() {
            const today = new Date().toISOString().split('T')[0];
            
            // Get batches for filter
            const batchResp = await fetch(`${API_BASE}/batches`);
            const batchData = await batchResp.json();
            const batches = batchData?.data || [];

            const batchOptions = batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

            return `
                <div class="mb-3">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="attendance-date" value="${today}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Batch</label>
                            <select class="form-select" id="attendance-batch-filter">
                                <option value="">All Batches</option>
                                ${batchOptions}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary" onclick="filterTodayAttendance()">
                                <i class="bi bi-search"></i> Filter
                            </button>
                        </div>
                    </div>
                </div>
                <div id="today-attendance-list">
                    <p class="text-muted">Select a batch and click Filter to view attendance</p>
                </div>
            `;
        }

        // Filter today's attendance
        async function filterTodayAttendance() {
            const date = document.getElementById('attendance-date').value;
            const batchId = document.getElementById('attendance-batch-filter').value;
            const container = document.getElementById('today-attendance-list');

            if (!batchId) {
                container.innerHTML = '<p class="text-warning">Please select a batch</p>';
                return;
            }

            container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div> Loading...</div>';

            try {
                // Get batch students
                const studentsResp = await fetch(`${API_BASE}/batches/${batchId}/students`);
                const studentsData = await studentsResp.json();
                const students = studentsData?.data || [];

                // Get attendance for this date/batch
                const attResp = await fetch(`${API_BASE}/attendance?date=${date}&batch_id=${batchId}`);
                const attData = await attResp.json();
                const attendance = attData?.data || [];

                // Create a map of student attendance
                const attMap = {};
                attendance.forEach(a => { attMap[a.student_id] = a.status; });

                if (students.length === 0) {
                    container.innerHTML = '<p class="text-muted">No students in this batch</p>';
                    return;
                }

                const present = students.filter(s => attMap[s.id] === 'present').length;
                const absent = students.filter(s => attMap[s.id] === 'absent').length;
                const notMarked = students.length - present - absent;

                container.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="badge bg-success me-2">Present: ${present}</span>
                            <span class="badge bg-danger me-2">Absent: ${absent}</span>
                            <span class="badge bg-secondary">Not Marked: ${notMarked}</span>
                        </div>
                        <button class="btn btn-sm btn-success" onclick="showBulkMarkModal('${batchId}', '${date}')">
                            <i class="bi bi-check2-all"></i> Mark All
                        </button>
                    </div>
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Student</th>
                                <th>Phone</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${students.map(s => `
                                <tr>
                                    <td>
                                        <strong>${s.first_name} ${s.last_name}</strong>
                                        ${s.enrollment_number ? `<br><small class="text-muted">${s.enrollment_number}</small>` : ''}
                                    </td>
                                    <td>${s.phone || '—'}</td>
                                    <td>
                                        <span class="badge bg-${attMap[s.id] === 'present' ? 'success' : attMap[s.id] === 'absent' ? 'danger' : attMap[s.id] === 'late' ? 'warning' : 'secondary'}">
                                            ${attMap[s.id] ? attMap[s.id].charAt(0).toUpperCase() + attMap[s.id].slice(1) : 'Not Marked'}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-success" onclick="quickMarkAttendance('${s.id}', '${batchId}', '${date}', 'present')" title="Present">
                                                <i class="bi bi-check"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="quickMarkAttendance('${s.id}', '${batchId}', '${date}', 'absent')" title="Absent">
                                                <i class="bi bi-x"></i>
                                            </button>
                                            <button class="btn btn-outline-warning" onclick="quickMarkAttendance('${s.id}', '${batchId}', '${date}', 'late')" title="Late">
                                                <i class="bi bi-clock"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                container.innerHTML = '<p class="text-danger">Failed to load attendance</p>';
            }
        }

        // Quick mark attendance for a single student
        async function quickMarkAttendance(studentId, batchId, date, status) {
            try {
                const resp = await fetch(`${API_BASE}/attendance/mark`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        student_id: studentId,
                        batch_id: batchId,
                        attendance_date: date,
                        status: status
                    })
                });

                const result = await resp.json();
                if (resp.ok && result.success) {
                    showToast(`Marked as ${status}`, 'success');
                    await filterTodayAttendance(); // Refresh
                    await loadAttendanceStats();
                } else {
                    throw new Error(result.message || 'Failed');
                }
            } catch (err) {
                showToast('Failed to mark attendance', 'error');
            }
        }

        // Show bulk mark attendance modal
        async function showBulkMarkModal(batchId, date) {
            try {
                // Get batch students
                const studentsResp = await fetch(`${API_BASE}/batches/${batchId}/students`);
                const studentsData = await studentsResp.json();
                const students = studentsData?.data || [];

                // Get existing attendance
                const attResp = await fetch(`${API_BASE}/attendance?date=${date}&batch_id=${batchId}`);
                const attData = await attResp.json();
                const attendance = attData?.data || [];
                const attMap = {};
                attendance.forEach(a => { attMap[a.student_id] = a.status; });

                const modalHtml = `
                    <div class="modal fade" id="bulkMarkModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title"><i class="bi bi-check2-all"></i> Mark Bulk Attendance</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label">Date: <strong>${date}</strong></label>
                                        <div class="d-flex gap-2 mb-3">
                                            <button class="btn btn-sm btn-outline-success" onclick="selectAllStatus('present')">All Present</button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="selectAllStatus('absent')">All Absent</button>
                                        </div>
                                    </div>
                                    <form id="bulkAttendanceForm">
                                        <input type="hidden" name="batch_id" value="${batchId}">
                                        <input type="hidden" name="date" value="${date}">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr><th>Student</th><th>Present</th><th>Absent</th><th>Late</th><th>Leave</th></tr>
                                            </thead>
                                            <tbody>
                                                ${students.map(s => `
                                                    <tr>
                                                        <td>${s.first_name} ${s.last_name}</td>
                                                        <td><input type="radio" name="status_${s.id}" value="present" ${attMap[s.id] === 'present' ? 'checked' : ''} class="form-check-input"></td>
                                                        <td><input type="radio" name="status_${s.id}" value="absent" ${attMap[s.id] === 'absent' ? 'checked' : ''} class="form-check-input"></td>
                                                        <td><input type="radio" name="status_${s.id}" value="late" ${attMap[s.id] === 'late' ? 'checked' : ''} class="form-check-input"></td>
                                                        <td><input type="radio" name="status_${s.id}" value="leave" ${attMap[s.id] === 'leave' ? 'checked' : ''} class="form-check-input"></td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-success" onclick="submitBulkAttendance()">
                                        <i class="bi bi-check-circle"></i> Save Attendance
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('bulkMarkModal')?.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Store students for later use
                window.bulkStudents = students;
                
                new bootstrap.Modal(document.getElementById('bulkMarkModal')).show();
            } catch (err) {
                showToast('Failed to load students', 'error');
            }
        }

        // Select all status helper
        function selectAllStatus(status) {
            document.querySelectorAll(`input[type="radio"][value="${status}"]`).forEach(r => r.checked = true);
        }

        // Submit bulk attendance
        async function submitBulkAttendance() {
            const form = document.getElementById('bulkAttendanceForm');
            const formData = new FormData(form);
            const batchId = formData.get('batch_id');
            const date = formData.get('date');

            const attendanceList = [];
            window.bulkStudents.forEach(s => {
                const status = formData.get(`status_${s.id}`);
                if (status) {
                    attendanceList.push({
                        student_id: s.id,
                        batch_id: batchId,
                        attendance_date: date,
                        status: status
                    });
                }
            });

            if (attendanceList.length === 0) {
                showToast('Please mark attendance for at least one student', 'error');
                return;
            }

            try {
                const resp = await fetch(`${API_BASE}/attendance/mark-bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ attendance_list: attendanceList })
                });

                const result = await resp.json();
                if (resp.ok && result.success) {
                    showToast(`Attendance marked for ${attendanceList.length} students`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('bulkMarkModal')).hide();
                    await filterTodayAttendance();
                    await loadAttendanceStats();
                } else {
                    throw new Error(result.message || 'Failed');
                }
            } catch (err) {
                showToast('Failed to save attendance', 'error');
            }
        }

        // Render Batch Attendance
        async function renderBatchAttendance() {
            const batchResp = await fetch(`${API_BASE}/batches`);
            const batchData = await batchResp.json();
            const batches = batchData?.data || [];

            const batchOptions = batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

            return `
                <div class="mb-3">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">Select Batch</label>
                            <select class="form-select" id="batch-summary-select" onchange="loadBatchSummary()">
                                <option value="">Select Batch</option>
                                ${batchOptions}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="batch-summary-date" value="${new Date().toISOString().split('T')[0]}" onchange="loadBatchSummary()">
                        </div>
                    </div>
                </div>
                <div id="batch-summary-content">
                    <p class="text-muted">Select a batch to view attendance summary</p>
                </div>
            `;
        }

        // Load batch summary
        async function loadBatchSummary() {
            const batchId = document.getElementById('batch-summary-select').value;
            const date = document.getElementById('batch-summary-date').value;
            const container = document.getElementById('batch-summary-content');

            if (!batchId) {
                container.innerHTML = '<p class="text-muted">Select a batch to view summary</p>';
                return;
            }

            container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></div>';

            try {
                const resp = await fetch(`${API_BASE}/attendance/batch/${batchId}/summary?date=${date}`);
                const data = await resp.json();
                const summary = data?.data;

                if (!summary) {
                    container.innerHTML = '<p class="text-muted">No attendance data for this date</p>';
                    return;
                }

                const total = (summary.present || 0) + (summary.absent || 0) + (summary.late || 0) + (summary.leave || 0);
                const presentPct = total > 0 ? Math.round(((summary.present || 0) / total) * 100) : 0;

                container.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5 class="card-title">Summary for ${date}</h5>
                                    <div class="row text-center">
                                        <div class="col-3">
                                            <h3 class="text-success">${summary.present || 0}</h3>
                                            <small>Present</small>
                                        </div>
                                        <div class="col-3">
                                            <h3 class="text-danger">${summary.absent || 0}</h3>
                                            <small>Absent</small>
                                        </div>
                                        <div class="col-3">
                                            <h3 class="text-warning">${summary.late || 0}</h3>
                                            <small>Late</small>
                                        </div>
                                        <div class="col-3">
                                            <h3 class="text-info">${summary.leave || 0}</h3>
                                            <small>Leave</small>
                                        </div>
                                    </div>
                                    <div class="progress mt-3" style="height: 25px;">
                                        <div class="progress-bar bg-success" style="width: ${presentPct}%">${presentPct}%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6>Quick Actions</h6>
                                    <button class="btn btn-success btn-sm me-2" onclick="showBulkMarkModal('${batchId}', '${date}')">
                                        <i class="bi bi-check2-all"></i> Mark Attendance
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="viewBatchAttendanceHistory('${batchId}')">
                                        <i class="bi bi-clock-history"></i> View History
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                container.innerHTML = '<p class="text-danger">Failed to load summary</p>';
            }
        }

        // View batch attendance history
        function viewBatchAttendanceHistory(batchId) {
            document.getElementById('batch-summary-select').value = batchId;
            // Switch to history tab
            loadAttendanceTab('history');
            document.querySelectorAll('#attendanceTabs .nav-link').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#attendanceTabs .nav-link')[3].classList.add('active');
        }

        // Render Attendance Alerts
        async function renderAttendanceAlerts() {
            // Get low attendance
            const lowResp = await fetch(`${API_BASE}/attendance/alerts/low-attendance?threshold=75`);
            const lowData = await lowResp.json();
            const lowAttendance = lowData?.data || [];

            // Get today's absentees
            const absentResp = await fetch(`${API_BASE}/attendance/alerts/absentees`);
            const absentData = await absentResp.json();
            const absentees = absentData?.data || [];

            // Get consecutive absences
            const consResp = await fetch(`${API_BASE}/attendance/alerts/consecutive?days=3`);
            const consData = await consResp.json();
            const consecutive = consData?.data || [];

            return `
                <div class="row">
                    <div class="col-md-4">
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white">
                                <i class="bi bi-exclamation-triangle"></i> Low Attendance (&lt;75%)
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                ${lowAttendance.length === 0 ? '<p class="text-muted mb-0">No students with low attendance</p>' : `
                                    <ul class="list-unstyled mb-0">
                                        ${lowAttendance.map(s => `
                                            <li class="mb-2 pb-2 border-bottom">
                                                <strong>${s.student_name || s.first_name + ' ' + s.last_name}</strong>
                                                <br><small class="text-danger">${s.attendance_percentage || s.percentage || 0}% attendance</small>
                                                ${s.batch_name ? `<br><small class="text-muted">${s.batch_name}</small>` : ''}
                                            </li>
                                        `).join('')}
                                    </ul>
                                `}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-warning">
                            <div class="card-header bg-warning">
                                <i class="bi bi-person-x"></i> Today's Absentees
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                ${absentees.length === 0 ? '<p class="text-muted mb-0">No absentees today</p>' : `
                                    <ul class="list-unstyled mb-0">
                                        ${absentees.map(s => `
                                            <li class="mb-2 pb-2 border-bottom">
                                                <strong>${s.student_name || s.first_name + ' ' + s.last_name}</strong>
                                                ${s.batch_name ? `<br><small class="text-muted">${s.batch_name}</small>` : ''}
                                                <br>
                                                <button class="btn btn-xs btn-outline-primary mt-1" onclick="sendAbsenteeAlert('${s.student_id || s.id}')">
                                                    <i class="bi bi-bell"></i> Notify
                                                </button>
                                            </li>
                                        `).join('')}
                                    </ul>
                                `}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <i class="bi bi-calendar-x"></i> 3+ Consecutive Absences
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                ${consecutive.length === 0 ? '<p class="text-muted mb-0">No consecutive absences</p>' : `
                                    <ul class="list-unstyled mb-0">
                                        ${consecutive.map(s => `
                                            <li class="mb-2 pb-2 border-bottom">
                                                <strong>${s.student_name || s.first_name + ' ' + s.last_name}</strong>
                                                <br><small class="text-danger">${s.consecutive_days || s.days || 3}+ days absent</small>
                                            </li>
                                        `).join('')}
                                    </ul>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Send absentee alert
        function sendAbsenteeAlert(studentId) {
            showToast('Absence notification sent to parent! (Demo)', 'success');
        }

        // Render Attendance History
        async function renderAttendanceHistory() {
            const batchResp = await fetch(`${API_BASE}/batches`);
            const batchData = await batchResp.json();
            const batches = batchData?.data || [];

            const batchOptions = batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

            const today = new Date();
            const lastMonth = new Date(today.setMonth(today.getMonth() - 1)).toISOString().split('T')[0];
            const todayStr = new Date().toISOString().split('T')[0];

            return `
                <div class="mb-3">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">Batch</label>
                            <select class="form-select" id="history-batch">
                                <option value="">All Batches</option>
                                ${batchOptions}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">From</label>
                            <input type="date" class="form-control" id="history-from" value="${lastMonth}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">To</label>
                            <input type="date" class="form-control" id="history-to" value="${todayStr}">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary" onclick="loadAttendanceHistory()">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-success" onclick="exportAttendanceReport()">
                                <i class="bi bi-download"></i> Export Report
                            </button>
                        </div>
                    </div>
                </div>
                <div id="history-content">
                    <p class="text-muted">Click Search to load attendance history</p>
                </div>
            `;
        }

        // Load attendance history
        async function loadAttendanceHistory() {
            const batchId = document.getElementById('history-batch').value;
            const fromDate = document.getElementById('history-from').value;
            const toDate = document.getElementById('history-to').value;
            const container = document.getElementById('history-content');

            container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></div>';

            try {
                let url = `${API_BASE}/attendance/report?start_date=${fromDate}&end_date=${toDate}`;
                if (batchId) url += `&batch_id=${batchId}`;

                const resp = await fetch(url);
                const data = await resp.json();
                const report = data?.data;

                if (!report || (Array.isArray(report) && report.length === 0)) {
                    container.innerHTML = '<p class="text-muted">No attendance records found for this period</p>';
                    return;
                }

                // If report is an array of records
                if (Array.isArray(report)) {
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Student</th>
                                        <th>Batch</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${report.slice(0, 100).map(r => `
                                        <tr>
                                            <td>${r.attendance_date ? formatDate(r.attendance_date) : '—'}</td>
                                            <td>${r.student_name || '—'}</td>
                                            <td>${r.batch_name || '—'}</td>
                                            <td>
                                                <span class="badge bg-${r.status === 'present' ? 'success' : r.status === 'absent' ? 'danger' : r.status === 'late' ? 'warning' : 'secondary'}">
                                                    ${r.status || '—'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${report.length > 100 ? `<p class="text-muted">Showing first 100 of ${report.length} records</p>` : ''}
                    `;
                } else {
                    // Summary format
                    container.innerHTML = `
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5>Attendance Summary (${fromDate} to ${toDate})</h5>
                                <div class="row text-center mt-3">
                                    <div class="col-3">
                                        <h3 class="text-success">${report.total_present || 0}</h3>
                                        <small>Present</small>
                                    </div>
                                    <div class="col-3">
                                        <h3 class="text-danger">${report.total_absent || 0}</h3>
                                        <small>Absent</small>
                                    </div>
                                    <div class="col-3">
                                        <h3 class="text-warning">${report.total_late || 0}</h3>
                                        <small>Late</small>
                                    </div>
                                    <div class="col-3">
                                        <h3 class="text-primary">${report.average_percentage || 0}%</h3>
                                        <small>Average</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (err) {
                container.innerHTML = '<p class="text-danger">Failed to load attendance history</p>';
            }
        }

        // Export attendance report
        function exportAttendanceReport() {
            showToast('Attendance report exported! (Demo mode)', 'success');
        }

        // Show Mark Attendance Modal
        async function showMarkAttendanceModal() {
            const batchResp = await fetch(`${API_BASE}/batches`);
            const batchData = await batchResp.json();
            const batches = batchData?.data || [];
            const batchOptions = batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

            const modalHtml = `
                <div class="modal fade" id="markAttendanceModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title"><i class="bi bi-check2-square"></i> Mark Attendance</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="markAttendanceForm">
                                    <div class="mb-3">
                                        <label class="form-label">Batch *</label>
                                        <select class="form-select" name="batch_id" required>
                                            <option value="">Select Batch</option>
                                            ${batchOptions}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Date *</label>
                                        <input type="date" class="form-control" name="date" value="${new Date().toISOString().split('T')[0]}" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-success" onclick="proceedToMarkAttendance()">
                                    <i class="bi bi-arrow-right"></i> Proceed
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('markAttendanceModal')?.remove();
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('markAttendanceModal')).show();
        }

        // Proceed to mark attendance
        function proceedToMarkAttendance() {
            const form = document.getElementById('markAttendanceForm');
            const batchId = form.batch_id.value;
            const date = form.date.value;

            if (!batchId || !date) {
                showToast('Please select batch and date', 'error');
                return;
            }

            bootstrap.Modal.getInstance(document.getElementById('markAttendanceModal')).hide();
            showBulkMarkModal(batchId, date);
        }

        // Show attendance report modal
        async function showAttendanceReport() {
            const batchResp = await fetch(`${API_BASE}/batches`);
            const batchData = await batchResp.json();
            const batches = batchData?.data || [];
            const batchOptions = batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

            const modalHtml = `
                <div class="modal fade" id="attendanceReportModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title"><i class="bi bi-file-earmark-bar-graph"></i> Attendance Report</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Batch</label>
                                        <select class="form-select" id="report-batch">
                                            <option value="">All Batches</option>
                                            ${batchOptions}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">From</label>
                                        <input type="date" class="form-control" id="report-from">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">To</label>
                                        <input type="date" class="form-control" id="report-to">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">&nbsp;</label>
                                        <button class="btn btn-primary w-100" onclick="generateAttendanceReport()">Generate</button>
                                    </div>
                                </div>
                                <div id="report-result">
                                    <p class="text-muted">Select filters and click Generate</p>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('attendanceReportModal')?.remove();
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('attendanceReportModal')).show();
        }

        // Generate attendance report
        async function generateAttendanceReport() {
            const batchId = document.getElementById('report-batch').value;
            const fromDate = document.getElementById('report-from').value;
            const toDate = document.getElementById('report-to').value;
            const container = document.getElementById('report-result');

            container.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div></div>';

            try {
                let url = `${API_BASE}/attendance/report?`;
                if (fromDate) url += `start_date=${fromDate}&`;
                if (toDate) url += `end_date=${toDate}&`;
                if (batchId) url += `batch_id=${batchId}`;

                const resp = await fetch(url);
                const data = await resp.json();

                container.innerHTML = `
                    <div class="alert alert-info">
                        <h6>Report Generated</h6>
                        <p class="mb-0">Total Records: ${data?.data?.length || 0}</p>
                    </div>
                `;
            } catch (err) {
                container.innerHTML = '<p class="text-danger">Failed to generate report</p>';
            }
        }

        // ============================================
        // EXAMS & RESULTS SECTION
        // ============================================

        // Create Exams Section DOM (once)
        function ensureExamsSection() {
            if (document.getElementById('exams-section')) return;

            const section = document.createElement('div');
            section.id = 'exams-section';
            section.style.display = 'none';
            section.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="bi bi-journal-check text-primary"></i> Exams & Results</h3>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="showCreateExamModal()">
                            <i class="bi bi-plus-circle"></i> Create Exam
                        </button>
                        <button class="btn btn-success" onclick="showUploadResultsModal()">
                            <i class="bi bi-upload"></i> Upload Results
                        </button>
                    </div>
                </div>

                <!-- Exam Stats -->
                <div class="stats-grid mb-4">
                    <div class="stat-card students">
                        <div class="stat-icon"><i class="bi bi-calendar-event"></i></div>
                        <h3 id="exams-upcoming-count">0</h3>
                        <p>Upcoming Exams</p>
                    </div>
                    <div class="stat-card attendance">
                        <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
                        <h3 id="exams-completed-count">0</h3>
                        <p>Completed</p>
                    </div>
                    <div class="stat-card pending">
                        <div class="stat-icon"><i class="bi bi-hourglass-split"></i></div>
                        <h3 id="exams-pending-results">0</h3>
                        <p>Pending Results</p>
                    </div>
                    <div class="stat-card revenue">
                        <div class="stat-icon"><i class="bi bi-graph-up"></i></div>
                        <h3 id="exams-avg-score">—</h3>
                        <p>Avg. Score</p>
                    </div>
                </div>

                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3" id="examsTabs">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="loadExamsTab('upcoming')">Upcoming Exams</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadExamsTab('all')">All Exams</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadExamsTab('results')">Results</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadExamsTab('analytics')">Analytics</a>
                    </li>
                </ul>

                <!-- Content Area -->
                <div class="card">
                    <div class="card-body p-0">
                        <div id="exams-loading" class="loading-spinner"><div class="spinner"></div></div>
                        <div id="exams-content-area" class="p-3"></div>
                    </div>
                </div>
            `;
            document.querySelector('.main-content').appendChild(section);
        }

        // Show Exams Section
        async function showExamsSection() {
            ensureExamsSection();
            hideAllSections();
            document.getElementById('exams-section').style.display = 'block';

            await loadExamsStats();
            await loadExamsTab('upcoming');
        }

        // Load exam statistics
        async function loadExamsStats() {
            try {
                // Get all exams
                const allResp = await fetch(`${API_BASE}/exams`);
                const allData = await allResp.json();
                const allExams = allData?.data || [];

                // Get upcoming exams
                const upcomingResp = await fetch(`${API_BASE}/exams/upcoming?days=30`);
                const upcomingData = await upcomingResp.json();
                const upcoming = upcomingData?.data || [];

                const completed = allExams.filter(e => e.status === 'completed' || e.status === 'published');
                const pendingResults = allExams.filter(e => e.status === 'completed' && !e.results_published);

                document.getElementById('exams-upcoming-count').textContent = upcoming.length;
                document.getElementById('exams-completed-count').textContent = completed.length;
                document.getElementById('exams-pending-results').textContent = pendingResults.length;
                document.getElementById('exams-avg-score').textContent = '—';
            } catch (err) {
                console.error('Failed to load exam stats:', err);
            }
        }

        // Load exams tab content
        async function loadExamsTab(tab) {
            // Update active tab
            document.querySelectorAll('#examsTabs .nav-link').forEach(t => t.classList.remove('active'));
            event?.target?.classList.add('active');

            const loading = document.getElementById('exams-loading');
            const contentArea = document.getElementById('exams-content-area');
            loading.style.display = 'flex';
            contentArea.innerHTML = '';

            try {
                let html = '';
                
                if (tab === 'upcoming') {
                    html = await renderUpcomingExams();
                } else if (tab === 'all') {
                    html = await renderAllExams();
                } else if (tab === 'results') {
                    html = await renderExamResults();
                } else if (tab === 'analytics') {
                    html = await renderExamAnalytics();
                }

                contentArea.innerHTML = html;
            } catch (err) {
                contentArea.innerHTML = '<p class="text-danger p-3">Failed to load data</p>';
            }

            loading.style.display = 'none';
        }

        // Render Upcoming Exams
        async function renderUpcomingExams() {
            const resp = await fetch(`${API_BASE}/exams/upcoming?days=30`);
            const data = await resp.json();
            const exams = data?.data || [];

            if (exams.length === 0) {
                return `
                    <div class="text-center py-5">
                        <i class="bi bi-calendar-x display-4 text-muted"></i>
                        <p class="text-muted mt-2">No upcoming exams scheduled</p>
                        <button class="btn btn-primary" onclick="showCreateExamModal()">
                            <i class="bi bi-plus-circle"></i> Schedule an Exam
                        </button>
                    </div>
                `;
            }

            return `
                <div class="row">
                    ${exams.map(e => `
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100 border-primary">
                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-journal-text"></i> ${e.name}</span>
                                    <span class="badge bg-light text-primary">${e.exam_type || 'Exam'}</span>
                                </div>
                                <div class="card-body">
                                    <p class="mb-2"><i class="bi bi-calendar"></i> <strong>Date:</strong> ${e.exam_date ? formatDate(e.exam_date) : '—'}</p>
                                    <p class="mb-2"><i class="bi bi-clock"></i> <strong>Time:</strong> ${e.start_time || '—'} - ${e.end_time || '—'}</p>
                                    <p class="mb-2"><i class="bi bi-collection"></i> <strong>Batch:</strong> ${e.batch_name || 'All Batches'}</p>
                                    <p class="mb-2"><i class="bi bi-award"></i> <strong>Total Marks:</strong> ${e.total_marks || '—'}</p>
                                    <p class="mb-0"><i class="bi bi-geo-alt"></i> <strong>Venue:</strong> ${e.venue || 'TBD'}</p>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <div class="btn-group btn-group-sm w-100">
                                        <button class="btn btn-outline-primary" onclick="viewExamDetails('${e.id}')">
                                            <i class="bi bi-eye"></i> View
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="showEditExamModal('${e.id}')">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Render All Exams
        async function renderAllExams() {
            // Get batches for filter
            const batchResp = await fetch(`${API_BASE}/batches`);
            const batchData = await batchResp.json();
            const batches = batchData?.data || [];
            const batchOptions = batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

            return `
                <div class="mb-3">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-2">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="exam-type-filter">
                                <option value="">All Types</option>
                                <option value="weekly_test">Weekly Test</option>
                                <option value="monthly_test">Monthly Test</option>
                                <option value="unit_test">Unit Test</option>
                                <option value="mock_exam">Mock Exam</option>
                                <option value="practice_test">Practice Test</option>
                                <option value="final_exam">Final Exam</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Batch</label>
                            <select class="form-select" id="exam-batch-filter">
                                <option value="">All Batches</option>
                                ${batchOptions}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="exam-status-filter">
                                <option value="">All Status</option>
                                <option value="scheduled">Scheduled</option>
                                <option value="ongoing">Ongoing</option>
                                <option value="completed">Completed</option>
                                <option value="published">Published</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary" onclick="filterExams()">
                                <i class="bi bi-search"></i> Filter
                            </button>
                        </div>
                    </div>
                </div>
                <div id="exams-list-container">
                    <p class="text-muted">Click Filter to load exams</p>
                </div>
            `;
        }

        // Filter exams
        async function filterExams() {
            const type = document.getElementById('exam-type-filter').value;
            const batchId = document.getElementById('exam-batch-filter').value;
            const status = document.getElementById('exam-status-filter').value;
            const container = document.getElementById('exams-list-container');

            container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></div>';

            try {
                let url = `${API_BASE}/exams?`;
                if (type) url += `exam_type=${type}&`;
                if (batchId) url += `batch_id=${batchId}&`;
                if (status) url += `status=${status}`;

                const resp = await fetch(url);
                const data = await resp.json();
                const exams = data?.data || [];

                if (exams.length === 0) {
                    container.innerHTML = '<p class="text-muted">No exams found</p>';
                    return;
                }

                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Exam Name</th>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Batch</th>
                                    <th>Total Marks</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${exams.map(e => `
                                    <tr>
                                        <td><strong>${e.name}</strong></td>
                                        <td><span class="badge bg-info">${e.exam_type || 'N/A'}</span></td>
                                        <td>${e.exam_date ? formatDate(e.exam_date) : '—'}</td>
                                        <td>${e.batch_name || 'All'}</td>
                                        <td>${e.total_marks || '—'}</td>
                                        <td>
                                            <span class="badge bg-${e.status === 'published' ? 'success' : e.status === 'completed' ? 'primary' : e.status === 'scheduled' ? 'warning' : e.status === 'cancelled' ? 'danger' : 'secondary'}">
                                                ${e.status || 'scheduled'}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" onclick="viewExamDetails('${e.id}')" title="View">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-success" onclick="showEnterResultsModal('${e.id}')" title="Enter Results">
                                                    <i class="bi bi-pencil-square"></i>
                                                </button>
                                                <button class="btn btn-outline-info" onclick="viewExamResults('${e.id}')" title="View Results">
                                                    <i class="bi bi-bar-chart"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (err) {
                container.innerHTML = '<p class="text-danger">Failed to load exams</p>';
            }
        }

        // Render Exam Results Tab
        async function renderExamResults() {
            const resp = await fetch(`${API_BASE}/exams?status=completed`);
            const data = await resp.json();
            let exams = data?.data || [];

            // Also include published
            const pubResp = await fetch(`${API_BASE}/exams?status=published`);
            const pubData = await pubResp.json();
            exams = [...exams, ...(pubData?.data || [])];

            if (exams.length === 0) {
                return `
                    <div class="text-center py-5">
                        <i class="bi bi-clipboard-x display-4 text-muted"></i>
                        <p class="text-muted mt-2">No exam results available yet</p>
                    </div>
                `;
            }

            return `
                <div class="mb-3">
                    <label class="form-label">Select Exam to View Results</label>
                    <select class="form-select" id="results-exam-select" onchange="loadExamResultsForSelect()">
                        <option value="">Select Exam</option>
                        ${exams.map(e => `<option value="${e.id}">${e.name} (${e.exam_date ? formatDate(e.exam_date) : '—'})</option>`).join('')}
                    </select>
                </div>
                <div id="exam-results-container">
                    <p class="text-muted">Select an exam to view results</p>
                </div>
            `;
        }

        // Load exam results for selected exam
        async function loadExamResultsForSelect() {
            const examId = document.getElementById('results-exam-select').value;
            const container = document.getElementById('exam-results-container');

            if (!examId) {
                container.innerHTML = '<p class="text-muted">Select an exam to view results</p>';
                return;
            }

            container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></div>';

            try {
                const resp = await fetch(`${API_BASE}/exams/${examId}/results`);
                const data = await resp.json();
                const results = data?.data || [];

                // Get exam details
                const examResp = await fetch(`${API_BASE}/exams/${examId}`);
                const examData = await examResp.json();
                const exam = examData?.data;

                if (results.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <p class="mb-2">No results entered for this exam yet.</p>
                            <button class="btn btn-success btn-sm" onclick="showEnterResultsModal('${examId}')">
                                <i class="bi bi-plus-circle"></i> Enter Results
                            </button>
                        </div>
                    `;
                    return;
                }

                // Calculate stats
                const totalMarks = exam?.total_marks || 100;
                const scores = results.map(r => parseFloat(r.marks_obtained) || 0);
                const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;
                const maxScore = Math.max(...scores);
                const minScore = Math.min(...scores);
                const passCount = results.filter(r => (parseFloat(r.marks_obtained) / totalMarks) >= 0.4).length;

                container.innerHTML = `
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="text-primary">${avgScore.toFixed(1)}</h4>
                                    <small>Average Score</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="text-success">${maxScore}</h4>
                                    <small>Highest Score</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="text-danger">${minScore}</h4>
                                    <small>Lowest Score</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="text-info">${passCount}/${results.length}</h4>
                                    <small>Pass Rate</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <h6>Results (${results.length} students)</h6>
                        <div>
                            ${!exam?.results_published ? `
                                <button class="btn btn-success btn-sm me-2" onclick="publishResults('${examId}')">
                                    <i class="bi bi-megaphone"></i> Publish Results
                                </button>
                            ` : '<span class="badge bg-success">Published</span>'}
                            <button class="btn btn-outline-primary btn-sm" onclick="exportResults('${examId}')">
                                <i class="bi bi-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Rank</th>
                                    <th>Student</th>
                                    <th>Marks</th>
                                    <th>Percentage</th>
                                    <th>Grade</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${results.sort((a, b) => (b.marks_obtained || 0) - (a.marks_obtained || 0)).map((r, idx) => {
                                    const pct = ((r.marks_obtained || 0) / totalMarks * 100);
                                    const grade = pct >= 90 ? 'A+' : pct >= 80 ? 'A' : pct >= 70 ? 'B' : pct >= 60 ? 'C' : pct >= 40 ? 'D' : 'F';
                                    const status = pct >= 40 ? 'Pass' : 'Fail';
                                    return `
                                        <tr>
                                            <td><strong>#${idx + 1}</strong></td>
                                            <td>${r.student_name || 'Unknown'}</td>
                                            <td>${r.marks_obtained || 0} / ${totalMarks}</td>
                                            <td>${pct.toFixed(1)}%</td>
                                            <td><span class="badge bg-${grade === 'A+' || grade === 'A' ? 'success' : grade === 'B' || grade === 'C' ? 'primary' : grade === 'D' ? 'warning' : 'danger'}">${grade}</span></td>
                                            <td><span class="badge bg-${status === 'Pass' ? 'success' : 'danger'}">${status}</span></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (err) {
                container.innerHTML = '<p class="text-danger">Failed to load results</p>';
            }
        }

        // Render Exam Analytics Tab
        async function renderExamAnalytics() {
            return `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Performance Trend</h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Select an exam to view analytics</p>
                                <select class="form-select mb-3" id="analytics-exam-select" onchange="loadExamAnalytics()">
                                    <option value="">Select Exam</option>
                                </select>
                                <div id="analytics-chart-area">
                                    <p class="text-muted text-center">No data available</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-pie-chart"></i> Grade Distribution</h6>
                            </div>
                            <div class="card-body">
                                <div id="grade-distribution-area">
                                    <p class="text-muted text-center">Select an exam to view grade distribution</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-trophy"></i> Top Performers</h6>
                            </div>
                            <div class="card-body" id="top-performers-area">
                                <p class="text-muted text-center">Select an exam to view top performers</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load exam analytics
        async function loadExamAnalytics() {
            const examId = document.getElementById('analytics-exam-select').value;
            if (!examId) return;

            try {
                const resp = await fetch(`${API_BASE}/exams/${examId}/analytics`);
                const data = await resp.json();
                const analytics = data?.data;

                if (analytics) {
                    document.getElementById('analytics-chart-area').innerHTML = `
                        <div class="text-center">
                            <h4>${analytics.average_score?.toFixed(1) || 0}%</h4>
                            <p class="text-muted">Average Score</p>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Failed to load analytics:', err);
            }
        }

        // Show Create Exam Modal
        async function showCreateExamModal() {
            const batchResp = await fetch(`${API_BASE}/batches`);
            const batchData = await batchResp.json();
            const batches = batchData?.data || [];
            const batchOptions = batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

            const modalHtml = `
                <div class="modal fade" id="createExamModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Create New Exam</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="createExamForm">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Exam Name *</label>
                                            <input type="text" class="form-control" name="name" required placeholder="e.g., Mid-Term Physics">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Exam Type *</label>
                                            <select class="form-select" name="exam_type" required>
                                                <option value="">Select Type</option>
                                                <option value="weekly_test">Weekly Test</option>
                                                <option value="monthly_test">Monthly Test</option>
                                                <option value="unit_test">Unit Test</option>
                                                <option value="mock_exam">Mock Exam</option>
                                                <option value="practice_test">Practice Test</option>
                                                <option value="final_exam">Final Exam</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Exam Date *</label>
                                            <input type="date" class="form-control" name="exam_date" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Start Time</label>
                                            <input type="time" class="form-control" name="start_time">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">End Time</label>
                                            <input type="time" class="form-control" name="end_time">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Batch</label>
                                            <select class="form-select" name="batch_id">
                                                <option value="">All Batches</option>
                                                ${batchOptions}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Total Marks *</label>
                                            <input type="number" class="form-control" name="total_marks" required min="1" value="100">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Passing Marks</label>
                                            <input type="number" class="form-control" name="passing_marks" min="0" value="40">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Subject</label>
                                            <input type="text" class="form-control" name="subject" placeholder="e.g., Physics">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Venue</label>
                                            <input type="text" class="form-control" name="venue" placeholder="e.g., Hall A">
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Instructions</label>
                                            <textarea class="form-control" name="instructions" rows="2" placeholder="Special instructions for students..."></textarea>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="submitCreateExam()">
                                    <i class="bi bi-check-circle"></i> Create Exam
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('createExamModal')?.remove();
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('createExamModal')).show();
        }

        // Submit create exam
        async function submitCreateExam() {
            const form = document.getElementById('createExamForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            if (!data.name || !data.exam_type || !data.exam_date || !data.total_marks) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            try {
                const resp = await fetch(`${API_BASE}/exams`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await resp.json();
                if (resp.ok && result.success) {
                    showToast('Exam created successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createExamModal')).hide();
                    await loadExamsStats();
                    await loadExamsTab('upcoming');
                } else {
                    throw new Error(result.message || 'Failed to create exam');
                }
            } catch (err) {
                showToast(err.message || 'Failed to create exam', 'error');
            }
        }

        // View Exam Details
        async function viewExamDetails(examId) {
            try {
                const resp = await fetch(`${API_BASE}/exams/${examId}`);
                const data = await resp.json();
                const e = data?.data;

                if (!e) {
                    showToast('Exam not found', 'error');
                    return;
                }

                const modalHtml = `
                    <div class="modal fade" id="examDetailsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title"><i class="bi bi-journal-text"></i> ${e.name}</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="border-bottom pb-2 mb-3">Exam Information</h6>
                                            <p class="mb-2"><strong>Type:</strong> <span class="badge bg-info">${e.exam_type || 'N/A'}</span></p>
                                            <p class="mb-2"><strong>Date:</strong> ${e.exam_date ? formatDate(e.exam_date) : '—'}</p>
                                            <p class="mb-2"><strong>Time:</strong> ${e.start_time || '—'} - ${e.end_time || '—'}</p>
                                            <p class="mb-2"><strong>Duration:</strong> ${e.duration_minutes ? e.duration_minutes + ' mins' : '—'}</p>
                                            <p class="mb-2"><strong>Venue:</strong> ${e.venue || '—'}</p>
                                            <p class="mb-2"><strong>Status:</strong> 
                                                <span class="badge bg-${e.status === 'published' ? 'success' : e.status === 'completed' ? 'primary' : e.status === 'scheduled' ? 'warning' : 'secondary'}">
                                                    ${e.status || 'scheduled'}
                                                </span>
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="border-bottom pb-2 mb-3">Marks & Batch</h6>
                                            <p class="mb-2"><strong>Total Marks:</strong> ${e.total_marks || '—'}</p>
                                            <p class="mb-2"><strong>Passing Marks:</strong> ${e.passing_marks || '—'}</p>
                                            <p class="mb-2"><strong>Batch:</strong> ${e.batch_name || 'All Batches'}</p>
                                            <p class="mb-2"><strong>Subject:</strong> ${e.subject || '—'}</p>
                                            <p class="mb-2"><strong>Results Published:</strong> ${e.results_published ? 'Yes' : 'No'}</p>
                                        </div>
                                    </div>
                                    ${e.instructions ? `
                                        <hr>
                                        <h6>Instructions</h6>
                                        <p class="text-muted">${e.instructions}</p>
                                    ` : ''}
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-success" onclick="bootstrap.Modal.getInstance(document.getElementById('examDetailsModal')).hide(); showEnterResultsModal('${e.id}')">
                                        <i class="bi bi-pencil-square"></i> Enter Results
                                    </button>
                                    <button class="btn btn-info" onclick="bootstrap.Modal.getInstance(document.getElementById('examDetailsModal')).hide(); viewExamResults('${e.id}')">
                                        <i class="bi bi-bar-chart"></i> View Results
                                    </button>
                                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('examDetailsModal')?.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                new bootstrap.Modal(document.getElementById('examDetailsModal')).show();
            } catch (err) {
                showToast('Failed to load exam details', 'error');
            }
        }

        // Show Enter Results Modal
        async function showEnterResultsModal(examId) {
            try {
                // Get exam details
                const examResp = await fetch(`${API_BASE}/exams/${examId}`);
                const examData = await examResp.json();
                const exam = examData?.data;

                if (!exam) {
                    showToast('Exam not found', 'error');
                    return;
                }

                // Get batch students if batch is specified
                let students = [];
                if (exam.batch_id) {
                    const studentsResp = await fetch(`${API_BASE}/batches/${exam.batch_id}/students`);
                    const studentsData = await studentsResp.json();
                    students = studentsData?.data || [];
                } else {
                    // Get all students
                    const studentsResp = await fetch(`${API_BASE}/students?limit=100`);
                    const studentsData = await studentsResp.json();
                    students = studentsData?.data || [];
                }

                // Get existing results
                const resultsResp = await fetch(`${API_BASE}/exams/${examId}/results`);
                const resultsData = await resultsResp.json();
                const existingResults = resultsData?.data || [];
                const resultsMap = {};
                existingResults.forEach(r => { resultsMap[r.student_id] = r.marks_obtained; });

                const modalHtml = `
                    <div class="modal fade" id="enterResultsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Enter Results - ${exam.name}</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-info mb-3">
                                        <strong>Total Marks:</strong> ${exam.total_marks} | 
                                        <strong>Passing:</strong> ${exam.passing_marks || 'N/A'}
                                    </div>
                                    <form id="enterResultsForm">
                                        <input type="hidden" name="exam_id" value="${examId}">
                                        <input type="hidden" name="total_marks" value="${exam.total_marks}">
                                        <table class="table table-sm">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Student</th>
                                                    <th>Marks Obtained</th>
                                                    <th>Remarks</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${students.map(s => `
                                                    <tr>
                                                        <td>${s.first_name} ${s.last_name}</td>
                                                        <td>
                                                            <input type="number" class="form-control form-control-sm" 
                                                                name="marks_${s.id}" 
                                                                value="${resultsMap[s.id] !== undefined ? resultsMap[s.id] : ''}"
                                                                min="0" max="${exam.total_marks}" 
                                                                style="width: 80px">
                                                        </td>
                                                        <td>
                                                            <input type="text" class="form-control form-control-sm" 
                                                                name="remarks_${s.id}" 
                                                                placeholder="Optional">
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-success" onclick="submitResults()">
                                        <i class="bi bi-check-circle"></i> Save Results
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Store students for later use
                window.examStudents = students;

                document.getElementById('enterResultsModal')?.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                new bootstrap.Modal(document.getElementById('enterResultsModal')).show();
            } catch (err) {
                showToast('Failed to load students', 'error');
            }
        }

        // Submit results
        async function submitResults() {
            const form = document.getElementById('enterResultsForm');
            const formData = new FormData(form);
            const examId = formData.get('exam_id');

            const results = [];
            window.examStudents.forEach(s => {
                const marks = formData.get(`marks_${s.id}`);
                if (marks !== '' && marks !== null) {
                    results.push({
                        student_id: s.id,
                        marks_obtained: parseFloat(marks),
                        remarks: formData.get(`remarks_${s.id}`) || ''
                    });
                }
            });

            if (results.length === 0) {
                showToast('Please enter marks for at least one student', 'error');
                return;
            }

            try {
                const resp = await fetch(`${API_BASE}/exams/${examId}/results/bulk`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ results })
                });

                const result = await resp.json();
                if (resp.ok && result.success) {
                    showToast(`Results saved for ${results.length} students`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('enterResultsModal')).hide();
                } else {
                    throw new Error(result.message || 'Failed to save results');
                }
            } catch (err) {
                showToast(err.message || 'Failed to save results', 'error');
            }
        }

        // View Exam Results (quick view)
        async function viewExamResults(examId) {
            // Load results tab and select this exam
            await loadExamsTab('results');
            document.querySelectorAll('#examsTabs .nav-link').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#examsTabs .nav-link')[2].classList.add('active');
            
            setTimeout(() => {
                const select = document.getElementById('results-exam-select');
                if (select) {
                    select.value = examId;
                    loadExamResultsForSelect();
                }
            }, 100);
        }

        // Publish Results
        async function publishResults(examId) {
            if (!confirm('Are you sure you want to publish results? Students will be able to see their scores.')) return;

            try {
                const resp = await fetch(`${API_BASE}/exams/${examId}/publish`, {
                    method: 'POST'
                });

                const result = await resp.json();
                if (resp.ok && result.success) {
                    showToast('Results published successfully!', 'success');
                    loadExamResultsForSelect();
                } else {
                    throw new Error(result.message || 'Failed to publish results');
                }
            } catch (err) {
                showToast(err.message || 'Failed to publish results', 'error');
            }
        }

        // Export Results
        function exportResults(examId) {
            showToast('Results exported! (Demo mode)', 'success');
        }

        // Show Upload Results Modal (bulk upload)
        function showUploadResultsModal() {
            showToast('Bulk upload feature - Use "Enter Results" for individual exams', 'info');
        }

        // Show Edit Exam Modal
        async function showEditExamModal(examId) {
            try {
                const resp = await fetch(`${API_BASE}/exams/${examId}`);
                const data = await resp.json();
                const e = data?.data;

                if (!e) {
                    showToast('Exam not found', 'error');
                    return;
                }

                const batchResp = await fetch(`${API_BASE}/batches`);
                const batchData = await batchResp.json();
                const batches = batchData?.data || [];
                const batchOptions = batches.map(b => `<option value="${b.id}" ${e.batch_id === b.id ? 'selected' : ''}>${b.name}</option>`).join('');

                const modalHtml = `
                    <div class="modal fade" id="editExamModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-warning">
                                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Exam</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editExamForm">
                                        <input type="hidden" name="id" value="${e.id}">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Exam Name *</label>
                                                <input type="text" class="form-control" name="name" value="${e.name || ''}" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Exam Type *</label>
                                                <select class="form-select" name="exam_type" required>
                                                    <option value="weekly_test" ${e.exam_type === 'weekly_test' ? 'selected' : ''}>Weekly Test</option>
                                                    <option value="monthly_test" ${e.exam_type === 'monthly_test' ? 'selected' : ''}>Monthly Test</option>
                                                    <option value="unit_test" ${e.exam_type === 'unit_test' ? 'selected' : ''}>Unit Test</option>
                                                    <option value="mock_exam" ${e.exam_type === 'mock_exam' ? 'selected' : ''}>Mock Exam</option>
                                                    <option value="practice_test" ${e.exam_type === 'practice_test' ? 'selected' : ''}>Practice Test</option>
                                                    <option value="final_exam" ${e.exam_type === 'final_exam' ? 'selected' : ''}>Final Exam</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Exam Date *</label>
                                                <input type="date" class="form-control" name="exam_date" value="${e.exam_date ? e.exam_date.split('T')[0] : ''}" required>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Start Time</label>
                                                <input type="time" class="form-control" name="start_time" value="${e.start_time || ''}">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">End Time</label>
                                                <input type="time" class="form-control" name="end_time" value="${e.end_time || ''}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Batch</label>
                                                <select class="form-select" name="batch_id">
                                                    <option value="">All Batches</option>
                                                    ${batchOptions}
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Total Marks *</label>
                                                <input type="number" class="form-control" name="total_marks" value="${e.total_marks || 100}" required min="1">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Passing Marks</label>
                                                <input type="number" class="form-control" name="passing_marks" value="${e.passing_marks || ''}" min="0">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Venue</label>
                                                <input type="text" class="form-control" name="venue" value="${e.venue || ''}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Status</label>
                                                <select class="form-select" name="status">
                                                    <option value="scheduled" ${e.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                                                    <option value="ongoing" ${e.status === 'ongoing' ? 'selected' : ''}>Ongoing</option>
                                                    <option value="completed" ${e.status === 'completed' ? 'selected' : ''}>Completed</option>
                                                    <option value="cancelled" ${e.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                                </select>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-warning" onclick="submitEditExam()">
                                        <i class="bi bi-check-circle"></i> Update Exam
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('editExamModal')?.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                new bootstrap.Modal(document.getElementById('editExamModal')).show();
            } catch (err) {
                showToast('Failed to load exam data', 'error');
            }
        }

        // Submit edit exam
        async function submitEditExam() {
            const form = document.getElementById('editExamForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            const examId = data.id;
            delete data.id;

            try {
                const resp = await fetch(`${API_BASE}/exams/${examId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await resp.json();
                if (resp.ok && result.success) {
                    showToast('Exam updated successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editExamModal')).hide();
                    await loadExamsStats();
                    await loadExamsTab('upcoming');
                } else {
                    throw new Error(result.message || 'Failed to update exam');
                }
            } catch (err) {
                showToast(err.message || 'Failed to update exam', 'error');
            }
        }

        // ============================================
        // INQUIRIES MANAGEMENT SECTION
        // ============================================

        function ensureInquiriesSection() {
            if (document.getElementById('inquiries-section')) return;

            const section = document.createElement('div');
            section.id = 'inquiries-section';
            section.style.display = 'none';
            section.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-1">Inquiries Management</h2>
                        <p class="text-muted mb-0">Manage admission inquiries and follow-ups</p>
                    </div>
                    <button class="btn btn-primary" onclick="showAddInquiryModal()">
                        <i class="bi bi-plus-lg me-2"></i>Add New Inquiry
                    </button>
                </div>

                <!-- Inquiry Stats -->
                <div class="row mb-4" id="inquiry-stats">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h3 class="mb-0" id="stat-total-inquiries">0</h3>
                                <small>Total Inquiries</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning">
                            <div class="card-body text-center">
                                <h3 class="mb-0" id="stat-pending-inquiries">0</h3>
                                <small>Pending Follow-ups</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h3 class="mb-0" id="stat-converted-inquiries">0</h3>
                                <small>Converted</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h3 class="mb-0" id="stat-conversion-rate">0%</h3>
                                <small>Conversion Rate</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inquiry Tabs -->
                <ul class="nav nav-tabs mb-4" id="inquiryTabs">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="loadInquiriesTab('all')">All Inquiries</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadInquiriesTab('new')">New</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadInquiriesTab('contacted')">Contacted</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadInquiriesTab('follow_up')">Follow-up Required</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadInquiriesTab('followups-due')">Due Today</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="loadInquiriesTab('analytics')">Analytics</a>
                    </li>
                </ul>

                <!-- Filters -->
                <div class="card mb-4" id="inquiry-filters">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="inquiry-search" placeholder="Search by name or phone..." onkeyup="filterInquiries()">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="inquiry-source-filter" onchange="filterInquiries()">
                                    <option value="">All Sources</option>
                                    <option value="walk_in">Walk-in</option>
                                    <option value="phone">Phone</option>
                                    <option value="website">Website</option>
                                    <option value="referral">Referral</option>
                                    <option value="social_media">Social Media</option>
                                    <option value="advertisement">Advertisement</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="inquiry-course-filter" onchange="filterInquiries()">
                                    <option value="">All Courses</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="date" class="form-control" id="inquiry-date-filter" onchange="filterInquiries()">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" onclick="clearInquiryFilters()">Clear Filters</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inquiry Content -->
                <div id="inquiry-content">
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="inquiries-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Phone</th>
                                            <th>Email</th>
                                            <th>Course</th>
                                            <th>Source</th>
                                            <th>Status</th>
                                            <th>Next Follow-up</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inquiries-table-body">
                                        <tr><td colspan="8" class="text-center">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Content (Hidden by default) -->
                <div id="inquiry-analytics-content" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Conversion Analytics</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="conversionChart"></canvas>
                                    <div id="conversion-stats" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">Source Analytics</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="sourceChart"></canvas>
                                    <div id="source-stats" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.querySelector('main').appendChild(section);

            // Add Inquiry Modal
            const addInquiryModal = document.createElement('div');
            addInquiryModal.innerHTML = `
                <div class="modal fade" id="addInquiryModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add New Inquiry</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addInquiryForm">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Student Name *</label>
                                            <input type="text" class="form-control" name="student_name" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Phone *</label>
                                            <input type="tel" class="form-control" name="phone" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Email</label>
                                            <input type="email" class="form-control" name="email">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Parent Name</label>
                                            <input type="text" class="form-control" name="parent_name">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Target Course</label>
                                            <select class="form-select" name="target_course" id="inquiry-course-select">
                                                <option value="">Select Course</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Source *</label>
                                            <select class="form-select" name="source" required>
                                                <option value="walk_in">Walk-in</option>
                                                <option value="phone">Phone</option>
                                                <option value="website">Website</option>
                                                <option value="referral">Referral</option>
                                                <option value="social_media">Social Media</option>
                                                <option value="advertisement">Advertisement</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Current Class/Standard</label>
                                            <input type="text" class="form-control" name="current_class">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Current School</label>
                                            <input type="text" class="form-control" name="current_school">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Next Follow-up Date</label>
                                            <input type="date" class="form-control" name="next_follow_up">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Assigned Counselor</label>
                                            <input type="text" class="form-control" name="counselor_name">
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Address</label>
                                            <textarea class="form-control" name="address" rows="2"></textarea>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Notes</label>
                                            <textarea class="form-control" name="notes" rows="3" placeholder="Initial inquiry notes..."></textarea>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="submitAddInquiry()">Add Inquiry</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(addInquiryModal);

            // View Inquiry Modal
            const viewInquiryModal = document.createElement('div');
            viewInquiryModal.innerHTML = `
                <div class="modal fade" id="viewInquiryModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Inquiry Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="viewInquiryContent">
                                <div class="text-center">
                                    <div class="spinner-border" role="status"></div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(viewInquiryModal);

            // Add Interaction Modal
            const addInteractionModal = document.createElement('div');
            addInteractionModal.innerHTML = `
                <div class="modal fade" id="addInteractionModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add Interaction/Follow-up</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addInteractionForm">
                                    <input type="hidden" name="inquiry_id" id="interaction-inquiry-id">
                                    <div class="mb-3">
                                        <label class="form-label">Interaction Type *</label>
                                        <select class="form-select" name="type" required>
                                            <option value="phone_call">Phone Call</option>
                                            <option value="visit">Visit</option>
                                            <option value="email">Email</option>
                                            <option value="sms">SMS</option>
                                            <option value="demo_class">Demo Class</option>
                                            <option value="counseling">Counseling Session</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Notes *</label>
                                        <textarea class="form-control" name="notes" rows="4" required placeholder="What was discussed? Any concerns or interests noted?"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Next Follow-up Date</label>
                                        <input type="date" class="form-control" name="next_follow_up">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Update Status</label>
                                        <select class="form-select" name="status">
                                            <option value="">Keep Current Status</option>
                                            <option value="contacted">Contacted</option>
                                            <option value="interested">Interested</option>
                                            <option value="follow_up">Requires Follow-up</option>
                                            <option value="demo_scheduled">Demo Scheduled</option>
                                            <option value="negotiation">In Negotiation</option>
                                        </select>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="submitInteraction()">Save Interaction</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(addInteractionModal);

            // Convert to Student Modal
            const convertModal = document.createElement('div');
            convertModal.innerHTML = `
                <div class="modal fade" id="convertToStudentModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">Convert to Student</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="convertToStudentForm">
                                    <input type="hidden" name="inquiry_id" id="convert-inquiry-id">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        This will create a new student record and mark the inquiry as converted.
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Assign to Batch</label>
                                        <select class="form-select" name="batch_id" id="convert-batch-select">
                                            <option value="">Select Batch (Optional)</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Admission Notes</label>
                                        <textarea class="form-control" name="notes" rows="3" placeholder="Any notes for the admission..."></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-success" onclick="submitConvertToStudent()">
                                    <i class="bi bi-check-lg me-2"></i>Convert to Student
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(convertModal);

            // Mark as Lost Modal
            const lostModal = document.createElement('div');
            lostModal.innerHTML = `
                <div class="modal fade" id="markAsLostModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title">Mark as Lost</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="markAsLostForm">
                                    <input type="hidden" name="inquiry_id" id="lost-inquiry-id">
                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        This will mark the inquiry as lost. Please provide a reason.
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Reason *</label>
                                        <select class="form-select" name="reason" id="lost-reason-select" required>
                                            <option value="">Select Reason</option>
                                            <option value="chose_competitor">Chose Competitor</option>
                                            <option value="fee_issue">Fee/Pricing Issue</option>
                                            <option value="timing_issue">Timing/Schedule Issue</option>
                                            <option value="location_issue">Location Issue</option>
                                            <option value="not_interested">Not Interested Anymore</option>
                                            <option value="not_responding">Not Responding</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Additional Notes</label>
                                        <textarea class="form-control" name="notes" rows="3" placeholder="Any additional details..."></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" onclick="submitMarkAsLost()">
                                    <i class="bi bi-x-lg me-2"></i>Mark as Lost
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(lostModal);

            // Load courses for dropdown
            loadCoursesForInquiry();
        }

        function loadCoursesForInquiry() {
            // Use predefined course types from schema
            const courseTypes = [
                { value: 'class_9', label: 'Class 9' },
                { value: 'class_10', label: 'Class 10' },
                { value: 'class_11', label: 'Class 11' },
                { value: 'class_12', label: 'Class 12' },
                { value: 'class_12_pass', label: 'Class 12 Pass' },
                { value: 'iit_jee', label: 'IIT-JEE' },
                { value: 'neet', label: 'NEET' },
                { value: 'foundation', label: 'Foundation' }
            ];

            const courseSelect = document.getElementById('inquiry-course-select');
            const courseFilter = document.getElementById('inquiry-course-filter');

            courseTypes.forEach(course => {
                const option = new Option(course.label, course.value);
                if (courseSelect) courseSelect.add(option.cloneNode(true));
                if (courseFilter) courseFilter.add(option);
            });
        }

        let currentInquiryTab = 'all';

        async function showInquiriesSection() {
            ensureInquiriesSection();
            hideAllSections();
            document.getElementById('inquiries-section').style.display = 'block';
            await loadInquiryStats();
            await loadInquiriesTab('all');
        }

        async function loadInquiryStats() {
            try {
                // Get all inquiries for stats
                const allResp = await fetch(`${API_BASE}/admissions`);
                const allData = await allResp.json();

                let total = 0, pending = 0, converted = 0;
                const inquiries = allData.data || allData.inquiries || [];
                if (allData.success && inquiries.length > 0) {
                    total = inquiries.length;
                    converted = inquiries.filter(i => i.status === 'converted').length;
                    pending = inquiries.filter(i => ['new', 'contacted', 'follow_up', 'interested'].includes(i.status)).length;
                }

                // Get conversion analytics
                try {
                    const convResp = await fetch(`${API_BASE}/admissions/analytics/conversion`);
                    const convData = await convResp.json();
                    if (convData.success && convData.analytics) {
                        document.getElementById('stat-conversion-rate').textContent = convData.analytics.conversion_rate || '0%';
                    }
                } catch (e) {
                    document.getElementById('stat-conversion-rate').textContent = total > 0 ? ((converted/total)*100).toFixed(1) + '%' : '0%';
                }

                document.getElementById('stat-total-inquiries').textContent = total;
                document.getElementById('stat-pending-inquiries').textContent = pending;
                document.getElementById('stat-converted-inquiries').textContent = converted;
            } catch (err) {
                console.error('Failed to load inquiry stats:', err);
            }
        }

        async function loadInquiriesTab(tab) {
            currentInquiryTab = tab;

            // Update tab active state
            document.querySelectorAll('#inquiryTabs .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show/hide appropriate content
            const tableContent = document.getElementById('inquiry-content');
            const analyticsContent = document.getElementById('inquiry-analytics-content');
            const filtersContent = document.getElementById('inquiry-filters');

            if (tab === 'analytics') {
                tableContent.style.display = 'none';
                filtersContent.style.display = 'none';
                analyticsContent.style.display = 'block';
                await loadInquiryAnalytics();
            } else {
                tableContent.style.display = 'block';
                filtersContent.style.display = 'block';
                analyticsContent.style.display = 'none';
                await loadInquiriesList(tab);
            }
        }

        async function loadInquiriesList(tab = 'all') {
            const tbody = document.getElementById('inquiries-table-body');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading...</td></tr>';

            try {
                let url = `${API_BASE}/admissions`;

                if (tab === 'followups-due') {
                    url = `${API_BASE}/admissions/follow-ups/due`;
                } else if (tab !== 'all') {
                    url += `?status=${tab}`;
                }

                const resp = await fetch(url);
                const data = await resp.json();

                let inquiries = [];
                if (data.success) {
                    inquiries = data.data || data.inquiries || data.followUps || [];
                }

                if (inquiries.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No inquiries found</td></tr>';
                    return;
                }

                tbody.innerHTML = inquiries.map(inquiry => `
                    <tr>
                        <td>
                            <strong>${inquiry.student_name}</strong>
                            ${inquiry.parent_name ? `<br><small class="text-muted">Parent: ${inquiry.parent_name}</small>` : ''}
                        </td>
                        <td>${inquiry.phone || '-'}</td>
                        <td>${inquiry.email || '-'}</td>
                        <td>${formatCourseType(inquiry.target_course)}</td>
                        <td><span class="badge bg-secondary">${formatSource(inquiry.source)}</span></td>
                        <td>${getStatusBadge(inquiry.status)}</td>
                        <td>
                            ${inquiry.next_follow_up_date || inquiry.next_follow_up ? `
                                <span class="${isOverdue(inquiry.next_follow_up_date || inquiry.next_follow_up) ? 'text-danger' : ''}">${formatDate(inquiry.next_follow_up_date || inquiry.next_follow_up)}</span>
                                ${isOverdue(inquiry.next_follow_up_date || inquiry.next_follow_up) ? '<br><small class="text-danger">Overdue!</small>' : ''}
                            ` : '-'}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewInquiryDetails('${inquiry.id}')" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="showAddInteractionModal('${inquiry.id}')" title="Add Interaction">
                                    <i class="bi bi-chat-dots"></i>
                                </button>
                                ${inquiry.status !== 'converted' && inquiry.status !== 'lost' ? `
                                    <button class="btn btn-outline-success" onclick="showConvertModal('${inquiry.id}')" title="Convert to Student">
                                        <i class="bi bi-person-check"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="showLostModal('${inquiry.id}')" title="Mark as Lost">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Failed to load inquiries</td></tr>';
                console.error('Failed to load inquiries:', err);
            }
        }

        function formatSource(source) {
            const sources = {
                'walk_in': 'Walk-in',
                'phone': 'Phone',
                'website': 'Website',
                'referral': 'Referral',
                'social_media': 'Social Media',
                'advertisement': 'Advertisement'
            };
            return sources[source] || source || '-';
        }

        function formatCourseType(courseType) {
            const types = {
                'class_9': 'Class 9',
                'class_10': 'Class 10',
                'class_11': 'Class 11',
                'class_12': 'Class 12',
                'class_12_pass': 'Class 12 Pass',
                'iit_jee': 'IIT-JEE',
                'neet': 'NEET',
                'foundation': 'Foundation'
            };
            return types[courseType] || courseType || '-';
        }

        function getStatusBadge(status) {
            const badges = {
                'new': '<span class="badge bg-info">New</span>',
                'contacted': '<span class="badge bg-primary">Contacted</span>',
                'interested': '<span class="badge bg-warning">Interested</span>',
                'follow_up': '<span class="badge bg-warning">Follow-up</span>',
                'demo_scheduled': '<span class="badge bg-info">Demo Scheduled</span>',
                'negotiation': '<span class="badge bg-secondary">Negotiation</span>',
                'converted': '<span class="badge bg-success">Converted</span>',
                'lost': '<span class="badge bg-danger">Lost</span>'
            };
            return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
        }

        function isOverdue(dateStr) {
            if (!dateStr) return false;
            const followUpDate = new Date(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return followUpDate < today;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        async function filterInquiries() {
            const search = document.getElementById('inquiry-search').value.toLowerCase();
            const source = document.getElementById('inquiry-source-filter').value;
            const course = document.getElementById('inquiry-course-filter').value;
            const date = document.getElementById('inquiry-date-filter').value;

            let url = `${API_BASE}/admissions?`;
            const params = [];
            if (search) params.push(`search=${encodeURIComponent(search)}`);
            if (source) params.push(`source=${source}`);
            if (course) params.push(`target_course=${course}`);
            url += params.join('&');

            try {
                const resp = await fetch(url);
                const data = await resp.json();

                if (data.success && (data.data || data.inquiries)) {
                    let inquiries = data.data || data.inquiries;

                    // Client-side date filter
                    if (date) {
                        inquiries = inquiries.filter(i => {
                            const inquiryDate = new Date(i.created_at).toISOString().split('T')[0];
                            return inquiryDate === date;
                        });
                    }

                    const tbody = document.getElementById('inquiries-table-body');
                    if (inquiries.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No matching inquiries</td></tr>';
                        return;
                    }

                    tbody.innerHTML = inquiries.map(inquiry => `
                        <tr>
                            <td>
                                <strong>${inquiry.student_name}</strong>
                                ${inquiry.parent_name ? `<br><small class="text-muted">Parent: ${inquiry.parent_name}</small>` : ''}
                            </td>
                            <td>${inquiry.phone || '-'}</td>
                            <td>${inquiry.email || '-'}</td>
                            <td>${formatCourseType(inquiry.target_course)}</td>
                            <td><span class="badge bg-secondary">${formatSource(inquiry.source)}</span></td>
                            <td>${getStatusBadge(inquiry.status)}</td>
                            <td>
                                ${inquiry.next_follow_up_date || inquiry.next_follow_up ? `
                                    <span class="${isOverdue(inquiry.next_follow_up_date || inquiry.next_follow_up) ? 'text-danger' : ''}">${formatDate(inquiry.next_follow_up_date || inquiry.next_follow_up)}</span>
                                ` : '-'}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="viewInquiryDetails('${inquiry.id}')" title="View Details">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="showAddInteractionModal('${inquiry.id}')" title="Add Interaction">
                                        <i class="bi bi-chat-dots"></i>
                                    </button>
                                    ${inquiry.status !== 'converted' && inquiry.status !== 'lost' ? `
                                        <button class="btn btn-outline-success" onclick="showConvertModal('${inquiry.id}')" title="Convert to Student">
                                            <i class="bi bi-person-check"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="showLostModal('${inquiry.id}')" title="Mark as Lost">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('Failed to filter inquiries:', err);
            }
        }

        function clearInquiryFilters() {
            document.getElementById('inquiry-search').value = '';
            document.getElementById('inquiry-source-filter').value = '';
            document.getElementById('inquiry-course-filter').value = '';
            document.getElementById('inquiry-date-filter').value = '';
            loadInquiriesList(currentInquiryTab);
        }

        function showAddInquiryModal() {
            document.getElementById('addInquiryForm').reset();
            // Set default next follow-up to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.querySelector('#addInquiryForm [name="next_follow_up"]').value = tomorrow.toISOString().split('T')[0];
            new bootstrap.Modal(document.getElementById('addInquiryModal')).show();
        }

        async function submitAddInquiry() {
            const form = document.getElementById('addInquiryForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            // Remove empty fields
            Object.keys(data).forEach(key => {
                if (!data[key]) delete data[key];
            });

            try {
                const resp = await fetch(`${API_BASE}/admissions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await resp.json();
                if (resp.ok && result.success) {
                    showToast('Inquiry added successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addInquiryModal')).hide();
                    await loadInquiryStats();
                    await loadInquiriesList(currentInquiryTab);
                } else {
                    throw new Error(result.message || 'Failed to add inquiry');
                }
            } catch (err) {
                showToast(err.message || 'Failed to add inquiry', 'error');
            }
        }

        async function viewInquiryDetails(inquiryId) {
            const modal = new bootstrap.Modal(document.getElementById('viewInquiryModal'));
            modal.show();

            const content = document.getElementById('viewInquiryContent');
            content.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';

            try {
                const resp = await fetch(`${API_BASE}/admissions/${inquiryId}`);
                const data = await resp.json();

                if (data.success && data.inquiry) {
                    const inquiry = data.inquiry;
                    content.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">Student Information</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>Name:</strong></td><td>${inquiry.student_name}</td></tr>
                                    <tr><td><strong>Phone:</strong></td><td>${inquiry.phone || '-'}</td></tr>
                                    <tr><td><strong>Email:</strong></td><td>${inquiry.email || '-'}</td></tr>
                                    <tr><td><strong>Parent:</strong></td><td>${inquiry.parent_name || '-'}</td></tr>
                                    <tr><td><strong>Current Class:</strong></td><td>${inquiry.current_class || '-'}</td></tr>
                                    <tr><td><strong>School:</strong></td><td>${inquiry.current_school || '-'}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary">Inquiry Details</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>Status:</strong></td><td>${getStatusBadge(inquiry.status)}</td></tr>
                                    <tr><td><strong>Source:</strong></td><td>${formatSource(inquiry.source)}</td></tr>
                                    <tr><td><strong>Target Course:</strong></td><td>${formatCourseType(inquiry.target_course)}</td></tr>
                                    <tr><td><strong>Counselor:</strong></td><td>${inquiry.counselor_name || '-'}</td></tr>
                                    <tr><td><strong>Next Follow-up:</strong></td><td>${inquiry.next_follow_up_date ? formatDate(inquiry.next_follow_up_date) : '-'}</td></tr>
                                    <tr><td><strong>Created:</strong></td><td>${formatDate(inquiry.created_at)}</td></tr>
                                </table>
                            </div>
                        </div>
                        ${inquiry.notes ? `
                            <div class="mt-3">
                                <h6 class="text-primary">Notes</h6>
                                <p class="bg-light p-2 rounded">${inquiry.notes}</p>
                            </div>
                        ` : ''}
                        ${inquiry.interactions && inquiry.interactions.length > 0 ? `
                            <div class="mt-3">
                                <h6 class="text-primary">Interaction History</h6>
                                <div class="timeline">
                                    ${inquiry.interactions.map(i => `
                                        <div class="card mb-2">
                                            <div class="card-body py-2">
                                                <div class="d-flex justify-content-between">
                                                    <strong>${i.type}</strong>
                                                    <small class="text-muted">${formatDate(i.created_at)}</small>
                                                </div>
                                                <p class="mb-0 small">${i.notes}</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : '<div class="mt-3 text-muted">No interactions recorded yet.</div>'}
                    `;
                } else {
                    content.innerHTML = '<div class="text-danger">Failed to load inquiry details</div>';
                }
            } catch (err) {
                content.innerHTML = '<div class="text-danger">Failed to load inquiry details</div>';
                console.error('Failed to load inquiry details:', err);
            }
        }

        function showAddInteractionModal(inquiryId) {
            document.getElementById('addInteractionForm').reset();
            document.getElementById('interaction-inquiry-id').value = inquiryId;
            new bootstrap.Modal(document.getElementById('addInteractionModal')).show();
        }

        async function submitInteraction() {
            const form = document.getElementById('addInteractionForm');
            const formData = new FormData(form);
            const inquiryId = formData.get('inquiry_id');
            const data = {
                type: formData.get('type'),
                notes: formData.get('notes')
            };

            // Add optional fields
            const nextFollowUp = formData.get('next_follow_up');
            const status = formData.get('status');
            if (nextFollowUp) data.next_follow_up = nextFollowUp;
            if (status) data.status = status;

            try {
                const resp = await fetch(`${API_BASE}/admissions/${inquiryId}/interaction`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await resp.json();
                if (resp.ok && result.success) {
                    showToast('Interaction recorded successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addInteractionModal')).hide();
                    await loadInquiryStats();
                    await loadInquiriesList(currentInquiryTab);
                } else {
                    throw new Error(result.message || 'Failed to record interaction');
                }
            } catch (err) {
                showToast(err.message || 'Failed to record interaction', 'error');
            }
        }

        async function showConvertModal(inquiryId) {
            document.getElementById('convertToStudentForm').reset();
            document.getElementById('convert-inquiry-id').value = inquiryId;

            // Load batches for dropdown
            try {
                const resp = await fetch(`${API_BASE}/batches`);
                const data = await resp.json();
                const select = document.getElementById('convert-batch-select');
                select.innerHTML = '<option value="">Select Batch (Optional)</option>';
                if (data.success && data.batches) {
                    data.batches.forEach(batch => {
                        select.add(new Option(`${batch.name} (${batch.course_name || 'No Course'})`, batch.id));
                    });
                }
            } catch (err) {
                console.error('Failed to load batches:', err);
            }

            new bootstrap.Modal(document.getElementById('convertToStudentModal')).show();
        }

        async function submitConvertToStudent() {
            const form = document.getElementById('convertToStudentForm');
            const formData = new FormData(form);
            const inquiryId = formData.get('inquiry_id');
            const data = {};

            const batchId = formData.get('batch_id');
            const notes = formData.get('notes');
            if (batchId) data.batch_id = batchId;
            if (notes) data.notes = notes;

            try {
                const resp = await fetch(`${API_BASE}/admissions/${inquiryId}/convert`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await resp.json();
                if (resp.ok && result.success) {
                    showToast('Successfully converted to student!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('convertToStudentModal')).hide();
                    await loadInquiryStats();
                    await loadInquiriesList(currentInquiryTab);
                } else {
                    throw new Error(result.message || 'Failed to convert');
                }
            } catch (err) {
                showToast(err.message || 'Failed to convert to student', 'error');
            }
        }

        function showLostModal(inquiryId) {
            document.getElementById('markAsLostForm').reset();
            document.getElementById('lost-inquiry-id').value = inquiryId;
            new bootstrap.Modal(document.getElementById('markAsLostModal')).show();
        }

        async function submitMarkAsLost() {
            const form = document.getElementById('markAsLostForm');
            const formData = new FormData(form);
            const inquiryId = formData.get('inquiry_id');
            const reason = formData.get('reason');
            const notes = formData.get('notes');

            if (!reason) {
                showToast('Please select a reason', 'error');
                return;
            }

            try {
                const resp = await fetch(`${API_BASE}/admissions/${inquiryId}/lost`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason, notes })
                });

                const result = await resp.json();
                if (resp.ok && result.success) {
                    showToast('Inquiry marked as lost', 'info');
                    bootstrap.Modal.getInstance(document.getElementById('markAsLostModal')).hide();
                    await loadInquiryStats();
                    await loadInquiriesList(currentInquiryTab);
                } else {
                    throw new Error(result.message || 'Failed to mark as lost');
                }
            } catch (err) {
                showToast(err.message || 'Failed to mark as lost', 'error');
            }
        }

        async function loadInquiryAnalytics() {
            try {
                // Load conversion analytics
                const convResp = await fetch(`${API_BASE}/admissions/analytics/conversion`);
                const convData = await convResp.json();

                if (convData.success && convData.analytics) {
                    const stats = convData.analytics;
                    document.getElementById('conversion-stats').innerHTML = `
                        <div class="row text-center">
                            <div class="col-4">
                                <h5>${stats.total_inquiries || 0}</h5>
                                <small class="text-muted">Total</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-success">${stats.converted || 0}</h5>
                                <small class="text-muted">Converted</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-danger">${stats.lost || 0}</h5>
                                <small class="text-muted">Lost</small>
                            </div>
                        </div>
                    `;

                    // Create conversion chart
                    const convCtx = document.getElementById('conversionChart').getContext('2d');
                    if (window.conversionChartInstance) window.conversionChartInstance.destroy();
                    window.conversionChartInstance = new Chart(convCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Converted', 'Lost', 'Pending'],
                            datasets: [{
                                data: [
                                    stats.converted || 0,
                                    stats.lost || 0,
                                    (stats.total_inquiries || 0) - (stats.converted || 0) - (stats.lost || 0)
                                ],
                                backgroundColor: ['#198754', '#dc3545', '#ffc107']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                        }
                    });
                }

                // Load source analytics
                const sourceResp = await fetch(`${API_BASE}/admissions/analytics/source`);
                const sourceData = await sourceResp.json();

                if (sourceData.success && sourceData.analytics) {
                    const sources = sourceData.analytics;
                    document.getElementById('source-stats').innerHTML = `
                        <table class="table table-sm">
                            <thead><tr><th>Source</th><th>Count</th><th>Converted</th></tr></thead>
                            <tbody>
                                ${sources.map(s => `
                                    <tr>
                                        <td>${formatSource(s.source)}</td>
                                        <td>${s.count}</td>
                                        <td>${s.converted || 0}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;

                    // Create source chart
                    const srcCtx = document.getElementById('sourceChart').getContext('2d');
                    if (window.sourceChartInstance) window.sourceChartInstance.destroy();
                    window.sourceChartInstance = new Chart(srcCtx, {
                        type: 'bar',
                        data: {
                            labels: sources.map(s => formatSource(s.source)),
                            datasets: [{
                                label: 'Inquiries by Source',
                                data: sources.map(s => s.count),
                                backgroundColor: '#0d6efd'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
            } catch (err) {
                console.error('Failed to load analytics:', err);
                showToast('Failed to load analytics', 'error');
            }
        }

        // ============================================
        // REPORTS SECTION
        // ============================================

        function ensureReportsSection() {
            if (document.getElementById('reports-section')) return;

            const section = document.createElement('div');
            section.id = 'reports-section';
            section.style.display = 'none';
            section.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-1"><i class="bi bi-file-earmark-bar-graph me-2"></i>Reports</h2>
                        <p class="text-muted mb-0">Generate and download various reports</p>
                    </div>
                </div>

                <!-- Report Categories -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card h-100 report-card" onclick="showReportType('student')">
                            <div class="card-body text-center">
                                <i class="bi bi-mortarboard fs-1 text-primary mb-3"></i>
                                <h5>Student Reports</h5>
                                <p class="text-muted small">Progress, performance & attendance</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card h-100 report-card" onclick="showReportType('fee')">
                            <div class="card-body text-center">
                                <i class="bi bi-currency-rupee fs-1 text-success mb-3"></i>
                                <h5>Fee Reports</h5>
                                <p class="text-muted small">Collections, pending & revenue</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card h-100 report-card" onclick="showReportType('attendance')">
                            <div class="card-body text-center">
                                <i class="bi bi-calendar-check fs-1 text-info mb-3"></i>
                                <h5>Attendance Reports</h5>
                                <p class="text-muted small">Daily, batch-wise & summary</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card h-100 report-card" onclick="showReportType('exam')">
                            <div class="card-body text-center">
                                <i class="bi bi-clipboard-data fs-1 text-warning mb-3"></i>
                                <h5>Exam Reports</h5>
                                <p class="text-muted small">Results, analytics & rankings</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Report Generator Panel -->
                <div class="card" id="report-generator-panel">
                    <div class="card-header bg-light">
                        <ul class="nav nav-tabs card-header-tabs" id="reportTabs">
                            <li class="nav-item">
                                <a class="nav-link active" href="#" onclick="showReportType('student')">
                                    <i class="bi bi-mortarboard me-1"></i>Student
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" onclick="showReportType('fee')">
                                    <i class="bi bi-currency-rupee me-1"></i>Fee
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" onclick="showReportType('attendance')">
                                    <i class="bi bi-calendar-check me-1"></i>Attendance
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" onclick="showReportType('exam')">
                                    <i class="bi bi-clipboard-data me-1"></i>Exam
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <!-- Student Reports Panel -->
                        <div id="student-reports-panel" class="report-panel">
                            <h5 class="mb-3">Student Reports</h5>
                            <div class="row g-3 mb-4">
                                <div class="col-md-4">
                                    <label class="form-label">Report Type</label>
                                    <select class="form-select" id="student-report-type">
                                        <option value="progress">Student Progress Report</option>
                                        <option value="all-students">All Students List</option>
                                        <option value="low-attendance">Low Attendance Students</option>
                                        <option value="batch-wise">Batch-wise Student List</option>
                                    </select>
                                </div>
                                <div class="col-md-4" id="student-select-container">
                                    <label class="form-label">Select Student</label>
                                    <select class="form-select" id="report-student-select">
                                        <option value="">Select a student...</option>
                                    </select>
                                </div>
                                <div class="col-md-4" id="batch-select-container-report" style="display: none;">
                                    <label class="form-label">Select Batch</label>
                                    <select class="form-select" id="report-batch-select">
                                        <option value="">All Batches</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="generateStudentReport()">
                                <i class="bi bi-file-earmark-pdf me-2"></i>Generate Report
                            </button>
                        </div>

                        <!-- Fee Reports Panel -->
                        <div id="fee-reports-panel" class="report-panel" style="display: none;">
                            <h5 class="mb-3">Fee Reports</h5>
                            <div class="row g-3 mb-4">
                                <div class="col-md-4">
                                    <label class="form-label">Report Type</label>
                                    <select class="form-select" id="fee-report-type">
                                        <option value="collection-summary">Collection Summary</option>
                                        <option value="pending-fees">Pending Fees</option>
                                        <option value="overdue">Overdue Fees</option>
                                        <option value="batch-collection">Batch-wise Collection</option>
                                        <option value="revenue">Revenue Report</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="fee-report-from">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="fee-report-to">
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="generateFeeReport()">
                                <i class="bi bi-file-earmark-spreadsheet me-2"></i>Generate Report
                            </button>
                        </div>

                        <!-- Attendance Reports Panel -->
                        <div id="attendance-reports-panel" class="report-panel" style="display: none;">
                            <h5 class="mb-3">Attendance Reports</h5>
                            <div class="row g-3 mb-4">
                                <div class="col-md-3">
                                    <label class="form-label">Report Type</label>
                                    <select class="form-select" id="attendance-report-type">
                                        <option value="daily">Daily Attendance</option>
                                        <option value="batch-summary">Batch Summary</option>
                                        <option value="student-wise">Student-wise Report</option>
                                        <option value="low-attendance">Low Attendance Alert</option>
                                        <option value="monthly">Monthly Summary</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Batch</label>
                                    <select class="form-select" id="attendance-report-batch">
                                        <option value="">All Batches</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="attendance-report-from">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="attendance-report-to">
                                </div>
                            </div>
                            <button class="btn btn-info text-white" onclick="generateAttendanceReport()">
                                <i class="bi bi-file-earmark-text me-2"></i>Generate Report
                            </button>
                        </div>

                        <!-- Exam Reports Panel -->
                        <div id="exam-reports-panel" class="report-panel" style="display: none;">
                            <h5 class="mb-3">Exam Reports</h5>
                            <div class="row g-3 mb-4">
                                <div class="col-md-4">
                                    <label class="form-label">Report Type</label>
                                    <select class="form-select" id="exam-report-type">
                                        <option value="results">Exam Results</option>
                                        <option value="analytics">Performance Analytics</option>
                                        <option value="ranking">Student Rankings</option>
                                        <option value="batch-comparison">Batch Comparison</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Select Exam</label>
                                    <select class="form-select" id="report-exam-select">
                                        <option value="">All Exams</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Batch</label>
                                    <select class="form-select" id="exam-report-batch">
                                        <option value="">All Batches</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-warning" onclick="generateExamReport()">
                                <i class="bi bi-file-earmark-bar-graph me-2"></i>Generate Report
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Report Preview/Results Area -->
                <div class="card mt-4" id="report-results-card" style="display: none;">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>Report Preview</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="printReport()">
                                <i class="bi bi-printer me-1"></i>Print
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="downloadReportCSV()">
                                <i class="bi bi-download me-1"></i>Download CSV
                            </button>
                        </div>
                    </div>
                    <div class="card-body" id="report-results-content">
                        <!-- Report results will be rendered here -->
                    </div>
                </div>
            `;
            document.querySelector('.main-content').appendChild(section);

            // Add CSS for report cards
            const style = document.createElement('style');
            style.textContent = `
                .report-card {
                    cursor: pointer;
                    transition: all 0.3s ease;
                    border: 2px solid transparent;
                }
                .report-card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                    border-color: #0d6efd;
                }
                .report-panel {
                    animation: fadeIn 0.3s ease;
                }
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                #report-results-content table {
                    font-size: 0.9rem;
                }
                @media print {
                    .sidebar, .navbar, .btn, .card-header {
                        display: none !important;
                    }
                    #report-results-card {
                        box-shadow: none !important;
                        border: none !important;
                    }
                }
            `;
            document.head.appendChild(style);

            // Load dropdowns
            loadReportDropdowns();
        }

        async function loadReportDropdowns() {
            // Load students
            try {
                const studentsResp = await fetch(`${API_BASE}/students`);
                const studentsData = await studentsResp.json();
                const studentSelect = document.getElementById('report-student-select');
                if (studentsData.success && studentsData.data) {
                    studentsData.data.forEach(s => {
                        studentSelect.add(new Option(`${s.first_name} ${s.last_name} (${s.email})`, s.id));
                    });
                }
            } catch (err) {
                console.error('Failed to load students for reports:', err);
            }

            // Load batches for multiple dropdowns
            try {
                const batchesResp = await fetch(`${API_BASE}/batches`);
                const batchesData = await batchesResp.json();
                const batchSelects = [
                    document.getElementById('report-batch-select'),
                    document.getElementById('attendance-report-batch'),
                    document.getElementById('exam-report-batch')
                ];
                if (batchesData.success && batchesData.batches) {
                    batchSelects.forEach(select => {
                        if (select) {
                            batchesData.batches.forEach(b => {
                                select.add(new Option(b.name, b.id));
                            });
                        }
                    });
                }
            } catch (err) {
                console.error('Failed to load batches for reports:', err);
            }

            // Load exams
            try {
                const examsResp = await fetch(`${API_BASE}/exams`);
                const examsData = await examsResp.json();
                const examSelect = document.getElementById('report-exam-select');
                if (examsData.success && examsData.data) {
                    examsData.data.forEach(e => {
                        examSelect.add(new Option(`${e.name} (${formatDate(e.exam_date)})`, e.id));
                    });
                }
            } catch (err) {
                console.error('Failed to load exams for reports:', err);
            }

            // Set default dates
            const today = new Date();
            const monthAgo = new Date(today);
            monthAgo.setMonth(monthAgo.getMonth() - 1);

            document.getElementById('fee-report-from').value = monthAgo.toISOString().split('T')[0];
            document.getElementById('fee-report-to').value = today.toISOString().split('T')[0];
            document.getElementById('attendance-report-from').value = monthAgo.toISOString().split('T')[0];
            document.getElementById('attendance-report-to').value = today.toISOString().split('T')[0];

            // Handle student report type change
            document.getElementById('student-report-type').addEventListener('change', function() {
                const studentContainer = document.getElementById('student-select-container');
                const batchContainer = document.getElementById('batch-select-container-report');
                if (this.value === 'progress') {
                    studentContainer.style.display = 'block';
                    batchContainer.style.display = 'none';
                } else if (this.value === 'batch-wise') {
                    studentContainer.style.display = 'none';
                    batchContainer.style.display = 'block';
                } else {
                    studentContainer.style.display = 'none';
                    batchContainer.style.display = 'none';
                }
            });
        }

        async function showReportsSection() {
            ensureReportsSection();
            hideAllSections();
            document.getElementById('reports-section').style.display = 'block';
        }

        function showReportType(type) {
            // Update tabs
            document.querySelectorAll('#reportTabs .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.closest('.nav-link')?.classList.add('active');

            // Hide all panels
            document.querySelectorAll('.report-panel').forEach(panel => {
                panel.style.display = 'none';
            });

            // Show selected panel
            document.getElementById(`${type}-reports-panel`).style.display = 'block';

            // Hide results
            document.getElementById('report-results-card').style.display = 'none';
        }

        async function generateStudentReport() {
            const reportType = document.getElementById('student-report-type').value;
            const resultsCard = document.getElementById('report-results-card');
            const resultsContent = document.getElementById('report-results-content');

            resultsContent.innerHTML = '<div class="text-center py-4"><div class="spinner-border"></div><p class="mt-2">Generating report...</p></div>';
            resultsCard.style.display = 'block';

            try {
                let html = '';

                if (reportType === 'progress') {
                    const studentId = document.getElementById('report-student-select').value;
                    if (!studentId) {
                        showToast('Please select a student', 'error');
                        resultsCard.style.display = 'none';
                        return;
                    }

                    const resp = await fetch(`${API_BASE}/students/${studentId}/progress-report`);
                    const data = await resp.json();

                    if (data.success && data.report) {
                        const r = data.report;
                        html = `
                            <div class="report-header text-center mb-4">
                                <h3>Student Progress Report</h3>
                                <p class="text-muted">Generated on ${new Date().toLocaleDateString('en-IN')}</p>
                            </div>
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h5>Student Information</h5>
                                    <table class="table table-sm">
                                        <tr><td><strong>Name:</strong></td><td>${r.student?.first_name || ''} ${r.student?.last_name || ''}</td></tr>
                                        <tr><td><strong>Email:</strong></td><td>${r.student?.email || '-'}</td></tr>
                                        <tr><td><strong>Phone:</strong></td><td>${r.student?.phone || '-'}</td></tr>
                                        <tr><td><strong>Status:</strong></td><td>${r.student?.status || '-'}</td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h5>Summary</h5>
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="p-2 bg-primary text-white rounded">
                                                <h4 class="mb-0">${r.attendance?.percentage || 0}%</h4>
                                                <small>Attendance</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="p-2 bg-success text-white rounded">
                                                <h4 class="mb-0">${r.performance?.average_score || 0}%</h4>
                                                <small>Avg Score</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="p-2 bg-warning rounded">
                                                <h4 class="mb-0">₹${r.fees?.pending || 0}</h4>
                                                <small>Pending Fees</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        html = '<div class="alert alert-warning">No data found for this student</div>';
                    }
                } else if (reportType === 'all-students') {
                    const resp = await fetch(`${API_BASE}/students`);
                    const data = await resp.json();

                    if (data.success && data.data) {
                        html = `
                            <div class="report-header text-center mb-4">
                                <h3>All Students List</h3>
                                <p class="text-muted">Total: ${data.data.length} students | Generated on ${new Date().toLocaleDateString('en-IN')}</p>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="report-table">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>#</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Status</th>
                                            <th>Joined</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.data.map((s, i) => `
                                            <tr>
                                                <td>${i + 1}</td>
                                                <td>${s.first_name} ${s.last_name}</td>
                                                <td>${s.email}</td>
                                                <td>${s.phone || '-'}</td>
                                                <td><span class="badge bg-${s.status === 'active' ? 'success' : 'secondary'}">${s.status}</span></td>
                                                <td>${formatDate(s.created_at)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                } else if (reportType === 'low-attendance') {
                    const resp = await fetch(`${API_BASE}/students/reports/low-attendance?threshold=75`);
                    const data = await resp.json();

                    html = `
                        <div class="report-header text-center mb-4">
                            <h3>Low Attendance Students Report</h3>
                            <p class="text-muted">Students with attendance below 75% | Generated on ${new Date().toLocaleDateString('en-IN')}</p>
                        </div>
                    `;

                    if (data.success && data.data && data.data.length > 0) {
                        html += `
                            <div class="table-responsive">
                                <table class="table table-striped" id="report-table">
                                    <thead class="table-danger">
                                        <tr>
                                            <th>#</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Attendance %</th>
                                            <th>Present Days</th>
                                            <th>Total Days</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.data.map((s, i) => `
                                            <tr>
                                                <td>${i + 1}</td>
                                                <td>${s.first_name} ${s.last_name}</td>
                                                <td>${s.email}</td>
                                                <td><span class="text-danger fw-bold">${s.attendance_percentage}%</span></td>
                                                <td>${s.present_days}</td>
                                                <td>${s.total_days}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        html += '<div class="alert alert-success">No students with low attendance found!</div>';
                    }
                } else if (reportType === 'batch-wise') {
                    const batchId = document.getElementById('report-batch-select').value;
                    let url = `${API_BASE}/students`;
                    if (batchId) url += `?batch_id=${batchId}`;

                    const resp = await fetch(url);
                    const data = await resp.json();

                    html = `
                        <div class="report-header text-center mb-4">
                            <h3>Batch-wise Student List</h3>
                            <p class="text-muted">Generated on ${new Date().toLocaleDateString('en-IN')}</p>
                        </div>
                    `;

                    if (data.success && data.data) {
                        html += `
                            <div class="table-responsive">
                                <table class="table table-striped" id="report-table">
                                    <thead class="table-primary">
                                        <tr>
                                            <th>#</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.data.map((s, i) => `
                                            <tr>
                                                <td>${i + 1}</td>
                                                <td>${s.first_name} ${s.last_name}</td>
                                                <td>${s.email}</td>
                                                <td>${s.phone || '-'}</td>
                                                <td>${s.status}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                }

                resultsContent.innerHTML = html;
            } catch (err) {
                resultsContent.innerHTML = `<div class="alert alert-danger">Failed to generate report: ${err.message}</div>`;
            }
        }

        async function generateFeeReport() {
            const reportType = document.getElementById('fee-report-type').value;
            const fromDate = document.getElementById('fee-report-from').value;
            const toDate = document.getElementById('fee-report-to').value;
            const resultsCard = document.getElementById('report-results-card');
            const resultsContent = document.getElementById('report-results-content');

            resultsContent.innerHTML = '<div class="text-center py-4"><div class="spinner-border"></div><p class="mt-2">Generating report...</p></div>';
            resultsCard.style.display = 'block';

            try {
                let html = '';

                if (reportType === 'collection-summary' || reportType === 'pending-fees' || reportType === 'overdue') {
                    const resp = await fetch(`${API_BASE}/fees/summary`);
                    const data = await resp.json();

                    html = `
                        <div class="report-header text-center mb-4">
                            <h3>Fee ${reportType === 'collection-summary' ? 'Collection Summary' : reportType === 'pending-fees' ? 'Pending Fees' : 'Overdue Fees'} Report</h3>
                            <p class="text-muted">Generated on ${new Date().toLocaleDateString('en-IN')}</p>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h3>₹${(data.summary?.total_fees || 0).toLocaleString()}</h3>
                                        <small>Total Fees</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h3>₹${(data.summary?.collected || 0).toLocaleString()}</h3>
                                        <small>Collected</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning">
                                    <div class="card-body text-center">
                                        <h3>₹${(data.summary?.pending || 0).toLocaleString()}</h3>
                                        <small>Pending</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h3>${data.summary?.overdue_count || 0}</h3>
                                        <small>Overdue</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Get fee list
                    let feeUrl = `${API_BASE}/fees`;
                    if (reportType === 'pending-fees') feeUrl += '?status=pending';
                    else if (reportType === 'overdue') feeUrl += '?status=overdue';

                    const feesResp = await fetch(feeUrl);
                    const feesData = await feesResp.json();

                    if (feesData.success && feesData.fees && feesData.fees.length > 0) {
                        html += `
                            <div class="table-responsive">
                                <table class="table table-striped" id="report-table">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>#</th>
                                            <th>Student</th>
                                            <th>Fee Type</th>
                                            <th>Amount</th>
                                            <th>Paid</th>
                                            <th>Balance</th>
                                            <th>Status</th>
                                            <th>Due Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${feesData.fees.map((f, i) => `
                                            <tr>
                                                <td>${i + 1}</td>
                                                <td>${f.student_name || f.first_name || '-'}</td>
                                                <td>${f.fee_type || '-'}</td>
                                                <td>₹${(f.net_amount || f.amount || 0).toLocaleString()}</td>
                                                <td>₹${(f.paid_amount || 0).toLocaleString()}</td>
                                                <td>₹${(f.balance_amount || 0).toLocaleString()}</td>
                                                <td><span class="badge bg-${f.status === 'paid' ? 'success' : f.status === 'overdue' ? 'danger' : 'warning'}">${f.status}</span></td>
                                                <td>${formatDate(f.due_date)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                } else if (reportType === 'revenue') {
                    const resp = await fetch(`${API_BASE}/fees/reports/revenue?start_date=${fromDate}&end_date=${toDate}`);
                    const data = await resp.json();

                    html = `
                        <div class="report-header text-center mb-4">
                            <h3>Revenue Report</h3>
                            <p class="text-muted">Period: ${formatDate(fromDate)} to ${formatDate(toDate)}</p>
                        </div>
                    `;

                    if (data.success && data.data) {
                        html += `
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5>Total Revenue: ₹${(data.data.total_revenue || 0).toLocaleString()}</h5>
                                            <p class="text-muted mb-0">From ${data.data.total_transactions || 0} transactions</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        html += '<div class="alert alert-info">No revenue data found for the selected period</div>';
                    }
                } else if (reportType === 'batch-collection') {
                    const resp = await fetch(`${API_BASE}/fees/reports/collection-by-batch`);
                    const data = await resp.json();

                    html = `
                        <div class="report-header text-center mb-4">
                            <h3>Batch-wise Collection Report</h3>
                            <p class="text-muted">Generated on ${new Date().toLocaleDateString('en-IN')}</p>
                        </div>
                    `;

                    if (data.success && data.data && data.data.length > 0) {
                        html += `
                            <div class="table-responsive">
                                <table class="table table-striped" id="report-table">
                                    <thead class="table-success">
                                        <tr>
                                            <th>Batch</th>
                                            <th>Total Students</th>
                                            <th>Total Fees</th>
                                            <th>Collected</th>
                                            <th>Pending</th>
                                            <th>Collection %</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.data.map(b => `
                                            <tr>
                                                <td>${b.batch_name}</td>
                                                <td>${b.student_count || 0}</td>
                                                <td>₹${(b.total_fees || 0).toLocaleString()}</td>
                                                <td>₹${(b.collected || 0).toLocaleString()}</td>
                                                <td>₹${(b.pending || 0).toLocaleString()}</td>
                                                <td>${b.collection_percentage || 0}%</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        html += '<div class="alert alert-info">No batch collection data found</div>';
                    }
                }

                resultsContent.innerHTML = html;
            } catch (err) {
                resultsContent.innerHTML = `<div class="alert alert-danger">Failed to generate report: ${err.message}</div>`;
            }
        }

        async function generateAttendanceReport() {
            const reportType = document.getElementById('attendance-report-type').value;
            const batchId = document.getElementById('attendance-report-batch').value;
            const fromDate = document.getElementById('attendance-report-from').value;
            const toDate = document.getElementById('attendance-report-to').value;
            const resultsCard = document.getElementById('report-results-card');
            const resultsContent = document.getElementById('report-results-content');

            resultsContent.innerHTML = '<div class="text-center py-4"><div class="spinner-border"></div><p class="mt-2">Generating report...</p></div>';
            resultsCard.style.display = 'block';

            try {
                let html = `
                    <div class="report-header text-center mb-4">
                        <h3>Attendance Report - ${reportType.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
                        <p class="text-muted">Period: ${formatDate(fromDate)} to ${formatDate(toDate)}</p>
                    </div>
                `;

                let url = `${API_BASE}/attendance/report?start_date=${fromDate}&end_date=${toDate}`;
                if (batchId) url += `&batch_id=${batchId}`;

                const resp = await fetch(url);
                const data = await resp.json();

                if (data.success && data.data) {
                    const report = data.data;

                    html += `
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h3>${report.total_classes || 0}</h3>
                                        <small>Total Classes</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h3>${report.average_attendance || 0}%</h3>
                                        <small>Avg Attendance</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h3>${report.total_present || 0}</h3>
                                        <small>Total Present</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h3>${report.total_absent || 0}</h3>
                                        <small>Total Absent</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    if (report.details && report.details.length > 0) {
                        html += `
                            <div class="table-responsive">
                                <table class="table table-striped" id="report-table">
                                    <thead class="table-info">
                                        <tr>
                                            <th>#</th>
                                            <th>Student</th>
                                            <th>Present</th>
                                            <th>Absent</th>
                                            <th>Late</th>
                                            <th>Attendance %</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${report.details.map((s, i) => `
                                            <tr>
                                                <td>${i + 1}</td>
                                                <td>${s.student_name}</td>
                                                <td>${s.present || 0}</td>
                                                <td>${s.absent || 0}</td>
                                                <td>${s.late || 0}</td>
                                                <td><span class="badge bg-${parseFloat(s.percentage) >= 75 ? 'success' : 'danger'}">${s.percentage || 0}%</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                } else {
                    html += '<div class="alert alert-info">No attendance data found for the selected criteria</div>';
                }

                resultsContent.innerHTML = html;
            } catch (err) {
                resultsContent.innerHTML = `<div class="alert alert-danger">Failed to generate report: ${err.message}</div>`;
            }
        }

        async function generateExamReport() {
            const reportType = document.getElementById('exam-report-type').value;
            const examId = document.getElementById('report-exam-select').value;
            const batchId = document.getElementById('exam-report-batch').value;
            const resultsCard = document.getElementById('report-results-card');
            const resultsContent = document.getElementById('report-results-content');

            resultsContent.innerHTML = '<div class="text-center py-4"><div class="spinner-border"></div><p class="mt-2">Generating report...</p></div>';
            resultsCard.style.display = 'block';

            try {
                let html = `
                    <div class="report-header text-center mb-4">
                        <h3>Exam Report - ${reportType.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
                        <p class="text-muted">Generated on ${new Date().toLocaleDateString('en-IN')}</p>
                    </div>
                `;

                if (reportType === 'results' && examId) {
                    const resp = await fetch(`${API_BASE}/exams/${examId}/results`);
                    const data = await resp.json();

                    if (data.success && data.results && data.results.length > 0) {
                        const results = data.results;
                        const avgScore = results.reduce((sum, r) => sum + parseFloat(r.percentage || 0), 0) / results.length;

                        html += `
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h4>${results.length}</h4>
                                            <small class="text-muted">Total Students</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h4>${avgScore.toFixed(1)}%</h4>
                                            <small class="text-muted">Average Score</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h4>${results.filter(r => parseFloat(r.percentage) >= 40).length}</h4>
                                            <small class="text-muted">Passed</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped" id="report-table">
                                    <thead class="table-warning">
                                        <tr>
                                            <th>Rank</th>
                                            <th>Student</th>
                                            <th>Marks</th>
                                            <th>Total</th>
                                            <th>Percentage</th>
                                            <th>Grade</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${results.sort((a, b) => parseFloat(b.percentage) - parseFloat(a.percentage)).map((r, i) => `
                                            <tr>
                                                <td>${i + 1}</td>
                                                <td>${r.student_name}</td>
                                                <td>${r.marks_obtained}</td>
                                                <td>${r.total_marks}</td>
                                                <td>${r.percentage}%</td>
                                                <td><span class="badge bg-${parseFloat(r.percentage) >= 75 ? 'success' : parseFloat(r.percentage) >= 40 ? 'warning' : 'danger'}">${getGrade(r.percentage)}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        html += '<div class="alert alert-info">No results found for this exam</div>';
                    }
                } else if (reportType === 'analytics') {
                    const resp = await fetch(`${API_BASE}/exams/analytics/overview`);
                    const data = await resp.json();

                    if (data.success) {
                        html += `
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Exam analytics shows overall performance metrics across all exams.
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <canvas id="examAnalyticsChart"></canvas>
                                </div>
                                <div class="col-md-6">
                                    <h5>Key Metrics</h5>
                                    <ul class="list-group">
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Total Exams Conducted</span>
                                            <strong>${data.total_exams || 0}</strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Average Score</span>
                                            <strong>${data.average_score || 0}%</strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Pass Rate</span>
                                            <strong>${data.pass_rate || 0}%</strong>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // Default: show all exams summary
                    const resp = await fetch(`${API_BASE}/exams`);
                    const data = await resp.json();

                    if (data.success && data.data && data.data.length > 0) {
                        html += `
                            <div class="table-responsive">
                                <table class="table table-striped" id="report-table">
                                    <thead class="table-warning">
                                        <tr>
                                            <th>#</th>
                                            <th>Exam Name</th>
                                            <th>Type</th>
                                            <th>Date</th>
                                            <th>Total Marks</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.data.map((e, i) => `
                                            <tr>
                                                <td>${i + 1}</td>
                                                <td>${e.name}</td>
                                                <td>${e.exam_type}</td>
                                                <td>${formatDate(e.exam_date)}</td>
                                                <td>${e.total_marks}</td>
                                                <td><span class="badge bg-${e.status === 'completed' ? 'success' : e.status === 'scheduled' ? 'primary' : 'secondary'}">${e.status}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        html += '<div class="alert alert-info">No exams found</div>';
                    }
                }

                resultsContent.innerHTML = html;
            } catch (err) {
                resultsContent.innerHTML = `<div class="alert alert-danger">Failed to generate report: ${err.message}</div>`;
            }
        }

        function getGrade(percentage) {
            const p = parseFloat(percentage);
            if (p >= 90) return 'A+';
            if (p >= 80) return 'A';
            if (p >= 70) return 'B+';
            if (p >= 60) return 'B';
            if (p >= 50) return 'C';
            if (p >= 40) return 'D';
            return 'F';
        }

        function printReport() {
            window.print();
        }

        function downloadReportCSV() {
            const table = document.getElementById('report-table');
            if (!table) {
                showToast('No table data to export', 'error');
                return;
            }

            let csv = [];
            const rows = table.querySelectorAll('tr');

            rows.forEach(row => {
                const cols = row.querySelectorAll('td, th');
                const rowData = [];
                cols.forEach(col => {
                    // Clean the text content
                    let text = col.textContent.trim().replace(/"/g, '""');
                    rowData.push(`"${text}"`);
                });
                csv.push(rowData.join(','));
            });

            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `report_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            showToast('Report downloaded successfully', 'success');
        }

        // ============================================
        // SETTINGS SECTION
        // ============================================

        function ensureSettingsSection() {
            if (document.getElementById('settings-section')) return;

            const section = document.createElement('div');
            section.id = 'settings-section';
            section.style.display = 'none';
            section.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-cog me-2"></i>Settings</h2>
                </div>

                <!-- Settings Tabs -->
                <ul class="nav nav-tabs mb-4" id="settingsTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#general-settings" onclick="loadGeneralSettings()">
                            <i class="fas fa-building me-1"></i> Institute Info
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#academic-settings" onclick="loadAcademicSettings()">
                            <i class="fas fa-graduation-cap me-1"></i> Academic Year
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#fee-settings" onclick="loadFeeSettings()">
                            <i class="fas fa-rupee-sign me-1"></i> Fee Configuration
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#notification-settings" onclick="loadNotificationSettings()">
                            <i class="fas fa-bell me-1"></i> Notifications
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#user-settings" onclick="loadUserSettings()">
                            <i class="fas fa-users-cog me-1"></i> Users & Roles
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#backup-settings" onclick="loadBackupSettings()">
                            <i class="fas fa-database me-1"></i> Backup & Export
                        </a>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- General Settings Tab -->
                    <div class="tab-pane fade show active" id="general-settings">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-building me-2"></i>Institute Information</h5>
                            </div>
                            <div class="card-body">
                                <form id="institute-form">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Institute Name *</label>
                                            <input type="text" class="form-control" id="institute-name" value="EduPrime Coaching Institute" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Short Name / Code</label>
                                            <input type="text" class="form-control" id="institute-code" value="EPCI">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Email *</label>
                                            <input type="email" class="form-control" id="institute-email" value="info@eduprime.com" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Phone *</label>
                                            <input type="tel" class="form-control" id="institute-phone" value="+91 98765 43210" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Address</label>
                                            <textarea class="form-control" id="institute-address" rows="2">123 Education Street, Knowledge Park, City - 400001</textarea>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">City</label>
                                            <input type="text" class="form-control" id="institute-city" value="Mumbai">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">State</label>
                                            <input type="text" class="form-control" id="institute-state" value="Maharashtra">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">PIN Code</label>
                                            <input type="text" class="form-control" id="institute-pincode" value="400001">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Website</label>
                                            <input type="url" class="form-control" id="institute-website" value="https://www.eduprime.com">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Logo URL</label>
                                            <input type="url" class="form-control" id="institute-logo" placeholder="https://...">
                                        </div>
                                    </div>
                                    <hr>
                                    <h6 class="mb-3"><i class="fas fa-share-alt me-2"></i>Social Media Links</h6>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label"><i class="fab fa-facebook text-primary me-1"></i> Facebook</label>
                                            <input type="url" class="form-control" id="social-facebook" placeholder="https://facebook.com/...">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label"><i class="fab fa-instagram text-danger me-1"></i> Instagram</label>
                                            <input type="url" class="form-control" id="social-instagram" placeholder="https://instagram.com/...">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label"><i class="fab fa-youtube text-danger me-1"></i> YouTube</label>
                                            <input type="url" class="form-control" id="social-youtube" placeholder="https://youtube.com/...">
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <button type="button" class="btn btn-primary" onclick="saveInstituteSettings()">
                                            <i class="fas fa-save me-1"></i> Save Changes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Academic Settings Tab -->
                    <div class="tab-pane fade" id="academic-settings">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Current Academic Year</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="academic-year-form">
                                            <div class="mb-3">
                                                <label class="form-label">Academic Year Name *</label>
                                                <input type="text" class="form-control" id="academic-year-name" value="2025-26" required>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Start Date *</label>
                                                    <input type="date" class="form-control" id="academic-start-date" value="2025-04-01" required>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">End Date *</label>
                                                    <input type="date" class="form-control" id="academic-end-date" value="2026-03-31" required>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="academic-active" checked>
                                                    <label class="form-check-label" for="academic-active">
                                                        Set as Active Academic Year
                                                    </label>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-primary" onclick="saveAcademicYear()">
                                                <i class="fas fa-save me-1"></i> Save
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Working Hours</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="working-hours-form">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Opening Time</label>
                                                    <input type="time" class="form-control" id="opening-time" value="08:00">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Closing Time</label>
                                                    <input type="time" class="form-control" id="closing-time" value="20:00">
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Working Days</label>
                                                <div class="d-flex flex-wrap gap-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="day-mon" checked>
                                                        <label class="form-check-label" for="day-mon">Mon</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="day-tue" checked>
                                                        <label class="form-check-label" for="day-tue">Tue</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="day-wed" checked>
                                                        <label class="form-check-label" for="day-wed">Wed</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="day-thu" checked>
                                                        <label class="form-check-label" for="day-thu">Thu</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="day-fri" checked>
                                                        <label class="form-check-label" for="day-fri">Fri</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="day-sat" checked>
                                                        <label class="form-check-label" for="day-sat">Sat</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="day-sun">
                                                        <label class="form-check-label" for="day-sun">Sun</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-primary" onclick="saveWorkingHours()">
                                                <i class="fas fa-save me-1"></i> Save
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Course Types Configuration -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-book me-2"></i>Course Types</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Course Type</th>
                                                <th>Display Name</th>
                                                <th>Duration</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><code>class_9</code></td>
                                                <td>Class 9</td>
                                                <td>1 Year</td>
                                                <td><span class="badge bg-success">Active</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>class_10</code></td>
                                                <td>Class 10</td>
                                                <td>1 Year</td>
                                                <td><span class="badge bg-success">Active</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>class_11</code></td>
                                                <td>Class 11</td>
                                                <td>1 Year</td>
                                                <td><span class="badge bg-success">Active</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>class_12</code></td>
                                                <td>Class 12</td>
                                                <td>1 Year</td>
                                                <td><span class="badge bg-success">Active</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>class_12_pass</code></td>
                                                <td>Class 12 Pass</td>
                                                <td>1 Year</td>
                                                <td><span class="badge bg-success">Active</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>iit_jee</code></td>
                                                <td>IIT-JEE</td>
                                                <td>2 Years</td>
                                                <td><span class="badge bg-success">Active</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>neet</code></td>
                                                <td>NEET</td>
                                                <td>2 Years</td>
                                                <td><span class="badge bg-success">Active</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>foundation</code></td>
                                                <td>Foundation</td>
                                                <td>1 Year</td>
                                                <td><span class="badge bg-success">Active</span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Fee Settings Tab -->
                    <div class="tab-pane fade" id="fee-settings">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-rupee-sign me-2"></i>Default Fee Structure</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="fee-structure-form">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Course Type</th>
                                                            <th>Annual Fee (₹)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>Class 9</td>
                                                            <td><input type="number" class="form-control form-control-sm" value="45000"></td>
                                                        </tr>
                                                        <tr>
                                                            <td>Class 10</td>
                                                            <td><input type="number" class="form-control form-control-sm" value="50000"></td>
                                                        </tr>
                                                        <tr>
                                                            <td>Class 11</td>
                                                            <td><input type="number" class="form-control form-control-sm" value="60000"></td>
                                                        </tr>
                                                        <tr>
                                                            <td>Class 12</td>
                                                            <td><input type="number" class="form-control form-control-sm" value="65000"></td>
                                                        </tr>
                                                        <tr>
                                                            <td>IIT-JEE</td>
                                                            <td><input type="number" class="form-control form-control-sm" value="150000"></td>
                                                        </tr>
                                                        <tr>
                                                            <td>NEET</td>
                                                            <td><input type="number" class="form-control form-control-sm" value="140000"></td>
                                                        </tr>
                                                        <tr>
                                                            <td>Foundation</td>
                                                            <td><input type="number" class="form-control form-control-sm" value="35000"></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <button type="button" class="btn btn-primary" onclick="saveFeeStructure()">
                                                <i class="fas fa-save me-1"></i> Save Fee Structure
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-percent me-2"></i>Fee Settings</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="fee-config-form">
                                            <div class="mb-3">
                                                <label class="form-label">Late Fee Penalty (%)</label>
                                                <input type="number" class="form-control" id="late-fee-percent" value="5" min="0" max="100">
                                                <small class="text-muted">Applied after due date</small>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Grace Period (Days)</label>
                                                <input type="number" class="form-control" id="grace-period" value="7" min="0">
                                                <small class="text-muted">Days after due date before penalty</small>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Default Due Day of Month</label>
                                                <input type="number" class="form-control" id="due-day" value="10" min="1" max="28">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Payment Modes</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="pay-cash" checked>
                                                    <label class="form-check-label" for="pay-cash">Cash</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="pay-upi" checked>
                                                    <label class="form-check-label" for="pay-upi">UPI</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="pay-bank" checked>
                                                    <label class="form-check-label" for="pay-bank">Bank Transfer</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="pay-card" checked>
                                                    <label class="form-check-label" for="pay-card">Card</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="pay-cheque" checked>
                                                    <label class="form-check-label" for="pay-cheque">Cheque</label>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-primary" onclick="saveFeeConfig()">
                                                <i class="fas fa-save me-1"></i> Save Settings
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notification Settings Tab -->
                    <div class="tab-pane fade" id="notification-settings">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-envelope me-2"></i>Email Notifications</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="email-notifications-form">
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="email-fee-reminder" checked>
                                                <label class="form-check-label" for="email-fee-reminder">Fee Payment Reminders</label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="email-attendance" checked>
                                                <label class="form-check-label" for="email-attendance">Attendance Alerts (Low Attendance)</label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="email-exam-results" checked>
                                                <label class="form-check-label" for="email-exam-results">Exam Results</label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="email-announcements" checked>
                                                <label class="form-check-label" for="email-announcements">General Announcements</label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="email-inquiry-followup" checked>
                                                <label class="form-check-label" for="email-inquiry-followup">Inquiry Follow-ups</label>
                                            </div>
                                            <hr>
                                            <div class="mb-3">
                                                <label class="form-label">SMTP Server</label>
                                                <input type="text" class="form-control" id="smtp-server" value="smtp.gmail.com">
                                            </div>
                                            <div class="row">
                                                <div class="col-md-8 mb-3">
                                                    <label class="form-label">SMTP Email</label>
                                                    <input type="email" class="form-control" id="smtp-email" value="noreply@eduprime.com">
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label">SMTP Port</label>
                                                    <input type="number" class="form-control" id="smtp-port" value="587">
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-primary" onclick="saveEmailSettings()">
                                                <i class="fas fa-save me-1"></i> Save Email Settings
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-sms me-2"></i>SMS Notifications</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="sms-notifications-form">
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="sms-fee-reminder" checked>
                                                <label class="form-check-label" for="sms-fee-reminder">Fee Payment Reminders</label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="sms-attendance">
                                                <label class="form-check-label" for="sms-attendance">Daily Attendance SMS to Parents</label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="sms-exam-results" checked>
                                                <label class="form-check-label" for="sms-exam-results">Exam Results</label>
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="sms-emergency" checked>
                                                <label class="form-check-label" for="sms-emergency">Emergency Alerts</label>
                                            </div>
                                            <hr>
                                            <div class="mb-3">
                                                <label class="form-label">SMS Gateway Provider</label>
                                                <select class="form-select" id="sms-provider">
                                                    <option value="twilio">Twilio</option>
                                                    <option value="msg91" selected>MSG91</option>
                                                    <option value="textlocal">TextLocal</option>
                                                    <option value="custom">Custom API</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">API Key</label>
                                                <input type="password" class="form-control" id="sms-api-key" placeholder="Enter API Key">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Sender ID</label>
                                                <input type="text" class="form-control" id="sms-sender-id" value="EDUPRI">
                                            </div>
                                            <button type="button" class="btn btn-primary" onclick="saveSMSSettings()">
                                                <i class="fas fa-save me-1"></i> Save SMS Settings
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- WhatsApp Integration -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fab fa-whatsapp me-2 text-success"></i>WhatsApp Integration</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="whatsapp-enabled">
                                            <label class="form-check-label" for="whatsapp-enabled">Enable WhatsApp Notifications</label>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">WhatsApp Business API</label>
                                            <select class="form-select" id="whatsapp-provider">
                                                <option value="twilio">Twilio WhatsApp</option>
                                                <option value="360dialog">360Dialog</option>
                                                <option value="wati" selected>WATI</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">API Endpoint</label>
                                            <input type="url" class="form-control" id="whatsapp-endpoint" placeholder="https://api.provider.com/...">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">API Token</label>
                                            <input type="password" class="form-control" id="whatsapp-token" placeholder="Enter API Token">
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-success" onclick="saveWhatsAppSettings()">
                                    <i class="fas fa-save me-1"></i> Save WhatsApp Settings
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- User Settings Tab -->
                    <div class="tab-pane fade" id="user-settings">
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-users me-2"></i>User Accounts</h5>
                                <button class="btn btn-primary btn-sm" onclick="showAddUserModal()">
                                    <i class="fas fa-plus me-1"></i> Add User
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="users-table">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Role</th>
                                                <th>Status</th>
                                                <th>Last Login</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="avatar-sm bg-primary text-white rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                            <i class="fas fa-user-shield"></i>
                                                        </div>
                                                        Admin User
                                                    </div>
                                                </td>
                                                <td>admin@eduprime.com</td>
                                                <td><span class="badge bg-danger">Super Admin</span></td>
                                                <td><span class="badge bg-success">Active</span></td>
                                                <td>Today, 10:30 AM</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="avatar-sm bg-info text-white rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                            <i class="fas fa-user-tie"></i>
                                                        </div>
                                                        Staff Member
                                                    </div>
                                                </td>
                                                <td>staff@eduprime.com</td>
                                                <td><span class="badge bg-info">Staff</span></td>
                                                <td><span class="badge bg-success">Active</span></td>
                                                <td>Yesterday, 5:45 PM</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary me-1" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" title="Deactivate">
                                                        <i class="fas fa-ban"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="avatar-sm bg-success text-white rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                            <i class="fas fa-chalkboard-teacher"></i>
                                                        </div>
                                                        Faculty Account
                                                    </div>
                                                </td>
                                                <td>faculty@eduprime.com</td>
                                                <td><span class="badge bg-success">Faculty</span></td>
                                                <td><span class="badge bg-success">Active</span></td>
                                                <td>Today, 9:15 AM</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary me-1" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" title="Deactivate">
                                                        <i class="fas fa-ban"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Roles & Permissions -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Roles & Permissions</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Permission</th>
                                                <th class="text-center">Super Admin</th>
                                                <th class="text-center">Admin</th>
                                                <th class="text-center">Staff</th>
                                                <th class="text-center">Faculty</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Manage Students</td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                                <td class="text-center"><i class="fas fa-eye text-info"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Manage Fees</td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                                <td class="text-center"><i class="fas fa-times text-danger"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Mark Attendance</td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Manage Exams</td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                                <td class="text-center"><i class="fas fa-eye text-info"></i></td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                            </tr>
                                            <tr>
                                                <td>View Reports</td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                                <td class="text-center"><i class="fas fa-eye text-info"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Manage Settings</td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                                <td class="text-center"><i class="fas fa-times text-danger"></i></td>
                                                <td class="text-center"><i class="fas fa-times text-danger"></i></td>
                                            </tr>
                                            <tr>
                                                <td>Manage Users</td>
                                                <td class="text-center"><i class="fas fa-check text-success"></i></td>
                                                <td class="text-center"><i class="fas fa-eye text-info"></i></td>
                                                <td class="text-center"><i class="fas fa-times text-danger"></i></td>
                                                <td class="text-center"><i class="fas fa-times text-danger"></i></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-check text-success"></i> Full Access &nbsp;|&nbsp;
                                    <i class="fas fa-eye text-info"></i> View Only &nbsp;|&nbsp;
                                    <i class="fas fa-times text-danger"></i> No Access
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Backup Settings Tab -->
                    <div class="tab-pane fade" id="backup-settings">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-download me-2"></i>Manual Backup</h5>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted mb-3">Download a complete backup of your data</p>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary" onclick="downloadBackup('full')">
                                                <i class="fas fa-database me-2"></i> Full Database Backup
                                            </button>
                                            <button class="btn btn-outline-success" onclick="downloadBackup('students')">
                                                <i class="fas fa-user-graduate me-2"></i> Students Data (Excel)
                                            </button>
                                            <button class="btn btn-outline-info" onclick="downloadBackup('fees')">
                                                <i class="fas fa-rupee-sign me-2"></i> Fee Records (Excel)
                                            </button>
                                            <button class="btn btn-outline-warning" onclick="downloadBackup('attendance')">
                                                <i class="fas fa-calendar-check me-2"></i> Attendance Records (Excel)
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Restore Data</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>Warning:</strong> Restoring data will overwrite existing records. This action cannot be undone.
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Select Backup File</label>
                                            <input type="file" class="form-control" id="restore-file" accept=".json,.sql,.xlsx">
                                        </div>
                                        <button class="btn btn-danger" onclick="restoreBackup()" disabled>
                                            <i class="fas fa-undo me-1"></i> Restore Backup
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Automatic Backups</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="auto-backup-form">
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="auto-backup-enabled" checked>
                                                <label class="form-check-label" for="auto-backup-enabled">Enable Automatic Backups</label>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Backup Frequency</label>
                                                <select class="form-select" id="backup-frequency">
                                                    <option value="daily" selected>Daily</option>
                                                    <option value="weekly">Weekly</option>
                                                    <option value="monthly">Monthly</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Backup Time</label>
                                                <input type="time" class="form-control" id="backup-time" value="02:00">
                                                <small class="text-muted">Recommended: Late night hours</small>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Retention Period</label>
                                                <select class="form-select" id="backup-retention">
                                                    <option value="7">7 days</option>
                                                    <option value="14">14 days</option>
                                                    <option value="30" selected>30 days</option>
                                                    <option value="90">90 days</option>
                                                </select>
                                            </div>
                                            <button type="button" class="btn btn-primary" onclick="saveBackupSettings()">
                                                <i class="fas fa-save me-1"></i> Save Settings
                                            </button>
                                        </form>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Backups</h5>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-file-archive text-primary me-2"></i>
                                                    <span>backup_2026-01-04_02-00.sql</span>
                                                    <br><small class="text-muted">156 MB • Today 2:00 AM</small>
                                                </div>
                                                <button class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-file-archive text-primary me-2"></i>
                                                    <span>backup_2026-01-03_02-00.sql</span>
                                                    <br><small class="text-muted">154 MB • Yesterday 2:00 AM</small>
                                                </div>
                                                <button class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-file-archive text-primary me-2"></i>
                                                    <span>backup_2026-01-02_02-00.sql</span>
                                                    <br><small class="text-muted">152 MB • 2 days ago</small>
                                                </div>
                                                <button class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.querySelector('.main-content').appendChild(section);
        }

        function showSettingsSection() {
            hideAllSections();
            ensureSettingsSection();
            document.getElementById('settings-section').style.display = 'block';
            loadGeneralSettings();
        }

        function loadGeneralSettings() {
            // Load institute settings from localStorage or API
            const settings = JSON.parse(localStorage.getItem('instituteSettings') || '{}');
            if (settings.name) document.getElementById('institute-name').value = settings.name;
            if (settings.email) document.getElementById('institute-email').value = settings.email;
            if (settings.phone) document.getElementById('institute-phone').value = settings.phone;
        }

        function loadAcademicSettings() {
            console.log('Loading academic settings...');
        }

        function loadFeeSettings() {
            console.log('Loading fee settings...');
        }

        function loadNotificationSettings() {
            console.log('Loading notification settings...');
        }

        function loadUserSettings() {
            console.log('Loading user settings...');
        }

        function loadBackupSettings() {
            console.log('Loading backup settings...');
        }

        function saveInstituteSettings() {
            const settings = {
                name: document.getElementById('institute-name').value,
                code: document.getElementById('institute-code').value,
                email: document.getElementById('institute-email').value,
                phone: document.getElementById('institute-phone').value,
                address: document.getElementById('institute-address').value,
                city: document.getElementById('institute-city').value,
                state: document.getElementById('institute-state').value,
                pincode: document.getElementById('institute-pincode').value,
                website: document.getElementById('institute-website').value,
                logo: document.getElementById('institute-logo').value,
                social: {
                    facebook: document.getElementById('social-facebook').value,
                    instagram: document.getElementById('social-instagram').value,
                    youtube: document.getElementById('social-youtube').value
                }
            };
            localStorage.setItem('instituteSettings', JSON.stringify(settings));
            showToast('Institute settings saved successfully!', 'success');
        }

        function saveAcademicYear() {
            const academicYear = {
                name: document.getElementById('academic-year-name').value,
                startDate: document.getElementById('academic-start-date').value,
                endDate: document.getElementById('academic-end-date').value,
                isActive: document.getElementById('academic-active').checked
            };
            localStorage.setItem('academicYear', JSON.stringify(academicYear));
            showToast('Academic year settings saved!', 'success');
        }

        function saveWorkingHours() {
            const workingHours = {
                opening: document.getElementById('opening-time').value,
                closing: document.getElementById('closing-time').value,
                days: {
                    mon: document.getElementById('day-mon').checked,
                    tue: document.getElementById('day-tue').checked,
                    wed: document.getElementById('day-wed').checked,
                    thu: document.getElementById('day-thu').checked,
                    fri: document.getElementById('day-fri').checked,
                    sat: document.getElementById('day-sat').checked,
                    sun: document.getElementById('day-sun').checked
                }
            };
            localStorage.setItem('workingHours', JSON.stringify(workingHours));
            showToast('Working hours saved!', 'success');
        }

        function saveFeeStructure() {
            showToast('Fee structure saved!', 'success');
        }

        function saveFeeConfig() {
            const feeConfig = {
                lateFeePercent: document.getElementById('late-fee-percent').value,
                gracePeriod: document.getElementById('grace-period').value,
                dueDay: document.getElementById('due-day').value,
                paymentModes: {
                    cash: document.getElementById('pay-cash').checked,
                    upi: document.getElementById('pay-upi').checked,
                    bank: document.getElementById('pay-bank').checked,
                    card: document.getElementById('pay-card').checked,
                    cheque: document.getElementById('pay-cheque').checked
                }
            };
            localStorage.setItem('feeConfig', JSON.stringify(feeConfig));
            showToast('Fee configuration saved!', 'success');
        }

        function saveEmailSettings() {
            showToast('Email settings saved!', 'success');
        }

        function saveSMSSettings() {
            showToast('SMS settings saved!', 'success');
        }

        function saveWhatsAppSettings() {
            showToast('WhatsApp settings saved!', 'success');
        }

        function showAddUserModal() {
            showToast('Add User functionality - Coming soon!', 'info');
        }

        function downloadBackup(type) {
            showToast(`Preparing ${type} backup for download...`, 'info');
            setTimeout(() => {
                showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} backup downloaded!`, 'success');
            }, 2000);
        }

        function restoreBackup() {
            showToast('Restore functionality requires admin approval', 'warning');
        }

        function saveBackupSettings() {
            const backupSettings = {
                enabled: document.getElementById('auto-backup-enabled').checked,
                frequency: document.getElementById('backup-frequency').value,
                time: document.getElementById('backup-time').value,
                retention: document.getElementById('backup-retention').value
            };
            localStorage.setItem('backupSettings', JSON.stringify(backupSettings));
            showToast('Backup settings saved!', 'success');
        }
    </script>
</body>
</html>